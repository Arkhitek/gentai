<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ¨é€ é™ç•Œè€åŠ›è¨ˆç®—ãƒ—ãƒ­ã‚°ãƒ©ãƒ </title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            messageStyle: "none",
            showProcessingMessages: false
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" />
    
    <style>
        :root { --primary: #005a9c; --secondary: #004080; --bg: #f4f5f7; --border: #ccc; }
        body { font-family: 'Meiryo', sans-serif; margin: 0; padding: 20px; background: var(--bg); color: #333; font-size: 13px; }
        .container { max-width: 1850px; margin: auto; background: #fff; padding: 20px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { border-bottom: 2px solid var(--primary); padding-bottom: 5px; color: var(--primary); font-size: 1.4em; margin-top: 0; }
        h2 { background: #eef4f9; padding: 6px 10px; border-left: 5px solid var(--primary); font-size: 1.1em; margin-top: 20px; }
        
        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 15px; }
        .tab-link { padding: 8px 25px; cursor: pointer; border: 1px solid #ddd; border-bottom: none; background: #f8f8f8; margin-right: 4px; font-weight: bold; color: #666; transition: 0.2s; }
        .tab-link:hover { background: #eee; }
        .tab-link.active { background: #fff; border-bottom: 2px solid #fff; color: var(--primary); border-top: 3px solid var(--primary); }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 10px; }
        .input-group { background: #fff; padding: 8px; border: 1px solid var(--border); border-radius: 3px; }
        .input-group label { display: block; font-weight: bold; margin-bottom: 4px; font-size: 0.9em; color: #555; }
        .input-group input, .input-group select { width: 95%; padding: 4px; border: 1px solid #999; text-align: right; }
        .input-group select { text-align: left; }

        .force-editor { display: flex; gap: 10px; flex-wrap: wrap; }
        .force-column { flex: 1; min-width: 300px; border: 1px solid var(--border); padding: 10px; border-radius: 3px; background: #fafafa; }
        .force-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-weight: bold; color: var(--secondary); }
        
        /* Wall Selection Styles */
        .wall-selector { margin-bottom: 10px; padding: 5px; background: #e8f0fe; border: 1px solid #b3d7ff; border-radius: 3px; }
        .wall-selector-row { display: flex; gap: 5px; margin-bottom: 5px; align-items: center; }
        .wall-selector select { flex: 1; padding: 4px; font-size: 0.9em; }
        .wall-selector input { width: 50px; text-align: right; padding: 4px; }
        .btn-add-wall { background: var(--primary); color: white; border: none; cursor: pointer; padding: 2px 8px; border-radius: 3px; }
        .wall-list { max-height: 100px; overflow-y: auto; background: #fff; border: 1px solid #ccc; margin-bottom: 5px; font-size: 0.85em; }
        .wall-item { display: flex; justify-content: space-between; padding: 3px 5px; border-bottom: 1px solid #eee; align-items: center; }
        .wall-item:last-child { border-bottom: none; }
        .wall-item span { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        /* Free Input List Styles */
        .free-input-list { max-height: 120px; overflow-y: auto; background: #fff; border: 1px solid #ccc; margin-bottom: 5px; font-size: 0.85em; }
        .free-input-list:empty { display: none; }

        .data-table { width: 100%; border-collapse: collapse; margin-bottom: 5px; font-size: 0.9em; background: #fff; }
        .data-table th { background: #e0e0e0; border: 1px solid #999; padding: 4px; text-align: center; }
        .data-table td { border: 1px solid #999; padding: 2px; text-align: center; }
        .data-table input { width: 90%; border: none; text-align: right; font-family: inherit; }
        
        .btn-sm { padding: 1px 6px; cursor: pointer; font-size: 0.85em; background: #ddd; border: 1px solid #999; border-radius: 2px; }
        .btn-calc { display: block; width: 200px; margin: 20px auto; padding: 12px; font-size: 1.2em; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: 0.2s; }
        .btn-calc:hover { background: var(--secondary); transform: translateY(-1px); }
        .btn-sheet { background: #fff; border: 1px solid var(--primary); color: var(--primary); cursor: pointer; padding: 2px 8px; font-size: 0.85em; border-radius: 3px; }

        .log-section { margin-top: 20px; border-top: 2px solid #ccc; padding-top: 10px; }
        .log-wrapper { overflow: auto; border: 1px solid #999; max-height: 500px; background: #fff; position: relative; margin-bottom: 20px; }
        .log-table { border-collapse: separate; border-spacing: 0; font-family: 'Consolas', 'Monaco', monospace; font-size: 11px; white-space: nowrap; width: 100%; }
        .log-table thead { position: sticky; top: 0; z-index: 10; }
        .log-table th { background: #f0f0f0; border: 1px solid #ccc; padding: 4px 6px; text-align: center; }
        .log-table td { border: 1px solid #ccc; padding: 2px 6px; text-align: right; }
        .log-table tr:nth-child(even) { background: #f9f9f9; }

        .formula-box { background: #f8f9fa; border: 1px solid #ddd; padding: 20px; margin-top: 20px; border-radius: 5px; }
        .formula-grid { display:grid; grid-template-columns: 1fr 1fr; gap:30px; }
        .formula-item { margin-bottom: 20px; border-bottom: 1px dotted #ccc; padding-bottom: 10px; }
        .formula-desc { color: #555; font-size: 0.9em; margin-top: 5px; line-height: 1.5; }
        .formula-eq { font-family: "Times New Roman", serif; font-size: 1.15em; background: #fff; padding: 4px 8px; display: inline-block; border-radius: 3px; border:1px solid #eee; margin-top:5px; }

        .result-box { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px; }
        .result-panel { flex: 1; min-width: 450px; padding: 10px; border: 1px solid #ddd; border-top: 3px solid var(--primary); background: #fff; }
        .chart-wrapper { height: 400px; position: relative; width: 100%; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: #fff; padding: 15px; width: 800px; height: 80%; display: flex; flex-direction: column; border-radius: 5px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .progress-modal { background: #fff; padding: 30px; width: 400px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.4); text-align: center; }
        .progress-bar { width: 100%; height: 30px; background: #e0e0e0; border-radius: 15px; overflow: hidden; margin: 20px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #005a9c, #0080d0); transition: width 0.3s; border-radius: 15px; }
        #spreadsheet-container { flex: 1; overflow: hidden; margin-bottom: 10px; border: 1px solid #ccc; }

        .badge { padding: 3px 8px; border-radius: 3px; font-weight: bold; font-size: 0.9em; color: white; }
        .badge-ok { background: #28a745; }
        .badge-warn { background: #ffc107; color:#333; }
        .badge-ng { background: #dc3545; }
        .rating-box { margin-top:5px; font-weight:bold; padding:5px; border:1px solid #ccc; background:#fafafa; text-align:center; }

        .story-2-only { transition: all 0.3s; }
        
        /* Input Graph Styles */
        .input-chart-wrapper { height: 180px; width: 100%; background: white; border: 1px solid #eee; margin-bottom: 5px; }

        /* SVG Diagram Styles */
        .diagram-container { text-align: center; margin: 15px 0; border: 1px solid #eee; padding: 10px; background: white; }
        .diagram-svg { max-width: 100%; height: auto; }
        .diagram-label { font-size: 10px; fill: #333; font-family: sans-serif; }

        #report-view { display: none; width: 210mm; }
        .report-page { width: 210mm; min-height: 297mm; max-height: 297mm; box-sizing: border-box; padding: 15mm 20mm 20mm 20mm; background: white; overflow: hidden; margin: 0 auto; position: relative; }
        .page-number { position: absolute; top: 10mm; right: 20mm; font-size: 9pt; color: #666; }
        
        @media print {
            body { background: white; padding: 0; font-size: 9pt; margin:0; }
            .no-print { display: none !important; }
            #report-view { display: block !important; }
            .container { box-shadow: none; padding: 0; max-width: 100%; width: 100%; margin: 0; }
            
            .report-page { width: 210mm; min-height: 297mm; max-height: 297mm; box-sizing: border-box; padding: 15mm 20mm; position: relative; page-break-after: always; background: white; overflow: hidden; }
            .report-page:last-child { page-break-after: auto; }

            .report-header { display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 2px solid #000; margin-bottom: 10px; padding-bottom: 5px; }
            .report-header h1 { margin: 0; font-size: 14pt; color: #000; border: none; display: none; }
            .report-header .report-title-box { flex: 1; }
            .report-header .report-prop-name { font-size: 12pt; font-weight: bold; text-align: right; }
            
            .report-section { margin-bottom: 12px; break-inside: avoid; page-break-inside: avoid; }
            .report-section h3 { font-size: 11pt; border-left: 4px solid #000; padding-left: 8px; background: #eee; margin: 8px 0 5px 0; break-after: avoid; page-break-after: avoid; }
            
            .report-table { width: 100%; border-collapse: collapse; font-size: 9pt; margin-bottom: 8px; break-inside: avoid; page-break-inside: avoid; }
            .report-table th { background: #ddd !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; color: #000; border: 1px solid #000; padding: 4px; font-size: 9pt; }
            .report-table td { border: 1px solid #000; padding: 3px 5px; text-align: center; font-size: 9pt; }

            /* Chart Images in Print */
            .report-chart-img { width: 100%; max-height: 180mm; height: auto; border: 1px solid #ccc; object-fit: contain; margin: 5px 0; }
            
            /* Log Table in Print - 2åˆ†å‰²å¯¾å¿œ */
            .log-print-wrapper { font-size: 6pt; }
            .log-print-wrapper table { border-collapse: collapse; width: 100%; table-layout: fixed; }
            .log-print-wrapper th, .log-print-wrapper td { border: 1px solid #666; padding: 1px 2px; text-align: center; font-size: 6pt; word-wrap: break-word; }
            .log-print-wrapper th { background: #e8e8e8 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; font-weight: bold; }
            .log-print-wrapper .log-header-group th { background: #d0d0d0 !important; }
            
            /* Logic Section in Print */
            .logic-print { font-size: 9pt; line-height: 1.4; }
            .logic-print h4 { margin: 5px 0; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="no-print">
        <h1>æœ¨é€ é™ç•Œè€åŠ›è¨ˆç®—ãƒ—ãƒ­ã‚°ãƒ©ãƒ </h1>
        <div class="tabs">
            <div class="tab-link active" onclick="switchTab('input')">1. ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</div>
            <div class="tab-link" onclick="switchTab('force-x')">2. å¾©å…ƒåŠ›Xæ–¹å‘</div>
            <div class="tab-link" onclick="switchTab('force-y')">3. å¾©å…ƒåŠ›Yæ–¹å‘</div>
            <div class="tab-link" onclick="switchTab('result')">4. è¨ˆç®—çµæœãƒ»ãƒ­ã‚°</div>
            <div class="tab-link" onclick="switchTab('detail')">5. äº¤ç‚¹è©³ç´°</div>
            <div class="tab-link" id="tab-link-shear" onclick="switchTab('shear')" style="display:none;">6. å±¤ã›ã‚“æ–­åŠ›ã®æ¯”è¼ƒ</div>
        </div>
    </div>

    <div id="tab-input" class="tab-content active no-print">
        <div style="display:flex; justify-content:flex-end; gap:10px; margin-bottom:15px; padding:10px; background:#f0f4f8; border-radius:5px; border:1px solid #cce;">
            <span style="flex:1; font-weight:bold; color:#005a9c; align-self:center;">ğŸ“ ãƒ‡ãƒ¼ã‚¿å…¥å‡ºåŠ›</span>
            <button onclick="saveToCSV()" style="padding:8px 20px; background:#28a745; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">ğŸ“¥ CSVä¿å­˜</button>
            <input type="file" id="csvFileInput" accept=".csv" style="display:none;" onchange="loadFromCSV(event)">
            <button onclick="document.getElementById('csvFileInput').click()" style="padding:8px 20px; background:#007bff; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">ğŸ“¤ CSVèª­è¾¼</button>
        </div>
        <h2>1. å»ºç‰©ãƒ»åœ°ç›¤è«¸å…ƒ</h2>
        <div class="input-grid">
            <div class="input-group">
                <label>ç‰©ä»¶å</label>
                <input type="text" id="inp_BuildingName" placeholder="ä¾‹: ã€‡ã€‡é‚¸ æ–°ç¯‰å·¥äº‹" oninput="syncProjectName('main')">
            </div>
            <div class="input-group">
                <label>éšæ•° (Stories)</label>
                <select id="inp_Stories" onchange="toggleStories()">
                    <option value="1">1éšå»ºã¦ (å¹³å±‹)</option>
                    <option value="2" selected>2éšå»ºã¦</option>
                </select>
            </div>
            <div class="input-group">
                <label>åœ°åŸŸä¿‚æ•° Z</label>
                <input type="number" id="inp_Z" value="1.0" step="0.01">
            </div>
        </div>
        
        <h3>1-2. å¿œç­”ã‚¹ãƒšã‚¯ãƒˆãƒ« (Sa)</h3>
        <div style="display:flex; gap:20px; align-items:flex-start; flex-wrap:wrap;">
            <div style="min-width:280px;">
                <div class="input-group" style="margin-bottom:10px;">
                    <label>å¿œç­”ã‚¹ãƒšã‚¯ãƒˆãƒ«è¨­å®š</label>
                    <select id="inp_Sa_mode" onchange="toggleSaInput()">
                        <option value="standard" selected>å‘Šç¤ºæº–æ‹  (Sa0)</option>
                        <option value="custom">è‡ªç”±å…¥åŠ› (Saã‚¹ãƒšã‚¯ãƒˆãƒ«)</option>
                    </select>
                </div>
                <div id="sa-standard-desc" style="font-size:0.85em; color:#666; padding:8px; background:#f9f9f9; border-radius:3px; line-height:1.5;">
                    <div><strong>åŠ é€Ÿåº¦å¿œç­”ã‚¹ãƒšã‚¯ãƒˆãƒ« Sa0(T)</strong></div>
                    <div style="margin-top:5px;">â— æå‚·é™ç•Œ: ç¨€ã«ç™ºç”Ÿã™ã‚‹åœ°éœ‡å‹•</div>
                    <div>â— å®‰å…¨é™ç•Œ: æ¥µã‚ã¦ç¨€ã«ç™ºç”Ÿã™ã‚‹åœ°éœ‡å‹•</div>
                    <div style="margin-top:5px; font-size:0.9em; color:#888;">â€»å®‰å…¨é™ç•Œã¯æå‚·é™ç•Œã®5å€</div>
                </div>
                <div id="inp_Sa_custom_input" style="display:none; background:#eee; padding:10px; border-radius:5px;">
    <div style="font-size:0.85em; font-weight:bold; margin-bottom:8px;">è‡ªç”±å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ (T-Sa)</div>
    <div style="font-size:0.8em; color:#666; margin-bottom:8px;">â€»æå‚·é™ç•Œç”¨ãƒ»å®‰å…¨é™ç•Œç”¨ã‚’ãã‚Œãã‚Œå…¥åŠ›ã§ãã¾ã™ã€‚ç‰‡æ–¹ã®ã¿ã®å…¥åŠ›ã‚‚å¯ã€‚</div>
    
    <div style="background:#e8f5e9; padding:8px; border-radius:3px; margin-bottom:8px;">
        <div style="font-size:0.85em; font-weight:bold; color:#2e7d32; margin-bottom:5px;">â–¼ æå‚·é™ç•Œç”¨ Sa(d)</div>
        <div style="display:flex; gap:5px; margin-bottom:5px; flex-wrap:wrap;">
            <button class="btn-sheet" onclick="openSaSpreadsheet('d')" style="font-size:0.8em;">Excelè²¼ä»˜ (T-Sa)</button>
            <button class="btn-sheet" onclick="openWaveModal('d')" style="font-size:0.8em; background:#fff; color:#2e7d32; border-color:#2e7d32;">åœ°éœ‡æ³¢ã‹ã‚‰è¨ˆç®—</button>
            <button class="btn-sm" onclick="clearSaData('d')" style="color:red; font-size:0.75em;">ã‚¯ãƒªã‚¢</button>
        </div>
        <div id="sa-data-list-d" style="font-size:0.75em; max-height:80px; overflow-y:auto; border:1px solid #ccc; background:#fff; padding:3px;"></div>
    </div>
    
    <div style="background:#ffebee; padding:8px; border-radius:3px; margin-bottom:8px;">
        <div style="font-size:0.85em; font-weight:bold; color:#c62828; margin-bottom:5px;">â–¼ å®‰å…¨é™ç•Œç”¨ Sa(s)</div>
        <div style="display:flex; gap:5px; margin-bottom:5px; flex-wrap:wrap;">
            <button class="btn-sheet" onclick="openSaSpreadsheet('s')" style="font-size:0.8em;">Excelè²¼ä»˜ (T-Sa)</button>
            <button class="btn-sheet" onclick="openWaveModal('s')" style="font-size:0.8em; background:#fff; color:#c62828; border-color:#c62828;">åœ°éœ‡æ³¢ã‹ã‚‰è¨ˆç®—</button>
            <button class="btn-sm" onclick="clearSaData('s')" style="color:red; font-size:0.75em;">ã‚¯ãƒªã‚¢</button>
        </div>
        <div id="sa-data-list-s" style="font-size:0.75em; max-height:80px; overflow-y:auto; border:1px solid #ccc; background:#fff; padding:3px;"></div>
    </div>
    
    <div style="padding:6px; background:#fff3cd; border:1px solid #ffc107; border-radius:3px; font-size:0.75em;">
        <div style="font-weight:bold; color:#856404;">æ¸›è¡°ä½æ¸›ä¿‚æ•°Fhï¼ˆè‡ªç”±å…¥åŠ›æ™‚ï¼‰:</div>
        <div>Î”W/(4Ï€WA) &lt; 0.05 â†’ h = 0.05</div>
        <div>Î”W/(4Ï€WA) â‰§ 0.05 â†’ h = Î”W/(4Ï€WA)</div>
        <div>Fh = 1.5/(1+10h)</div>
        <div style="color:#666;">â€»ç‰‡æ–¹ã®ã¿å…¥åŠ›ã®å ´åˆã€æœªå…¥åŠ›å´ã¯å‘Šç¤ºå€¤ã‚’ä½¿ç”¨</div>
    </div>
</div>
            </div>
            <div style="flex:1; min-width:400px; max-width:700px;">
                <div style="font-size:0.85em; font-weight:bold; margin-bottom:5px;">Saã‚¹ãƒšã‚¯ãƒˆãƒ«ã‚°ãƒ©ãƒ•</div>
                <div style="height:200px; border:1px solid #ccc; background:#fff; padding:5px;">
                    <canvas id="chart-sa0"></canvas>
                </div>
            </div>
        </div>
        
        <h3>1-3. åœ°ç›¤ç¨®åˆ¥ (Gsã‚¹ãƒšã‚¯ãƒˆãƒ«è¨­å®š)</h3>
        <div style="display:flex; gap:20px; align-items:flex-start; flex-wrap:wrap;">
            <div style="min-width:200px;">
                <div class="input-group" style="margin-bottom:10px;">
                    <label>åœ°ç›¤ç¨®åˆ¥</label>
                    <select id="inp_Tc_mode" onchange="toggleTcInput()">
                        <option value="1">ç¬¬1ç¨® (å²©ç›¤ãƒ»ç¡¬è³ªç ‚ç¤«ç­‰)</option>
                        <option value="2" selected>ç¬¬2ç¨® (é€šå¸¸ã®åœ°ç›¤)</option>
                        <option value="3">ç¬¬3ç¨® (è»Ÿå¼±åœ°ç›¤)</option>
                        <option value="custom">Gsã‚¹ãƒšã‚¯ãƒˆãƒ«è‡ªç”±å…¥åŠ›</option>
                    </select>
                </div>
                <div id="inp_Tc_custom_input" style="display:none; background:#eee; padding:10px; border-radius:5px;">
                    <div style="font-size:0.85em; font-weight:bold; margin-bottom:5px;">è‡ªç”±å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ (T-Gs)</div>
                    <div style="display:flex; gap:5px; margin-bottom:5px;">
                        <button class="btn-sheet" onclick="openGsSpreadsheet()">Excelè²¼ä»˜</button>
                        <button class="btn-sm" onclick="clearGsData()" style="color:red;">ã‚¯ãƒªã‚¢</button>
                    </div>
                    <div id="gs-data-list" style="font-size:0.8em; max-height:150px; overflow-y:auto; border:1px solid #ccc; background:#fff; padding:5px;"></div>
                </div>
            </div>
            <div style="flex:1; min-width:350px; max-width:600px;">
                <div style="font-size:0.85em; font-weight:bold; margin-bottom:5px;">Gsã‚¹ãƒšã‚¯ãƒˆãƒ«ã‚°ãƒ©ãƒ•</div>
                <div style="height:200px; border:1px solid #ccc; background:#fff; padding:5px;">
                    <canvas id="chart-gs"></canvas>
                </div>
            </div>
        </div>
        
        <h3>1-4. p, q èª¿æ•´ä¿‚æ•°</h3>
        <div style="display:flex; gap:20px; align-items:flex-start; flex-wrap:wrap;">
            <div style="min-width:200px;">
                <div class="input-group" style="margin-bottom:10px;">
                    <label>p, q ã®è€ƒæ…®</label>
                    <select id="inp_pq" onchange="togglePqInput()">
                        <option value="yes" selected>è€ƒæ…®ã™ã‚‹ (å‘Šç¤ºæº–æ‹ )</option>
                        <option value="no">è€ƒæ…®ã—ãªã„ (p=1.0, q=1.0)</option>
                    </select>
                </div>
                <div id="pq-desc" style="font-size:0.8em; color:#666; padding:5px; background:#f9f9f9; border-radius:3px;">
                    <div><strong>pä¿‚æ•°</strong>: ç­‰ä¾¡å‘¨æœŸTeã«ã‚ˆã‚‹èª¿æ•´ï¼ˆåœ°éœ‡å¿œç­”ã®ä½ç›¸å·®è€ƒæ…®ï¼‰</div>
                    <div style="margin-top:3px;"><strong>qä¿‚æ•°</strong>: ç­‰ä¾¡è³ªé‡æ¯”ã«ã‚ˆã‚‹èª¿æ•´ï¼ˆé«˜æ¬¡ãƒ¢ãƒ¼ãƒ‰å½±éŸ¿è€ƒæ…®ï¼‰</div>
                </div>
            </div>
            <div id="pq-chart-area" style="flex:1; min-width:350px; max-width:600px;">
                <div style="font-size:0.85em; font-weight:bold; margin-bottom:5px;">pä¿‚æ•°ã‚°ãƒ©ãƒ• (Te-p)</div>
                <div style="height:180px; border:1px solid #ccc; background:#fff; padding:5px;">
                    <canvas id="chart-p"></canvas>
                </div>
            </div>
        </div>
        
        <h3>1-5. åœ°éœ‡å±¤ã›ã‚“æ–­åŠ›ã¨ã®æ¯”è¼ƒè¨­å®š</h3>
        <div style="background:#f0f8ff; border:1px solid #b0c4de; padding:15px; border-radius:5px;">
            <div class="input-group" style="margin-bottom:10px; text-align: left; border:none; background:transparent; padding:0;">
                <label style="cursor:pointer; font-weight:bold; color:#005a9c; font-size:1.1em; display:flex; align-items:center; justify-content:flex-start; gap:8px;">
                    <input type="checkbox" id="chk_calc_shear_force" onchange="toggleShearInput()" style="width:auto; transform:scale(1.2); margin:0;"> 
                    åœ°éœ‡å±¤ã›ã‚“æ–­åŠ›(1æ¬¡è¨­è¨ˆãƒ»2æ¬¡è¨­è¨ˆ)ã¨æ¯”è¼ƒã‚’è¡Œã†
                </label>
            </div>
            
            <div id="shear-input-area" style="display:none; margin-top:10px;">
                <p style="font-size:0.9em; color:#666; margin-bottom:10px; line-height:1.5;">
                    â€»å»ºç¯‰åŸºæº–æ³•ã«åŸºã¥ãåœ°éœ‡å±¤ã›ã‚“æ–­åŠ›ä¿‚æ•°<br>
                    æå‚·é™ç•Œ(1æ¬¡): <span style="font-family:'Times New Roman', serif; font-style:italic; font-weight:bold; background:#fff; padding:2px 5px; border-radius:3px; border:1px solid #ddd;">
                        C<sub>i</sub> = Z Â· R<sub>t</sub> Â· A<sub>i</sub> Â· C<sub>0</sub>
                    </span><br>
                    å®‰å…¨é™ç•Œ(2æ¬¡): <span style="font-family:'Times New Roman', serif; font-style:italic; font-weight:bold; background:#fff; padding:2px 5px; border-radius:3px; border:1px solid #ddd;">
                        C<sub>i</sub> = D<sub>s</sub> Â· F<sub>es</sub> Â· Z Â· R<sub>t</sub> Â· A<sub>i</sub> Â· C<sub>0</sub>
                    </span><br>
                    ã‚’è¨ˆç®—ã—ã€é™ç•Œè€åŠ›ã¨æ¯”è¼ƒã—ã¾ã™ã€‚
                </p>
                
                <div class="input-grid">
                    <div class="input-group">
                        <label>æ¨™æº–ã›ã‚“æ–­åŠ›ä¿‚æ•° C0<br><span style="font-size:0.85em; font-weight:normal;">(1æ¬¡è¨­è¨ˆç›¸å½“ãƒ»æå‚·é™ç•Œ)</span></label>
                        <input type="number" id="inp_C0_D" value="0.2" step="0.05">
                    </div>
                    <div class="input-group">
                        <label>æ¨™æº–ã›ã‚“æ–­åŠ›ä¿‚æ•° C0<br><span style="font-size:0.85em; font-weight:normal;">(2æ¬¡è¨­è¨ˆç›¸å½“ãƒ»å®‰å…¨é™ç•Œ)</span></label>
                        <input type="number" id="inp_C0_S" value="1.0" step="0.1">
                    </div>
                    <div class="input-group">
                        <label>æ§‹é€ ç‰¹æ€§ä¿‚æ•° Ds<br><span style="font-size:0.85em; font-weight:normal;">(2æ¬¡è¨­è¨ˆç›¸å½“ãƒ»å®‰å…¨é™ç•Œ)</span></label>
                        <input type="number" id="inp_Ds" value="0.4" step="0.05">
                    </div>
                    <div class="input-group">
                        <label>å½¢çŠ¶ä¿‚æ•° Fes<br><span style="font-size:0.85em; font-weight:normal;">(2æ¬¡è¨­è¨ˆç›¸å½“ãƒ»å®‰å…¨é™ç•Œ)</span></label>
                        <input type="number" id="inp_Fes" value="1.0" step="0.1">
                    </div>
                    <div class="input-group">
                        <label>æœ¨é€ å›ºæœ‰å‘¨æœŸä¿‚æ•° (T=kH)</label>
                        <input type="number" id="inp_T_factor" value="0.03" step="0.01">
                    </div>
                </div>
            </div>
        </div>
        
        <h3>2. éšãƒ‡ãƒ¼ã‚¿ (ä¸‹éšã‹ã‚‰å…¥åŠ›)</h3>
        <p style="font-size:0.9em; color:#666;">â€»é‡é‡Wã¯ã€å½“è©²éšã®åœ°éœ‡åŠ›ã‚’è² æ‹…ã™ã‚‹é‡é‡ï¼ˆç©è¼‰è·é‡å«ã‚€ã€å¤šé›ªåŒºåŸŸç­‰ã¯é©åˆ‡ã«å‰²å¢—ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
        
        <h4 style="margin: 10px 0 5px 0; color: #333;">é‡é‡</h4>
        <div class="input-grid">
            <div class="input-group"><label>1F é‡é‡ W1 (kN)</label><input type="number" id="inp_W1" value="100"></div>
            <div class="input-group story-2-only"><label>2F é‡é‡ W2 (kN)</label><input type="number" id="inp_W2" value="80"></div>
        </div>
        
        <h4 style="margin: 15px 0 5px 0; color: #333;">éšé«˜</h4>
        <div class="input-grid">
            <div class="input-group"><label>1F éšé«˜ H1 (m)</label><input type="number" id="inp_H1" value="2.98" step="0.01"></div>
            <div class="input-group story-2-only"><label>2F éšé«˜ H2 (m)</label><input type="number" id="inp_H2" value="2.85" step="0.01"></div>
        </div>

        <h3>3. åˆ¤å®šåŸºæº– (å±¤é–“å¤‰å½¢è§’)</h3>
        <div class="input-grid">
            <div class="input-group">
                <label>æå‚·é™ç•Œ 1/N</label>
                <input type="number" id="inp_limit_d" value="120" step="1">
            </div>
            <div class="input-group">
                <label>å®‰å…¨é™ç•Œ 1/N</label>
                <input type="number" id="inp_limit_s" value="15" step="1">
            </div>
        </div>
    </div>

    <!-- å¾©å…ƒåŠ›ç‰¹æ€§ Xæ–¹å‘ã‚¿ãƒ– -->
    <div id="tab-force-x" class="tab-content no-print">
        <h2>å¾©å…ƒåŠ›ç‰¹æ€§ Xæ–¹å‘ (Q - Î´)</h2>
        <p style="font-size:0.9em; color:#666;">â€»<strong>ã€Œè‡ªç”±å…¥åŠ› (ä¸‹è¡¨)ã€</strong>ãŠã‚ˆã³è¿½åŠ ã—ãŸ<strong>ã€Œè€åŠ›å£ã€ã€Œç­‹äº¤ã„/ãƒ–ãƒ¬ãƒ¼ã‚¹ã€</strong>ã®åˆè¨ˆè€åŠ›ãŒã‚°ãƒ©ãƒ•ã«è¡¨ç¤ºã•ã‚Œã€è¨ˆç®—ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚</p>
        <div class="force-editor">
            <div class="force-column" id="col-x1">
                <div class="force-header"><span>Xæ–¹å‘ 1éš</span></div>
                <div class="wall-selector">
                    <div class="wall-selector-row">
                        <select id="sel-wall-x1"></select>
                        <input type="number" id="qty-wall-x1" value="1" step="0.1" placeholder="æ•°é‡" title="é…ç½®æ•°é‡(Ã—0.91m)">
                        <span style="font-size:0.75em; color:#666; white-space:nowrap;">(Ã—0.91m)</span>
                        <button class="btn-add-wall" onclick="addWall('x1')">è¿½åŠ </button>
                    </div>
                    <div class="wall-list" id="list-wall-x1"></div>
                </div>
                <div class="wall-selector" style="background:#fef9e7; border-color:#f9e79f;">
                    <div style="font-size:0.8em; font-weight:bold; color:#856404; margin-bottom:5px;">ç­‹äº¤ã„/ãƒ–ãƒ¬ãƒ¼ã‚¹ï¼ˆè§’åº¦è£œæ­£ã‚ã‚Šï¼‰</div>
                    <div class="wall-selector-row">
                        <select id="sel-brace-x1"></select>
                        <input type="number" id="width-brace-x1" value="0.91" step="0.01" placeholder="å£å¹…(m)" title="å£å¹…(m)" style="width:60px;">
                        <span style="font-size:0.75em; color:#666; white-space:nowrap;">m</span>
                        <input type="number" id="qty-brace-x1" value="1" step="1" placeholder="ç®‡æ‰€æ•°" title="ç®‡æ‰€æ•°" style="width:50px;">
                        <span style="font-size:0.75em; color:#666; white-space:nowrap;">ç®‡æ‰€</span>
                        <button class="btn-add-wall" onclick="addBrace('x1')">è¿½åŠ </button>
                    </div>
                    <div class="wall-list" id="list-brace-x1"></div>
                    <div style="font-size:0.7em; color:#856404; margin-top:3px; line-height:1.3;">
                        â€»è€åŠ›å€¤ã¯ãƒ–ãƒ¬ãƒ¼ã‚¹è§’åº¦Î¸ã«ã‚ˆã‚‹cosÎ¸ã§è‡ªå‹•è£œæ­£ã•ã‚Œã¾ã™
                    </div>
                </div>
                <div class="input-chart-wrapper"><canvas id="chart-in-x1"></canvas></div>
                <div style="font-size:0.85em; font-weight:bold; margin-top:10px; color:#555;">â–¼ è‡ªç”±å…¥åŠ›</div>
                <div class="free-input-list" id="free-list-x1"></div>
                <div style="display:flex; gap:5px; margin:5px 0; align-items:center; flex-wrap:wrap;">
                    <input type="text" id="free-name-x1" placeholder="é …ç›®å" style="flex:2; min-width:80px; padding:3px;">
                    <input type="number" id="free-qty-x1" value="1" step="0.1" style="width:50px; padding:3px; text-align:right;" title="æ•°é‡">
                    <span style="font-size:0.75em; color:#666;">æ•°é‡</span>
                    <button class="btn-sheet" onclick="openSpreadsheet('x1')">Excelè²¼ä»˜</button>
                    <button class="btn-sm" onclick="addFreeInputItem('x1')">+ é …ç›®è¿½åŠ </button>
                </div>
                <table class="data-table" id="table-x1" style="display:none;">
                    <thead><tr><th width="30%">1/N</th><th width="35%">å¤‰ä½(mm)</th><th width="25%">Q(kN)</th><th width="10%"></th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="force-column story-2-only" id="col-x2">
                <div class="force-header"><span>Xæ–¹å‘ 2éš</span></div>
                <div class="wall-selector">
                    <div class="wall-selector-row">
                        <select id="sel-wall-x2"></select>
                        <input type="number" id="qty-wall-x2" value="1" step="0.1" placeholder="æ•°é‡" title="é…ç½®æ•°é‡(Ã—0.91m)">
                        <span style="font-size:0.75em; color:#666; white-space:nowrap;">(Ã—0.91m)</span>
                        <button class="btn-add-wall" onclick="addWall('x2')">è¿½åŠ </button>
                    </div>
                    <div class="wall-list" id="list-wall-x2"></div>
                </div>
                <div class="wall-selector" style="background:#fef9e7; border-color:#f9e79f;">
                    <div style="font-size:0.8em; font-weight:bold; color:#856404; margin-bottom:5px;">ç­‹äº¤ã„/ãƒ–ãƒ¬ãƒ¼ã‚¹ï¼ˆè§’åº¦è£œæ­£ã‚ã‚Šï¼‰</div>
                    <div class="wall-selector-row">
                        <select id="sel-brace-x2"></select>
                        <input type="number" id="width-brace-x2" value="0.91" step="0.01" placeholder="å£å¹…(m)" title="å£å¹…(m)" style="width:60px;">
                        <span style="font-size:0.75em; color:#666; white-space:nowrap;">m</span>
                        <input type="number" id="qty-brace-x2" value="1" step="1" placeholder="ç®‡æ‰€æ•°" title="ç®‡æ‰€æ•°" style="width:50px;">
                        <span style="font-size:0.75em; color:#666; white-space:nowrap;">ç®‡æ‰€</span>
                        <button class="btn-add-wall" onclick="addBrace('x2')">è¿½åŠ </button>
                    </div>
                    <div class="wall-list" id="list-brace-x2"></div>
                    <div style="font-size:0.7em; color:#856404; margin-top:3px; line-height:1.3;">
                        â€»è€åŠ›å€¤ã¯ãƒ–ãƒ¬ãƒ¼ã‚¹è§’åº¦Î¸ã«ã‚ˆã‚‹cosÎ¸ã§è‡ªå‹•è£œæ­£ã•ã‚Œã¾ã™
                    </div>
                </div>
                <div class="input-chart-wrapper"><canvas id="chart-in-x2"></canvas></div>
                <div style="font-size:0.85em; font-weight:bold; margin-top:10px; color:#555;">â–¼ è‡ªç”±å…¥åŠ›</div>
                <div class="free-input-list" id="free-list-x2"></div>
                <div style="display:flex; gap:5px; margin:5px 0; align-items:center; flex-wrap:wrap;">
                    <input type="text" id="free-name-x2" placeholder="é …ç›®å" style="flex:2; min-width:80px; padding:3px;">
                    <input type="number" id="free-qty-x2" value="1" step="0.1" style="width:50px; padding:3px; text-align:right;" title="æ•°é‡">
                    <span style="font-size:0.75em; color:#666;">æ•°é‡</span>
                    <button class="btn-sheet" onclick="openSpreadsheet('x2')">Excelè²¼ä»˜</button>
                    <button class="btn-sm" onclick="addFreeInputItem('x2')">+ é …ç›®è¿½åŠ </button>
                </div>
                <table class="data-table" id="table-x2" style="display:none;">
                    <thead><tr><th>1/N</th><th>å¤‰ä½(mm)</th><th>Q(kN)</th><th></th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- å¾©å…ƒåŠ›ç‰¹æ€§ Yæ–¹å‘ã‚¿ãƒ– -->
    <div id="tab-force-y" class="tab-content no-print">
        <h2>å¾©å…ƒåŠ›ç‰¹æ€§ Yæ–¹å‘ (Q - Î´)</h2>
        <div style="background:#fff3cd; border:1px solid #ffc107; padding:10px; margin-bottom:15px; border-radius:5px;">
            <label style="cursor:pointer; font-weight:bold; color:#856404;">
                <input type="checkbox" id="chk-skip-y" onchange="toggleSkipY()"> Yæ–¹å‘ã®å…¥åŠ›ã‚’è¡Œã‚ãªã„ï¼ˆXæ–¹å‘ã®ã¿è¨ˆç®—ï¼‰
            </label>
        </div>
        <div id="force-y-input-area">
        <p style="font-size:0.9em; color:#666;">â€»<strong>ã€Œè‡ªç”±å…¥åŠ› (ä¸‹è¡¨)ã€</strong>ãŠã‚ˆã³è¿½åŠ ã—ãŸ<strong>ã€Œè€åŠ›å£ã€ã€Œç­‹äº¤ã„/ãƒ–ãƒ¬ãƒ¼ã‚¹ã€</strong>ã®åˆè¨ˆè€åŠ›ãŒã‚°ãƒ©ãƒ•ã«è¡¨ç¤ºã•ã‚Œã€è¨ˆç®—ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚</p>
        <div class="force-editor">
            <div class="force-column" id="col-y1">
                <div class="force-header"><span>Yæ–¹å‘ 1éš</span></div>
                <div class="wall-selector">
                    <div class="wall-selector-row">
                        <select id="sel-wall-y1"></select>
                        <input type="number" id="qty-wall-y1" value="1" step="0.1" placeholder="æ•°é‡" title="é…ç½®æ•°é‡(Ã—0.91m)">
                        <span style="font-size:0.75em; color:#666; white-space:nowrap;">(Ã—0.91m)</span>
                        <button class="btn-add-wall" onclick="addWall('y1')">è¿½åŠ </button>
                    </div>
                    <div class="wall-list" id="list-wall-y1"></div>
                </div>
                <div class="wall-selector" style="background:#fef9e7; border-color:#f9e79f;">
                    <div style="font-size:0.8em; font-weight:bold; color:#856404; margin-bottom:5px;">ç­‹äº¤ã„/ãƒ–ãƒ¬ãƒ¼ã‚¹ï¼ˆè§’åº¦è£œæ­£ã‚ã‚Šï¼‰</div>
                    <div class="wall-selector-row">
                        <select id="sel-brace-y1"></select>
                        <input type="number" id="width-brace-y1" value="0.91" step="0.01" placeholder="å£å¹…(m)" title="å£å¹…(m)" style="width:60px;">
                        <span style="font-size:0.75em; color:#666; white-space:nowrap;">m</span>
                        <input type="number" id="qty-brace-y1" value="1" step="1" placeholder="ç®‡æ‰€æ•°" title="ç®‡æ‰€æ•°" style="width:50px;">
                        <span style="font-size:0.75em; color:#666; white-space:nowrap;">ç®‡æ‰€</span>
                        <button class="btn-add-wall" onclick="addBrace('y1')">è¿½åŠ </button>
                    </div>
                    <div class="wall-list" id="list-brace-y1"></div>
                    <div style="font-size:0.7em; color:#856404; margin-top:3px; line-height:1.3;">
                        â€»è€åŠ›å€¤ã¯ãƒ–ãƒ¬ãƒ¼ã‚¹è§’åº¦Î¸ã«ã‚ˆã‚‹cosÎ¸ã§è‡ªå‹•è£œæ­£ã•ã‚Œã¾ã™
                    </div>
                </div>
                <div class="input-chart-wrapper"><canvas id="chart-in-y1"></canvas></div>
                <div style="font-size:0.85em; font-weight:bold; margin-top:10px; color:#555;">â–¼ è‡ªç”±å…¥åŠ›</div>
                <div class="free-input-list" id="free-list-y1"></div>
                <div style="display:flex; gap:5px; margin:5px 0; align-items:center; flex-wrap:wrap;">
                    <input type="text" id="free-name-y1" placeholder="é …ç›®å" style="flex:2; min-width:80px; padding:3px;">
                    <input type="number" id="free-qty-y1" value="1" step="0.1" style="width:50px; padding:3px; text-align:right;" title="æ•°é‡">
                    <span style="font-size:0.75em; color:#666;">æ•°é‡</span>
                    <button class="btn-sheet" onclick="openSpreadsheet('y1')">Excelè²¼ä»˜</button>
                    <button class="btn-sm" onclick="addFreeInputItem('y1')">+ é …ç›®è¿½åŠ </button>
                </div>
                <table class="data-table" id="table-y1" style="display:none;">
                    <thead><tr><th>1/N</th><th>å¤‰ä½(mm)</th><th>Q(kN)</th><th></th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="force-column story-2-only" id="col-y2">
                <div class="force-header"><span>Yæ–¹å‘ 2éš</span></div>
                <div class="wall-selector">
                    <div class="wall-selector-row">
                        <select id="sel-wall-y2"></select>
                        <input type="number" id="qty-wall-y2" value="1" step="0.1" placeholder="æ•°é‡" title="é…ç½®æ•°é‡(Ã—0.91m)">
                        <span style="font-size:0.75em; color:#666; white-space:nowrap;">(Ã—0.91m)</span>
                        <button class="btn-add-wall" onclick="addWall('y2')">è¿½åŠ </button>
                    </div>
                    <div class="wall-list" id="list-wall-y2"></div>
                </div>
                <div class="wall-selector" style="background:#fef9e7; border-color:#f9e79f;">
                    <div style="font-size:0.8em; font-weight:bold; color:#856404; margin-bottom:5px;">ç­‹äº¤ã„/ãƒ–ãƒ¬ãƒ¼ã‚¹ï¼ˆè§’åº¦è£œæ­£ã‚ã‚Šï¼‰</div>
                    <div class="wall-selector-row">
                        <select id="sel-brace-y2"></select>
                        <input type="number" id="width-brace-y2" value="0.91" step="0.01" placeholder="å£å¹…(m)" title="å£å¹…(m)" style="width:60px;">
                        <span style="font-size:0.75em; color:#666; white-space:nowrap;">m</span>
                        <input type="number" id="qty-brace-y2" value="1" step="1" placeholder="ç®‡æ‰€æ•°" title="ç®‡æ‰€æ•°" style="width:50px;">
                        <span style="font-size:0.75em; color:#666; white-space:nowrap;">ç®‡æ‰€</span>
                        <button class="btn-add-wall" onclick="addBrace('y2')">è¿½åŠ </button>
                    </div>
                    <div class="wall-list" id="list-brace-y2"></div>
                    <div style="font-size:0.7em; color:#856404; margin-top:3px; line-height:1.3;">
                        â€»è€åŠ›å€¤ã¯ãƒ–ãƒ¬ãƒ¼ã‚¹è§’åº¦Î¸ã«ã‚ˆã‚‹cosÎ¸ã§è‡ªå‹•è£œæ­£ã•ã‚Œã¾ã™
                    </div>
                </div>
                <div class="input-chart-wrapper"><canvas id="chart-in-y2"></canvas></div>
                <div style="font-size:0.85em; font-weight:bold; margin-top:10px; color:#555;">â–¼ è‡ªç”±å…¥åŠ›</div>
                <div class="free-input-list" id="free-list-y2"></div>
                <div style="display:flex; gap:5px; margin:5px 0; align-items:center; flex-wrap:wrap;">
                    <input type="text" id="free-name-y2" placeholder="é …ç›®å" style="flex:2; min-width:80px; padding:3px;">
                    <input type="number" id="free-qty-y2" value="1" step="0.1" style="width:50px; padding:3px; text-align:right;" title="æ•°é‡">
                    <span style="font-size:0.75em; color:#666;">æ•°é‡</span>
                    <button class="btn-sheet" onclick="openSpreadsheet('y2')">Excelè²¼ä»˜</button>
                    <button class="btn-sm" onclick="addFreeInputItem('y2')">+ é …ç›®è¿½åŠ </button>
                </div>
                <table class="data-table" id="table-y2" style="display:none;">
                    <thead><tr><th>1/N</th><th>å¤‰ä½(mm)</th><th>Q(kN)</th><th></th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        </div>
    </div>

    <div id="tab-result" class="tab-content no-print">
        <div style="text-align:center; margin:20px;">
            <button class="btn-calc" onclick="executeCalculation()">è¨ˆç®—å®Ÿè¡Œ</button>
        </div>
        
        <div id="result-summary" style="display:none;">
            <div class="result-box">
                <div class="result-panel">
                    <h3>Xæ–¹å‘: Q - å¤‰å½¢è§’é–¢ä¿‚</h3>
                    <div id="summary-x-table" style="margin-bottom:10px;"></div>
                    <div class="chart-wrapper"><canvas id="chart-x"></canvas></div>
                </div>
                <div class="result-panel" id="result-panel-y">
                    <h3>Yæ–¹å‘: Q - å¤‰å½¢è§’é–¢ä¿‚</h3>
                    <div id="summary-y-table" style="margin-bottom:10px;"></div>
                    <div class="chart-wrapper"><canvas id="chart-y"></canvas></div>
                </div>
            </div>

            <div class="print-options-section" style="background:#f8f8f8; border:1px solid #ddd; padding:15px; margin-bottom:15px; border-radius:5px;">
                <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                    <div style="display:flex; flex-direction:column; gap:10px; width:100%;">
                        <div style="display:flex; align-items:center; gap:15px; flex-wrap:wrap;">
                            <strong style="color:#333;">è¨ˆç®—æ›¸å‡ºåŠ›é …ç›®:</strong>
                            <label style="cursor:pointer; font-weight:bold; color:#005a9c;">
                                <input type="checkbox" id="chk-rep-cover" onchange="toggleCoverInput()"> è¡¨ç´™ãƒ»ç›®æ¬¡
                            </label>
                            <label style="cursor:pointer;"><input type="checkbox" id="chk-rep-overview" checked> å»ºç‰©æ¦‚è¦</label>
                            <label style="cursor:pointer;"><input type="checkbox" id="chk-rep-force" checked> å¾©å…ƒåŠ›ç‰¹æ€§</label>
                            <label style="cursor:pointer;"><input type="checkbox" id="chk-rep-result" checked> åˆ¤å®šçµæœ</label>
                            <label style="cursor:pointer;"><input type="checkbox" id="chk-rep-logic" checked> è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯</label>
                            <label style="cursor:pointer;"><input type="checkbox" id="chk-rep-log" checked> è©³ç´°è¨ˆç®—ãƒ­ã‚°</label>
                            <label style="cursor:pointer;"><input type="checkbox" id="chk-rep-detail" checked> äº¤ç‚¹è©³ç´°è¨ˆç®—</label>
                            <span id="span-rep-shear" style="display:none;">
                                <label style="cursor:pointer; margin-left:10px;">
                                    <input type="checkbox" id="chk-rep-shear" checked> å±¤ã›ã‚“æ–­åŠ›æ¯”è¼ƒ
                                </label>
                            </span>
                        </div>
                        
                        <div id="cover-input-area" style="display:none; background:#fff; padding:10px; border:1px solid #ccc; border-radius:4px;">
                            <div style="font-size:0.9em; font-weight:bold; margin-bottom:5px; border-bottom:1px solid #eee;">è¡¨ç´™è¨˜è¼‰äº‹é …</div>
                            <div class="input-grid">
                                <div class="input-group">
                                    <label>æ—¥ä»˜</label>
                                    <input type="text" id="inp_cover_date">
                                </div>
                                <div class="input-group">
                                    <label>ç‰©ä»¶å</label>
                                    <input type="text" id="inp_cover_project_name" oninput="syncProjectName('cover')">
                                </div>
                                <div class="input-group">
                                    <label>ä¼šç¤¾å</label>
                                    <input type="text" id="inp_cover_company">
                                </div>
                                <div class="input-group">
                                    <label>äº‹å‹™æ‰€ç™»éŒ²ç•ªå·</label>
                                    <input type="text" id="inp_cover_office_reg">
                                </div>
                                <div class="input-group">
                                    <label>å»ºç¯‰å£«ç™»éŒ²ç•ªå·</label>
                                    <input type="text" id="inp_cover_arch_reg">
                                </div>
                                <div class="input-group">
                                    <label>ç®¡ç†å»ºç¯‰å£«æ°å</label>
                                    <input type="text" id="inp_cover_manager_name">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn-calc" style="background:#555; width:auto; padding:10px 30px; margin:0;" onclick="generatePDF()">è¨ˆç®—æ›¸PDFå‡ºåŠ›</button>
                </div>
            </div>
            
            <!-- é€²æ—è¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ« -->
            <div id="progressModal" class="modal-overlay" style="display:none;">
                <div class="progress-modal">
                    <h3 style="margin:0 0 15px 0; color:#005a9c;">PDFç”Ÿæˆä¸­...</h3>
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill" style="width:0%"></div>
                    </div>
                    <div id="progressText" style="color:#666; font-size:0.9em;">æº–å‚™ä¸­...</div>
                </div>
            </div>
            
            <div class="log-section">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                    <h3 style="margin:0;">è©³ç´°è¨ˆç®—ãƒ­ã‚°</h3>
                    <div>
                        <button class="btn-sm" onclick="showLog('x')" style="padding:5px 15px; font-weight:bold;">Xæ–¹å‘ãƒ­ã‚°</button>
                        <button class="btn-sm" id="btn-log-y" onclick="showLog('y')" style="padding:5px 15px; font-weight:bold;">Yæ–¹å‘ãƒ­ã‚°</button>
                    </div>
                </div>
                <div class="log-wrapper">
                    <div id="log-container-x" style="display:block;"></div>
                    <div id="log-container-y" style="display:none;"></div>
                </div>
            </div>

            <div class="formula-box">
                <h3>è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ãƒ»è©³ç´°é …ç›®ã®è§£èª¬</h3>
                <p style="font-size:0.9em; color:#666;">â€»æœ¬ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ã€Œé™ç•Œè€åŠ›è¨ˆç®—ï¼ˆä»¤ç¬¬82æ¡ã®6ã€å¹³12å»ºå‘Š1457å·ï¼‰ã€ã«åŸºã¥ãã€æœ¨é€ å»ºç‰©ã®å€’å£Šãƒ»æå‚·æ¤œè¨¼ã‚’è¡Œã„ã¾ã™ã€‚</p>
                <div style="background:#fff; border:1px solid #ddd; padding:15px; margin-bottom:15px; border-radius:5px;">
                    <h4 style="margin-top:0; color:#005a9c; border-bottom:1px solid #ccc; padding-bottom:5px;">1. æŒ¯å‹•ãƒ¢ãƒ‡ãƒ«ã®ä½œæˆã¨å›ºæœ‰å€¤è§£æ</h4>
                    <div class="formula-grid">
                        <div class="formula-item">
                            <strong>\( m_i \) (å„éšè³ªé‡)</strong><br>
                            <span class="formula-eq">\( m_i = \frac{W_i}{g} \)</span><br>
                            <div class="formula-desc">å„éšé‡é‡ \( W_i \) (kN) ã‚’é‡åŠ›åŠ é€Ÿåº¦ \( g \approx 9.807 \, \text{m/s}^2 \) ã§é™¤ã—ã¦è³ªé‡åŒ–ã—ã¾ã™ã€‚</div>
                        </div>
                        <div class="formula-item">
                            <strong>\( K_{i0} \) (åˆæœŸå‰›æ€§)</strong><br>
                            <span class="formula-desc">å¾©å…ƒåŠ›ç‰¹æ€§ã®åŸç‚¹ä»˜è¿‘ï¼ˆå¼¾æ€§åŸŸï¼‰ã®å‹¾é…ã€‚</span><br>
                            <div class="formula-desc">å»ºç‰©ã®æœ¬æ¥ã®ç¡¬ã•ã‚’è¡¨ã—ã¾ã™ã€‚åˆæœŸå‰›æ€§ãŒé«˜ã„ã»ã© \( T_0 \) ãŒçŸ­ããªã‚Šã€æ¸›è¡°åŠ¹æœãŒé«˜ã¾ã‚Šã¾ã™ã€‚</div>
                        </div>
                        <div class="formula-item">
                            <strong>\( T_0 \) (ç¬¬1æ¬¡å›ºæœ‰å‘¨æœŸ)</strong><br>
                            <span class="formula-eq">\( |K_0 - \omega^2 M| = 0 \Rightarrow T_0 = \frac{2\pi}{\omega} \)</span><br>
                            <div class="formula-desc">åˆæœŸå‰›æ€§ã¨è³ªé‡ã‚’ç”¨ã„ãŸå›ºæœ‰å€¤è§£æã«ã‚ˆã‚Šç®—å‡ºã—ã¾ã™ã€‚ã“ã® \( T_0 \) ã¯æ¸›è¡°å®šæ•° \( h \) ã®ç®—å®šåŸºæº–ã¨ãªã‚Šã¾ã™ã€‚<br>1éšå»ºã¦ã®å ´åˆ: \( T_0 = 2\pi \sqrt{m_1/K_1} \)</div>
                        </div>
                        <div class="formula-item">
                            <strong>\( u_i \) (æŒ¯å‹•ãƒ¢ãƒ¼ãƒ‰)</strong><br>
                            <span class="formula-eq">\( \frac{u_2}{u_1} = \frac{K_1 + K_2 - m_1 \omega^2}{K_2} \)</span><br>
                            <div class="formula-desc">å„ã‚¹ãƒ†ãƒƒãƒ—ã®å‰›æ€§ \( K \) ã«å¿œã˜ã¦ã€å»ºç‰©ãŒã©ã®ã‚ˆã†ãªå½¢çŠ¶ã§æºã‚Œã‚‹ã‹ï¼ˆãƒ¢ãƒ¼ãƒ‰ï¼‰ã‚’ç®—å‡ºã—ã¾ã™ã€‚ï¼ˆ1éšå»ºã¦ã®å ´åˆã¯çœç•¥ï¼‰</div>
                        </div>
                    </div>
                </div>

                <div style="background:#fff; border:1px solid #ddd; padding:15px; margin-bottom:15px; border-radius:5px;">
                    <h4 style="margin-top:0; color:#005a9c; border-bottom:1px solid #ccc; padding-bottom:5px;">2. ç­‰ä¾¡1è‡ªç”±åº¦ç³»ã¸ã®ç½®æ› (å¤šè³ªç‚¹ &to; 1è³ªç‚¹)</h4>
                    <div class="formula-grid">
                        <div class="formula-item">
                            <strong>\( M_e \) (æœ‰åŠ¹è³ªé‡)</strong><br>
                            <span class="formula-eq">\( M_e = \frac{(\sum m_i u_i)^2}{\sum m_i u_i^2} \)</span><br>
                            <div class="formula-desc">å»ºç‰©å…¨ä½“ã®æºã‚Œã«é–¢ä¸ã™ã‚‹è³ªé‡æˆåˆ†ã€‚PDFè³‡æ–™ã§ã¯ \( M_{us} \) ã¨è¡¨è¨˜ã€‚</div>
                        </div>
                        <div class="formula-item">
                            <strong>\( \Delta \) (ç­‰ä¾¡å¤‰ä½)</strong><br>
                            <span class="formula-eq">\( \Delta = \frac{\sum m_i u_i^2}{\sum m_i u_i} \)</span><br>
                            <div class="formula-desc">ç­‰ä¾¡1è‡ªç”±åº¦ç³»ã®ä»£è¡¨å¤‰ä½é‡ã€‚PDFè³‡æ–™ã§ã¯ \( \delta_s \) ã¨è¡¨è¨˜ã€‚</div>
                        </div>
                        <div class="formula-item">
                            <strong>\( H_e \) (ç­‰ä¾¡é«˜ã•)</strong><br>
                            <span class="formula-eq">\( H_e = \frac{\sum m_i u_i h_i}{\sum m_i u_i} \)</span><br>
                            <div class="formula-desc">ç­‰ä¾¡1è‡ªç”±åº¦ç³»ã®é‡å¿ƒé«˜ã•ã€‚ã‚°ãƒ©ãƒ•ã®Xè»¸ï¼ˆå¤‰å½¢è§’ç›¸å½“ \( \Delta/H_e \)ï¼‰ç­‰ã«ä½¿ç”¨ã—ã¾ã™ã€‚</div>
                        </div>
                        <div class="formula-item">
                            <strong>\( T_e \) (ç­‰ä¾¡å‘¨æœŸ)</strong><br>
                            <span class="formula-eq">\( T_e = 2\pi \sqrt{\frac{M_e}{K_e}} = 2\pi \sqrt{\frac{M_e \cdot \Delta}{Q_a}} \)</span><br>
                            <div class="formula-desc">æå‚·ãŒé€²ã¿å‰›æ€§ãŒä½ä¸‹ã™ã‚‹ã¨ã€å‘¨æœŸã¯ \( T_0 \) ã‹ã‚‰ \( T_e \) ã¸ã¨é•·ããªã‚Šã¾ã™ã€‚å®‰å…¨é™ç•Œæ™‚ã¯ \( T_s \) ã¨è¡¨è¨˜ã€‚</div>
                        </div>
                    </div>
                </div>

                <div style="background:#fff; border:1px solid #ddd; padding:15px; margin-bottom:15px; border-radius:5px;">
                    <h4 style="margin-top:0; color:#005a9c; border-bottom:1px solid #ccc; padding-bottom:5px;">3. æ¸›è¡°æ€§èƒ½ã¨è¦æ±‚ã‚¹ãƒšã‚¯ãƒˆãƒ«</h4>
                    <div class="formula-grid">
                        <div class="formula-item">
                            <strong>\( W_A \) (ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã‚¨ãƒãƒ«ã‚®ãƒ¼)</strong><br>
                            <span class="formula-eq">\( W_A = \frac{1}{2} Q_1 \delta_1 + \frac{1}{2} Q_2 \delta_2 \)</span><br>
                            <div class="formula-desc">å„éšã®å±¤ã›ã‚“æ–­åŠ›ã¨å¤‰ä½ã®ç©ã®1/2ã‚’åˆè¨ˆã—ãŸå…¨ä½“ã®ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã‚¨ãƒãƒ«ã‚®ãƒ¼ã€‚</div>
                        </div>
                        <div class="formula-item">
                            <strong>\( h_{eq1} \) (1éšã®ç­‰ä¾¡æ¸›è¡°å®šæ•°)</strong><br>
                            <span class="formula-eq">\( h_{eq1} = \frac{\delta_{z1} - Q_1/K_{10}}{\delta_{z1}} \times \frac{2}{4\pi} \)</span><br>
                            <div class="formula-desc">\( Q_1/K_{10} \): å¼¾æ€§å¤‰å½¢é‡ã€\( \delta_{z1} - Q_1/K_{10} \): å¡‘æ€§å¤‰å½¢é‡<br>å¡‘æ€§å¤‰å½¢ã®å‰²åˆã‹ã‚‰ã‚¨ãƒãƒ«ã‚®ãƒ¼å¸åèƒ½åŠ›ã‚’è©•ä¾¡ã—ã¾ã™ï¼ˆè² å€¤ã¯0ï¼‰ã€‚</div>
                        </div>
                        <div class="formula-item">
                            <strong>\( h_{eq2} \) (2éšã®ç­‰ä¾¡æ¸›è¡°å®šæ•°)</strong><br>
                            <span class="formula-eq">\( h_{eq2} = \frac{\delta_2 - Q_2/K_{20}}{\delta_2} \times \frac{2}{4\pi} \)</span><br>
                            <div class="formula-desc">\( \delta_2 = \delta_{z2} - \delta_{z1} \): 2éšã®å±¤é–“å¤‰ä½<br>\( Q_2/K_{20} \): å¼¾æ€§å¤‰å½¢é‡ã€\( \delta_2 - Q_2/K_{20} \): å¡‘æ€§å¤‰å½¢é‡</div>
                        </div>
                        <div class="formula-item">
                            <strong>\( \Delta W \) (å±¥æ­´æ¸›è¡°ã‚¨ãƒãƒ«ã‚®ãƒ¼)</strong><br>
                            <span class="formula-eq">\( \Delta W = 4\pi (h_{eq1} \cdot W_1 + h_{eq2} \cdot W_2) \)</span><br>
                            <div class="formula-desc">\( W_1 = \frac{1}{2} Q_1 \delta_1 \), \( W_2 = \frac{1}{2} Q_2 \delta_2 \): å„éšã®ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã‚¨ãƒãƒ«ã‚®ãƒ¼</div>
                        </div>
                        <div class="formula-item">
                            <strong>\( h \) (ç­‰ä¾¡ç²˜æ€§æ¸›è¡°å®šæ•°)</strong><br>
                            <span class="formula-eq">\( h = 0.05 + \frac{\Delta W}{4\pi \cdot W_A} \)</span><br>
                            <div class="formula-desc">åˆæœŸæ¸›è¡°0.05ã«å±¥æ­´æ¸›è¡°ã‚’åŠ ç®—ï¼ˆä¸Šé™0.25ï¼‰ã€‚å¡‘æ€§å¤‰å½¢ãŒé€²ã‚€ã»ã©å¤§ãããªã‚Šã‚¨ãƒãƒ«ã‚®ãƒ¼å¸åèƒ½åŠ›ãŒé«˜ã¾ã‚Šã¾ã™ã€‚</div>
                        </div>
                        <div class="formula-item">
                            <strong>\( F_h \) (æ¸›è¡°ä½æ¸›ä¿‚æ•°)</strong><br>
                            <span class="formula-eq">\( F_h = \frac{1.5}{1 + 10h} \)</span><br>
                            <div class="formula-desc">æ¸›è¡° \( h \) ãŒå¤§ãã„ã»ã©åœ°éœ‡åŠ›ã‚’ä½æ¸›ã§ãã¾ã™ã€‚<br><strong>â€»å®‰å…¨é™ç•Œï¼ˆæ¥µç¨€åœ°éœ‡ï¼‰è¨ˆç®—æ™‚ã«é©ç”¨ã€‚æå‚·é™ç•Œï¼ˆç¨€åœ°éœ‡ï¼‰ã§ã¯åŸå‰‡ 1.0 (h=0.05ç›¸å½“) ã¨ã—ã¾ã™ã€‚</strong></div>
                        </div>
                        <div class="formula-item">
                            <strong>\( Q_A \) (ç­‰ä¾¡ã›ã‚“æ–­åŠ›)</strong><br>
                            <span class="formula-eq">\( Q_A = \frac{2 W_A}{\Delta} \)</span><br>
                            <div class="formula-desc">ã‚¨ãƒãƒ«ã‚®ãƒ¼ç­‰ä¾¡ã®é–¢ä¿‚ \( W_A = \frac{1}{2} Q_A \cdot \Delta \) ã‚ˆã‚Šé€†ç®—ã€‚ã‚°ãƒ©ãƒ•ã®ä¿æœ‰è€åŠ›æ›²ç·šã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
                        </div>
                    </div>
                </div>

                <div style="background:#fff; border:1px solid #ddd; padding:15px; margin-bottom:15px; border-radius:5px;">
                    <h4 style="margin-top:0; color:#005a9c; border-bottom:1px solid #ccc; padding-bottom:5px;">3-2. è¤‡æ•°è€åŠ›è¦ç´ ã®heqåˆæˆï¼ˆè‡ªç”±å…¥åŠ›ã®heqç›´æ¥å…¥åŠ›å¯¾å¿œï¼‰</h4>
                    <div class="formula-grid">
                        <div class="formula-item">
                            <strong>heqç›´æ¥å…¥åŠ›ãŒã‚ã‚‹å ´åˆ</strong><br>
                            <div class="formula-desc">è‡ªç”±å…¥åŠ›ã®å¾©å…ƒåŠ›ç‰¹æ€§ã§ã€Œheqã‚’å…¥åŠ›ã™ã‚‹ã€ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚ŒãŸå ´åˆã€å„å¤‰å½¢è§’ã«å¯¾å¿œã™ã‚‹heqå€¤ã‚’ç›´æ¥è¨­å®šã§ãã¾ã™ã€‚<br>ã“ã®å ´åˆã€è¨ˆç®—å¼ã«ã‚ˆã‚‹ç®—å‡ºã§ã¯ãªãã€å…¥åŠ›ã•ã‚ŒãŸheqå€¤ã‚’è£œé–“ã—ã¦ä½¿ç”¨ã—ã¾ã™ã€‚</div>
                        </div>
                        <div class="formula-item">
                            <strong>heqç›´æ¥å…¥åŠ›ãŒãªã„å ´åˆ</strong><br>
                            <span class="formula-eq">\( h_{eq,i} = 0.2 \times \left(1 - \sqrt{\frac{K_i}{K_{i0}}}\right) \)</span><br>
                            <div class="formula-desc">\( K_{i0} \): è¦ç´ ã®åˆæœŸå‰›æ€§ã€\( K_i \): ç¾åœ¨ã®å‰²ç·šå‰›æ€§<br>å¾“æ¥é€šã‚Šã€å‰›æ€§ä½ä¸‹ç‡ã‹ã‚‰è‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™ã€‚</div>
                        </div>
                        <div class="formula-item">
                            <strong>éšå…¨ä½“ã®heqåˆæˆï¼ˆåŠ é‡å¹³å‡ï¼‰</strong><br>
                            <span class="formula-eq">\( h_{eq,éš} = \frac{\sum (h_{eq,i} \times Q_i)}{\sum Q_i} \)</span><br>
                            <div class="formula-desc">å„è€åŠ›è¦ç´ ï¼ˆå£ãƒ»è‡ªç”±å…¥åŠ›ï¼‰ã®heqã‚’ã€ãã®è¦ç´ ã®ã›ã‚“æ–­åŠ›\( Q_i \)ã§é‡ã¿ä»˜ã‘ã—ã¦åˆæˆã—ã¾ã™ã€‚<br>heqç›´æ¥å…¥åŠ›ãŒã‚ã‚‹è¦ç´ ã¨ã€è‡ªå‹•è¨ˆç®—ã®è¦ç´ ãŒæ··åœ¨ã™ã‚‹å ´åˆã‚‚ã€åŒã˜å¼ã§åˆæˆã•ã‚Œã¾ã™ã€‚</div>
                        </div>
                        <div class="formula-item">
                            <strong>æ··åœ¨æ™‚ã®è¨ˆç®—ä¾‹</strong><br>
                            <div class="formula-desc">
                                ä¾‹ï¼šå£Aï¼ˆè‡ªå‹•è¨ˆç®— heq=0.05, Q=50kNï¼‰+ è‡ªç”±å…¥åŠ›Bï¼ˆç›´æ¥å…¥åŠ› heq=0.10, Q=30kNï¼‰<br>
                                \( h_{eq,éš} = \frac{0.05 \times 50 + 0.10 \times 30}{50 + 30} = \frac{2.5 + 3.0}{80} = 0.069 \)
                            </div>
                        </div>
                    </div>
                </div>
                
                 <div style="background:#fff; border:1px solid #ddd; padding:15px; margin-bottom:15px; border-radius:5px;">
                    <h4 style="margin-top:0; color:#005a9c; border-bottom:1px solid #ccc; padding-bottom:5px;">3-3. ç­‹äº¤ã„/ãƒ–ãƒ¬ãƒ¼ã‚¹ã®è§’åº¦è£œæ­£</h4>
                    <div class="formula-grid">
                        <div class="formula-item">
                            <strong>åŸºæº–ãƒ‡ãƒ¼ã‚¿</strong><br>
                            <div class="formula-desc">brace_data.csvã«æ ¼ç´ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã¯ã€å£å¹…0.91mã€éšé«˜2.73mã§ã®è©¦é¨“å€¤ã§ã™ã€‚<br>å®Ÿéš›ã®è¨­ç½®æ¡ä»¶ã«å¿œã˜ã¦ã€ãƒ–ãƒ¬ãƒ¼ã‚¹è§’åº¦Î¸ã«ã‚ˆã‚‹cosÎ¸ã§è€åŠ›å€¤ã‚’è‡ªå‹•è£œæ­£ã—ã¾ã™ã€‚</div>
                        </div>
                        <div class="formula-item">
                            <strong>ãƒ–ãƒ¬ãƒ¼ã‚¹è§’åº¦Î¸</strong><br>
                            <span class="formula-eq">\( \theta = \tan^{-1}\left(\frac{H}{W}\right) \)</span><br>
                            <div class="formula-desc">H: éšé«˜(m)ã€W: å£å¹…(m)<br>åŸºæº–è§’åº¦ \( \theta_{base} = \tan^{-1}(2.73/0.91) \approx 71.6Â° \)</div>
                        </div>
                        <div class="formula-item">
                            <strong>è£œæ­£ä¿‚æ•°</strong><br>
                            <span class="formula-eq">\( \alpha = \frac{\cos\theta_{actual}}{\cos\theta_{base}} \)</span><br>
                            <div class="formula-desc">å®Ÿéš›ã®ãƒ–ãƒ¬ãƒ¼ã‚¹è§’åº¦Î¸ã¨åŸºæº–è§’åº¦Î¸baseã®cosÎ¸ã®æ¯”ç‡ã«ã‚ˆã‚Šã€æ°´å¹³æ–¹å‘ã®è€åŠ›æˆåˆ†ã‚’è£œæ­£ã—ã¾ã™ã€‚</div>
                        </div>
                        <div class="formula-item">
                            <strong>è£œæ­£å¾Œã®è€åŠ›</strong><br>
                            <span class="formula-eq">\( Q_{brace} = Q_{base} \times \alpha \times n \)</span><br>
                            <div class="formula-desc">Q_base: CSVè¨˜è¼‰ã®åŸºæº–è€åŠ›å€¤ã€n: ç®‡æ‰€æ•°<br>å£å¹…ã¨éšé«˜ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€è‡ªå‹•çš„ã«è£œæ­£ã•ã‚ŒãŸè€åŠ›ãŒè¨ˆç®—ã«åæ˜ ã•ã‚Œã¾ã™ã€‚</div>
                        </div>
                    </div>
                </div>
                
                 <div style="background:#fff; border:1px solid #ddd; padding:15px; margin-bottom:15px; border-radius:5px;">
                    <h4 style="margin-top:0; color:#005a9c; border-bottom:1px solid #ccc; padding-bottom:5px;">4. è¦æ±‚ã›ã‚“æ–­åŠ›ã¨åˆ¤å®š</h4>
                    <div class="formula-grid">
                        <div class="formula-item">
                            <strong>\( Q_{req} \) (å¿…è¦è€åŠ›)</strong><br>
                            <span class="formula-eq">\( Q_{req} = M_e \cdot S_A \)</span><br>
                            <div class="formula-desc">ã‚°ãƒ©ãƒ•ä¸Šã®ã€Œå¿…è¦è€åŠ›æ›²ç·šï¼ˆç‚¹ç·šï¼‰ã€ã®Yåº§æ¨™ã€‚<br>ä¿æœ‰è€åŠ› \( Q_a \) ã¨äº¤å·®ã™ã‚‹ç‚¹ãŒå¿œç­”å€¤ï¼ˆ\( P_{si} \approx Q_a \)ï¼‰ã€‚</div>
                        </div>
                        <div class="formula-item">
                            <strong>è©•ç‚¹ã¨åˆ¤å®š</strong><br>
                            <span class="formula-eq">\( \text{è©•ç‚¹} = Q_{si} / Q_{sni} \)</span><br>
                            <div class="formula-desc">
                                <strong>\( Q_{si} \): å®‰å…¨é™ç•Œè€åŠ›</strong>ï¼ˆè·é‡å¤‰å½¢æ›²ç·šã®æœ€å¤§è·é‡ç‚¹ï¼‰<br>
                                <strong>\( Q_{sni} \): ä½œç”¨ã™ã‚‹åœ°éœ‡åŠ›</strong>ï¼ˆ\( Q_{si} \) æ™‚ã®å¿…è¦è€åŠ›ï¼‰<br>
                                â€»äº¤ç‚¹ã§ã¯ãªãã€æœ€å¤§è€åŠ›ç‚¹ã«ãŠã‘ã‚‹ä½™è£•åº¦ã§åˆ¤å®šã—ã¾ã™ã€‚<br>
                                1.5ä»¥ä¸Šï¼šå€’å£Šã—ãªã„<br>1.0ã€œ1.5ï¼šä¸€å¿œå€’å£Šã—ãªã„<br>0.7ã€œ1.0ï¼šå€’å£Šã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹<br>0.7æœªæº€ï¼šå€’å£Šã™ã‚‹å¯èƒ½æ€§ãŒé«˜ã„
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="background:#fff; border:1px solid #ddd; padding:15px; margin-bottom:15px; border-radius:5px;">
                    <h4 style="margin-top:0; color:#005a9c; border-bottom:1px solid #ccc; padding-bottom:5px;">5. åœ°åŸŸä¿‚æ•°ãƒ»p,qä¿‚æ•°ãƒ»åœ°ç›¤ç¨®åˆ¥</h4>
                    <div class="formula-grid">
                        <div class="formula-item">
                            <strong>\( Z \) (åœ°åŸŸä¿‚æ•°)</strong><br>
                            <span class="formula-eq">\( Z = 0.7 \sim 1.0 \)</span><br>
                            <div class="formula-desc">
                                åœ°éœ‡åœ°åŸŸä¿‚æ•°ã€‚åœ°åŸŸã«ã‚ˆã‚‹åœ°éœ‡ã®å¼·ã•ã®é•ã„ã‚’è€ƒæ…®ã™ã‚‹ä¿‚æ•°ã€‚<br>
                                <strong>ãƒ»1.0ï¼š</strong>å¤§éƒ¨åˆ†ã®åœ°åŸŸï¼ˆæ±äº¬ã€å¤§é˜ªã€åå¤å±‹ç­‰ï¼‰<br>
                                <strong>ãƒ»0.9ï¼š</strong>åŒ—æµ·é“ã®ä¸€éƒ¨ã€æ²–ç¸„ã®ä¸€éƒ¨ç­‰<br>
                                <strong>ãƒ»0.8ï¼š</strong>åŒ—æµ·é“ã®ä¸€éƒ¨ç­‰<br>
                                <strong>ãƒ»0.7ï¼š</strong>æ²–ç¸„ã®ä¸€éƒ¨ç­‰<br>
                                å»ºç¯‰åŸºæº–æ³•æ–½è¡Œä»¤ç¬¬88æ¡ã«å®šã‚ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚
                            </div>
                        </div>
                        <div class="formula-item">
                            <strong>åœ°ç›¤ç¨®åˆ¥ã¨ç‰¹æ€§å‘¨æœŸ \( T_c \)</strong><br>
                            <div class="formula-desc">
                                åœ°ç›¤ç¨®åˆ¥ã«ã‚ˆã‚ŠåŠ é€Ÿåº¦å¿œç­”ã‚¹ãƒšã‚¯ãƒˆãƒ«ã®å½¢ãŒå¤‰ã‚ã‚Šã¾ã™ã€‚<br>
                                <strong>ãƒ»ç¬¬1ç¨®åœ°ç›¤ï¼ˆ\( T_c = 0.4s \)ï¼‰ï¼š</strong>å²©ç›¤ã€ç¡¬è³ªç ‚ç¤«å±¤ã€ç¬¬ä¸‰ç´€å±¤ãªã©è‰¯å¥½ãªåœ°ç›¤<br>
                                <strong>ãƒ»ç¬¬2ç¨®åœ°ç›¤ï¼ˆ\( T_c = 0.6s \)ï¼‰ï¼š</strong>é€šå¸¸ã®åœ°ç›¤ï¼ˆç¬¬1ç¨®ãƒ»ç¬¬3ç¨®ä»¥å¤–ï¼‰<br>
                                <strong>ãƒ»ç¬¬3ç¨®åœ°ç›¤ï¼ˆ\( T_c = 0.8s \)ï¼‰ï¼š</strong>è»Ÿå¼±åœ°ç›¤ã€æ²¿å²¸åŸ‹ç«‹åœ°ã€æ¶¼æ²¢ä½åœ°ç­‰<br>
                                \( T_c \) ã¯åœ°ç›¤ã®å“è¶Šå‘¨æœŸã«å¯¾å¿œã—ã€\( T_c \) ä»˜è¿‘ã§å¿œç­”ãŒæœ€å¤§ã¨ãªã‚Šã¾ã™ã€‚
                            </div>
                        </div>
                        <div class="formula-item">
                            <strong>\( G_s \) (åœ°ç›¤å¢—å¹…ç‡)</strong><br>
                            <div class="formula-desc">
                                åœ°è¡¨é¢ã§ã®åœ°éœ‡å‹•ã®å¢—å¹…ç‡ã€‚åœ°ç›¤èª¿æŸ»çµæœã‹ã‚‰æ±ºå®šã—ã¾ã™ã€‚<br>
                                ç¬¬1ç¨®åœ°ç›¤ã§ã¯ \( G_s \approx 1.0 \sim 1.5 \)ã€ç¬¬3ç¨®åœ°ç›¤ã§ã¯ \( G_s \approx 1.5 \sim 2.5 \) ç¨‹åº¦ã€‚<br>
                                è‡ªç”±å…¥åŠ›ã§ã¯å‘¨æœŸã”ã¨ã® \( G_s(T) \) ã‚¹ãƒšã‚¯ãƒˆãƒ«ã‚’æŒ‡å®šå¯èƒ½ã§ã™ã€‚
                            </div>
                        </div>
                        <div class="formula-item">
                            <strong>\( p, q \) (èª¿æ•´ä¿‚æ•°)</strong><br>
                            <div class="formula-desc">
                                å¹³æˆ12å¹´å»ºå‘Šç¬¬1457å·ã«åŸºã¥ãèª¿æ•´ä¿‚æ•°ã€‚<br>
                                <strong>\( p \)ï¼šåœ°éœ‡åœ°åŸŸä¿‚æ•°ç­‰ã«é–¢ã™ã‚‹èª¿æ•´ä¿‚æ•°</strong><br>
                                ãƒ»\( T \leq T_c \) ã®ã¨ãï¼š\( p = 1.0 \)<br>
                                ãƒ»\( T > T_c \) ã®ã¨ãï¼š\( p = T_c / T \)  (é•·å‘¨æœŸå´ã§ä½æ¸›)<br>
                                <strong>\( q \)ï¼šæ§‹é€ ç‰¹æ€§ç­‰ã«é–¢ã™ã‚‹èª¿æ•´ä¿‚æ•°</strong><br>
                                ãƒ»\( T \leq T_c \) ã®ã¨ãï¼š\( q = T / T_c \)  (çŸ­å‘¨æœŸå´ã§ä½æ¸›)<br>
                                ãƒ»\( T > T_c \) ã®ã¨ãï¼š\( q = 1.0 \)<br>
                                ã“ã‚Œã‚‰ã«ã‚ˆã‚ŠçŸ­å‘¨æœŸãƒ»é•·å‘¨æœŸã®å»ºç‰©ã§å¿œç­”ã‚’é©åˆ‡ã«è©•ä¾¡ã§ãã¾ã™ã€‚
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-detail" class="tab-content no-print">
        <h2>5. äº¤ç‚¹è©³ç´°è¨ˆç®—</h2>
        <p style="color:#666; font-size:0.9em;">æå‚·é™ç•Œãƒ»å®‰å…¨é™ç•Œã®äº¤ç‚¹ã«ãŠã‘ã‚‹è©³ç´°ãªè¨ˆç®—éç¨‹ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚è¨ˆç®—å®Ÿè¡Œå¾Œã«æ›´æ–°ã•ã‚Œã¾ã™ã€‚</p>
        <div id="detail-content" style="display:none;">
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <button class="btn-sm" onclick="showDetailDir('x')" id="btn-detail-x" style="padding:8px 20px; font-weight:bold; background:#005a9c; color:#fff;">Xæ–¹å‘</button>
                <button class="btn-sm" onclick="showDetailDir('y')" id="btn-detail-y" style="padding:8px 20px; font-weight:bold;">Yæ–¹å‘</button>
            </div>
            <div id="detail-x" style="display:block;"></div>
            <div id="detail-y" style="display:none;"></div>
        </div>
        <div id="detail-placeholder" style="padding:40px; text-align:center; color:#999; border:2px dashed #ddd; border-radius:8px;">
            <p style="font-size:1.2em;">è¨ˆç®—ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ã“ã“ã«äº¤ç‚¹è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
            <p>ã€Œ4. è¨ˆç®—çµæœãƒ»ãƒ­ã‚°ã€ã‚¿ãƒ–ã§è¨ˆç®—ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>
        </div>
    </div>

    <div id="tab-shear" class="tab-content no-print">
        <h2>6. å±¤ã›ã‚“æ–­åŠ›ã®æ¯”è¼ƒ</h2>
        <div id="shear-result-container">
            <div style="padding:40px; text-align:center; color:#999; border:2px dashed #ddd; border-radius:8px;">
                <p style="font-size:1.2em;">è¨ˆç®—ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ã“ã“ã«æ¯”è¼ƒçµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
            </div>
        </div>
    </div>

    <div id="report-view">
        <div class="report-page" id="rep-page-cover" style="display:none; height: 95vh; box-sizing: border-box; text-align:center;">
            <div style="display: flex; flex-direction: column; height: 100%; align-items: center;">
                
                <div style="margin-top: 100px; width: 100%;">
                    <h1 style="font-size:36pt; margin: 0 0 20px 0; border:none; padding:0; color:#000;">æ§‹é€ è¨ˆç®—æ›¸</h1>
                    <h2 style="font-size:20pt; font-weight:normal; border:none; background:none; margin:0; color:#000;">é™ç•Œè€åŠ›è¨ˆç®—ã«ã‚ˆã‚‹å¿œç­”æ¤œè¨</h2>
                </div>
                
                <div style="flex-grow: 1;"></div>
                
                <div style="width: 85%;">
                    <div style="border-top:4px double #000; border-bottom:4px double #000; padding:40px 0;">
                        <div id="rep-cover-project-name" style="font-size:32pt; font-weight:bold; line-height: 1.4;"></div>
                    </div>
                </div>
                
                <div style="margin-top: 50px; margin-bottom: 20px;">
                    <div id="rep-cover-date" style="font-size:16pt;"></div>
                </div>
                
                <div style="flex-grow: 2;"></div>

                <div style="width: 70%; margin-bottom: 80px;">
                    <div style="border-top:4px double #000; width: 100%; margin-bottom: 30px;"></div>
                    
                    <div id="rep-cover-company" style="font-size:24pt; font-weight:bold; margin-bottom: 30px;"></div>
                    
                    <div style="display: inline-block; text-align: left; min-width: 60%;">
                        <div id="rep-cover-office-reg" style="font-size:14pt; margin-bottom:10px;"></div>
                        <div id="rep-cover-arch-reg" style="font-size:14pt; margin-bottom:10px;"></div>
                        <div id="rep-cover-manager-name" style="font-size:14pt;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç›®æ¬¡ãƒšãƒ¼ã‚¸ -->
        <div class="report-page" id="rep-page-toc" style="display:none;">
            <div class="report-header">
                <div class="report-title-box">
                    <h1>æ§‹é€ è¨ˆç®—æ›¸ï¼šæœ¨é€ é™ç•Œè€åŠ›è¨ˆç®—</h1>
                </div>
                <div id="rep-toc-building-name" class="report-prop-name"></div>
            </div>
            
            <div class="report-section">
                <h3 style="font-size:18pt; text-align:center; border-bottom:2px solid #000; padding-bottom:10px;">ç›®æ¬¡</h3>
                <div id="toc-content" style="margin-top:20px; font-size:11pt; line-height:2;">
                    <!-- ç›®æ¬¡å†…å®¹ãŒå‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
                </div>
            </div>
        </div>

        <!-- ç¬¬1ç« : å»ºç‰©æ¦‚è¦ -->
        <div class="report-page" id="rep-page-overview" data-chapter="1" data-title="å»ºç‰©æ¦‚è¦ãƒ»è«¸å…ƒ">
            <div class="report-header">
                <div class="report-title-box">
                    <h1>æ§‹é€ è¨ˆç®—æ›¸ï¼šæœ¨é€ é™ç•Œè€åŠ›è¨ˆç®—</h1>
                    <span id="report-date"></span>
                </div>
                <div id="rep-building-name" class="report-prop-name"></div>
            </div>
            
            <div class="report-section">
                <h3>ç¬¬1ç«  å»ºç‰©æ¦‚è¦ãƒ»è«¸å…ƒ</h3>
                <table class="report-table">
                    <tr>
                        <th width="15%">åœ°åŸŸä¿‚æ•° Z</th><td id="rep-Z" width="15%"></td>
                        <th width="15%">åœ°ç›¤ç¨®åˆ¥</th><td id="rep-Tc"></td>
                        <th width="15%">p, qè€ƒæ…®</th><td id="rep-PQ"></td>
                    </tr>
                    <tr>
                         <th>æå‚·é™ç•Œ</th><td id="rep-lim-d"></td>
                         <th>å®‰å…¨é™ç•Œ</th><td id="rep-lim-s"></td>
                         <td colspan="2"></td>
                    </tr>
                </table>
                <table class="report-table" style="margin-top:5px;">
                    <thead><tr><th>éš</th><th>éšé«˜H(m)</th><th>é‡é‡W(kN)</th><th>ç´¯è¨ˆé‡é‡(kN)</th><th>åˆæœŸå‰›æ€§Ki(kN/m)</th></tr></thead>
                    <tbody id="rep-bldg-tbody"></tbody>
                </table>
            </div>
            
            <div class="report-section">
                <h3>1-2. åœ°ç›¤ç¨®åˆ¥ãƒ»Gsã‚¹ãƒšã‚¯ãƒˆãƒ«</h3>
                <div style="display:flex; gap:15px; align-items:flex-start;">
                    <div style="flex:1;">
                        <table class="report-table">
                            <tr><th width="30%">åœ°ç›¤ç¨®åˆ¥</th><td id="rep-Tc-detail"></td></tr>
                            <tr><th>è¨­å®šæ–¹æ³•</th><td id="rep-Tc-mode"></td></tr>
                        </table>
                        <div id="rep-gs-data-table" style="margin-top:5px; font-size:7pt;"></div>
                    </div>
                    <div style="flex:1; max-width:350px;">
                        <div style="font-size:8pt; font-weight:bold; margin-bottom:3px;">Gsã‚¹ãƒšã‚¯ãƒˆãƒ«ã‚°ãƒ©ãƒ•</div>
                        <div style="height:150px; border:1px solid #ccc;">
                            <canvas id="rep-chart-gs"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="page-number">- 1 -</div>
        </div>

        <!-- ç¬¬1ç«  ç¶šã (2ãƒšãƒ¼ã‚¸ç›®) -->
        <div class="report-page" id="rep-page-overview-2" data-chapter="1" data-title="å»ºç‰©æ¦‚è¦ãƒ»è«¸å…ƒï¼ˆç¶šãï¼‰">
            <div class="report-header">
                <div class="report-title-box">
                    <h1>æ§‹é€ è¨ˆç®—æ›¸ï¼šæœ¨é€ é™ç•Œè€åŠ›è¨ˆç®—</h1>
                </div>
                <div id="rep-building-name-2" class="report-prop-name"></div>
            </div>
            
            <div class="report-section">
                <h3>1-3. å¿œç­”ã‚¹ãƒšã‚¯ãƒˆãƒ« (Sa)</h3>
                <table class="report-table" style="font-size:8pt; margin-bottom:5px;">
                    <tr><th width="25%">å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰</th><td id="rep-sa-mode"></td></tr>
                </table>
                <div style="display:flex; gap:15px; align-items:flex-start;">
                    <div style="flex:1;">
                        <div id="rep-sa-desc" style="font-size:7pt; line-height:1.4;">
                            <p><strong>åŠ é€Ÿåº¦å¿œç­”ã‚¹ãƒšã‚¯ãƒˆãƒ« Sa0(T)</strong></p>
                            <p>å²©ç›¤ä¸Šã®åŠ é€Ÿåº¦å¿œç­”ã‚¹ãƒšã‚¯ãƒˆãƒ«ã‚’è¡¨ã—ã¾ã™ã€‚</p>
                            <p>â— æå‚·é™ç•Œ: ç¨€ã«ç™ºç”Ÿã™ã‚‹åœ°éœ‡å‹• (50å¹´ã«1å›ç¨‹åº¦)</p>
                            <p>â— å®‰å…¨é™ç•Œ: æ¥µã‚ã¦ç¨€ã«ç™ºç”Ÿã™ã‚‹åœ°éœ‡å‹• (500å¹´ã«1å›ç¨‹åº¦)</p>
                            <p>â€»å®‰å…¨é™ç•Œã¯æå‚·é™ç•Œã®5å€</p>
                        </div>
                        <table class="report-table" style="font-size:7pt; margin-top:5px;">
                            <thead><tr><th>T(s)</th><th>Sa0(æå‚·)</th><th>Sa0(å®‰å…¨)</th></tr></thead>
                            <tbody id="rep-sa0-tbody"></tbody>
                        </table>
                    </div>
                    <div style="flex:1; max-width:350px;">
                        <div style="font-size:8pt; font-weight:bold; margin-bottom:3px;">Saã‚¹ãƒšã‚¯ãƒˆãƒ«ã‚°ãƒ©ãƒ•</div>
                        <div style="height:150px; border:1px solid #ccc;">
                            <canvas id="rep-chart-sa0"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="report-section" id="rep-pq-section">
                <h3>1-4. p, q èª¿æ•´ä¿‚æ•°</h3>
                <div style="display:flex; gap:15px; align-items:flex-start;">
                    <div style="flex:1;">
                        <table class="report-table">
                            <tr><th width="30%">p, q è€ƒæ…®</th><td id="rep-pq-mode"></td></tr>
                        </table>
                        <div id="rep-pq-desc" style="margin-top:5px; font-size:7pt;"></div>
                    </div>
                    <div style="flex:1; max-width:350px;">
                        <div style="font-size:8pt; font-weight:bold; margin-bottom:3px;">pä¿‚æ•°ã‚°ãƒ©ãƒ• (Te-p)</div>
                        <div style="height:150px; border:1px solid #ccc;">
                            <canvas id="rep-chart-p"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="page-number">- 2 -</div>
        </div>

        <!-- ç¬¬2ç« : å¾©å…ƒåŠ›ç‰¹æ€§ Xæ–¹å‘ -->
        <div class="report-page" id="rep-page-force-x" data-chapter="2" data-section="1" data-title="å¾©å…ƒåŠ›ç‰¹æ€§ï¼šXæ–¹å‘">
            <div class="report-header">
                <h1>ç¬¬2ç«  å¾©å…ƒåŠ›ç‰¹æ€§</h1>
            </div>
            <div class="report-section">
                <h3>2.1 Xæ–¹å‘ã®å¾©å…ƒåŠ›ç‰¹æ€§</h3>
            <div id="rep-force-x-detail" style="font-size:7pt; border:1px solid #ccc; padding:5px;"></div>
            <div style="height:200px; border:1px solid #ccc; margin-top:5px;">
                <canvas id="rep-chart-force-x"></canvas>
            </div>
            </div>
            <div class="page-number">- 3 -</div>
        </div>
        
        <!-- ç¬¬2ç« : å¾©å…ƒåŠ›ç‰¹æ€§ Yæ–¹å‘ -->
        <div class="report-page" id="rep-page-force-y" data-chapter="2" data-section="2" data-title="å¾©å…ƒåŠ›ç‰¹æ€§ï¼šYæ–¹å‘">
            <div class="report-header">
                <h1>ç¬¬2ç«  å¾©å…ƒåŠ›ç‰¹æ€§</h1>
            </div>
            <div class="report-section">
                <h3>2.2 Yæ–¹å‘ã®å¾©å…ƒåŠ›ç‰¹æ€§</h3>
            <div id="rep-force-y-detail" style="font-size:7pt; border:1px solid #ccc; padding:5px;"></div>
            <div style="height:200px; border:1px solid #ccc; margin-top:5px;">
                <canvas id="rep-chart-force-y"></canvas>
            </div>
            </div>
            <div class="page-number">- 4 -</div>
        </div>

        <!-- ç¬¬3ç« : åˆ¤å®šçµæœ Xæ–¹å‘ -->
        <div class="report-page" id="rep-page-result-x" data-chapter="3" data-section="1" data-title="åˆ¤å®šçµæœã‚µãƒãƒªãƒ¼ï¼šXæ–¹å‘">
            <div class="report-header">
                <h1>ç¬¬3ç«  åˆ¤å®šçµæœã‚µãƒãƒªãƒ¼</h1>
            </div>
            <div class="report-section">
                <h3>3.1 Xæ–¹å‘ã®åˆ¤å®šçµæœ</h3>
            <div id="rep-res-x-table" style="margin-bottom:10px;"></div>
            <div style="height:280px; border:1px solid #ccc;">
                <img id="rep-img-x" class="report-chart-img" style="width:100%; height:100%; object-fit:contain;">
            </div>
            </div>
            <div class="page-number">- 5 -</div>
        </div>
        
        <!-- ç¬¬3ç« : åˆ¤å®šçµæœ Yæ–¹å‘ -->
        <div class="report-page" id="rep-page-result-y" data-chapter="3" data-section="2" data-title="åˆ¤å®šçµæœã‚µãƒãƒªãƒ¼ï¼šYæ–¹å‘">
            <div class="report-header">
                <h1>ç¬¬3ç«  åˆ¤å®šçµæœã‚µãƒãƒªãƒ¼</h1>
            </div>
            <div class="report-section">
                <h3>3.2 Yæ–¹å‘ã®åˆ¤å®šçµæœ</h3>
            <div id="rep-res-y-table" style="margin-bottom:10px;"></div>
            <div style="height:280px; border:1px solid #ccc;">
                <img id="rep-img-y" class="report-chart-img" style="width:100%; height:100%; object-fit:contain;">
            </div>
            </div>
            <div class="page-number">- 6 -</div>
        </div>
        
        <!-- ç¬¬4ç« : è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ (1/2) -->
        <div class="report-page" id="rep-page-logic" data-chapter="4" data-title="è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ãƒ»è©³ç´°é …ç›®ã®è§£èª¬">
            <div class="report-header">
                <h1>ç¬¬4ç«  è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ãƒ»è©³ç´°é …ç›®ã®è§£èª¬</h1>
            </div>
            <div id="report-logic-1" class="logic-print"></div>
            <div class="page-number">- 7 -</div>
        </div>
        
        <!-- ç¬¬4ç« : è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ (2/2) -->
        <div class="report-page" id="rep-page-logic-2" data-chapter="4" data-title="è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ãƒ»è©³ç´°é …ç›®ã®è§£èª¬ï¼ˆç¶šãï¼‰">
            <div class="report-header">
                <h1>ç¬¬4ç«  è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ãƒ»è©³ç´°é …ç›®ã®è§£èª¬ï¼ˆç¶šãï¼‰</h1>
            </div>
            <div id="report-logic-2" class="logic-print"></div>
            <div class="page-number">- 8 -</div>
        </div>
        
        <!-- ç¬¬5ç« : è©³ç´°è¨ˆç®—ãƒ­ã‚° Xæ–¹å‘ (3åˆ†å‰²) -->
        <div class="report-page" id="rep-page-log-x1" data-chapter="5" data-section="1" data-title="è©³ç´°è¨ˆç®—ãƒ­ã‚°ï¼šXæ–¹å‘ (1/3)">
            <div class="report-header">
                <h1>ç¬¬5ç«  è©³ç´°è¨ˆç®—ãƒ­ã‚°</h1>
            </div>
            <div class="report-section">
                <h3>5.1 Xæ–¹å‘ã®è©³ç´°è¨ˆç®—ãƒ­ã‚° (1/3)</h3>
            <div id="report-log-x1" class="log-print-wrapper"></div>
            </div>
            <div class="page-number">- 9 -</div>
        </div>
        <div class="report-page" id="rep-page-log-x2" data-chapter="5" data-section="1" data-title="è©³ç´°è¨ˆç®—ãƒ­ã‚°ï¼šXæ–¹å‘ (2/3)">
            <div class="report-header">
                <h1>ç¬¬5ç«  è©³ç´°è¨ˆç®—ãƒ­ã‚°</h1>
            </div>
            <div class="report-section">
                <h3>5.1 Xæ–¹å‘ã®è©³ç´°è¨ˆç®—ãƒ­ã‚° (2/3)</h3>
            <div id="report-log-x2" class="log-print-wrapper"></div>
            </div>
            <div class="page-number">- 10 -</div>
        </div>
        <div class="report-page" id="rep-page-log-x3" data-chapter="5" data-section="1" data-title="è©³ç´°è¨ˆç®—ãƒ­ã‚°ï¼šXæ–¹å‘ (3/3)">
            <div class="report-header">
                <h1>ç¬¬5ç«  è©³ç´°è¨ˆç®—ãƒ­ã‚°</h1>
            </div>
            <div class="report-section">
                <h3>5.1 Xæ–¹å‘ã®è©³ç´°è¨ˆç®—ãƒ­ã‚° (3/3)</h3>
            <div id="report-log-x3" class="log-print-wrapper"></div>
            </div>
            <div class="page-number">- 11 -</div>
        </div>

        <!-- ç¬¬5ç« : è©³ç´°è¨ˆç®—ãƒ­ã‚° Yæ–¹å‘ (3åˆ†å‰²) -->
        <div class="report-page" id="rep-page-log-y1" data-chapter="5" data-section="2" data-title="è©³ç´°è¨ˆç®—ãƒ­ã‚°ï¼šYæ–¹å‘ (1/3)">
            <div class="report-header">
                <h1>ç¬¬5ç«  è©³ç´°è¨ˆç®—ãƒ­ã‚°</h1>
            </div>
            <div class="report-section">
                <h3>5.2 Yæ–¹å‘ã®è©³ç´°è¨ˆç®—ãƒ­ã‚° (1/3)</h3>
            <div id="report-log-y1" class="log-print-wrapper"></div>
            </div>
            <div class="page-number">- 12 -</div>
        </div>
        <div class="report-page" id="rep-page-log-y2" data-chapter="5" data-section="2" data-title="è©³ç´°è¨ˆç®—ãƒ­ã‚°ï¼šYæ–¹å‘ (2/3)">
            <div class="report-header">
                <h1>ç¬¬5ç«  è©³ç´°è¨ˆç®—ãƒ­ã‚°</h1>
            </div>
            <div class="report-section">
                <h3>5.2 Yæ–¹å‘ã®è©³ç´°è¨ˆç®—ãƒ­ã‚° (2/3)</h3>
            <div id="report-log-y2" class="log-print-wrapper"></div>
            </div>
            <div class="page-number">- 13 -</div>
        </div>
        <div class="report-page" id="rep-page-log-y3" data-chapter="5" data-section="2" data-title="è©³ç´°è¨ˆç®—ãƒ­ã‚°ï¼šYæ–¹å‘ (3/3)">
            <div class="report-header">
                <h1>ç¬¬5ç«  è©³ç´°è¨ˆç®—ãƒ­ã‚°</h1>
            </div>
            <div class="report-section">
                <h3>5.2 Yæ–¹å‘ã®è©³ç´°è¨ˆç®—ãƒ­ã‚° (3/3)</h3>
            <div id="report-log-y3" class="log-print-wrapper"></div>
            </div>
            <div class="page-number">- 14 -</div>
        </div>

        <!-- ç¬¬6ç« : äº¤ç‚¹è©³ç´°è¨ˆç®— Xæ–¹å‘ (4ãƒšãƒ¼ã‚¸) -->
        <div class="report-page" id="rep-page-detail-x1" data-chapter="6" data-section="1" data-title="äº¤ç‚¹è©³ç´°è¨ˆç®—ï¼šXæ–¹å‘ (1/4)">
            <div class="report-header">
                <h1>ç¬¬6ç«  äº¤ç‚¹è©³ç´°è¨ˆç®—</h1>
            </div>
            <div class="report-section">
                <h3>6.1 Xæ–¹å‘ã®äº¤ç‚¹è©³ç´°è¨ˆç®— (1/4) - æå‚·é™ç•Œ å‰åŠ</h3>
            <div id="rep-detail-x1" class="logic-print" style="font-size:8pt;"></div>
            </div>
            <div class="page-number">- 15 -</div>
        </div>
        <div class="report-page" id="rep-page-detail-x2" data-chapter="6" data-section="1" data-title="äº¤ç‚¹è©³ç´°è¨ˆç®—ï¼šXæ–¹å‘ (2/4)">
            <div class="report-header">
                <h1>ç¬¬6ç«  äº¤ç‚¹è©³ç´°è¨ˆç®—</h1>
            </div>
            <div class="report-section">
                <h3>6.1 Xæ–¹å‘ã®äº¤ç‚¹è©³ç´°è¨ˆç®— (2/4) - æå‚·é™ç•Œ å¾ŒåŠ</h3>
            <div id="rep-detail-x2" class="logic-print" style="font-size:8pt;"></div>
            </div>
            <div class="page-number">- 16 -</div>
        </div>
        <div class="report-page" id="rep-page-detail-x3" data-chapter="6" data-section="1" data-title="äº¤ç‚¹è©³ç´°è¨ˆç®—ï¼šXæ–¹å‘ (3/4)">
            <div class="report-header">
                <h1>ç¬¬6ç«  äº¤ç‚¹è©³ç´°è¨ˆç®—</h1>
            </div>
            <div class="report-section">
                <h3>6.1 Xæ–¹å‘ã®äº¤ç‚¹è©³ç´°è¨ˆç®— (3/4) - å®‰å…¨é™ç•Œ å‰åŠ</h3>
            <div id="rep-detail-x3" class="logic-print" style="font-size:8pt;"></div>
            </div>
            <div class="page-number">- 17 -</div>
        </div>
        <div class="report-page" id="rep-page-detail-x4" data-chapter="6" data-section="1" data-title="äº¤ç‚¹è©³ç´°è¨ˆç®—ï¼šXæ–¹å‘ (4/4)">
            <div class="report-header">
                <h1>ç¬¬6ç«  äº¤ç‚¹è©³ç´°è¨ˆç®—</h1>
            </div>
            <div class="report-section">
                <h3>6.1 Xæ–¹å‘ã®äº¤ç‚¹è©³ç´°è¨ˆç®— (4/4) - å®‰å…¨é™ç•Œ å¾ŒåŠ</h3>
            <div id="rep-detail-x4" class="logic-print" style="font-size:8pt;"></div>
            </div>
            <div class="page-number">- 18 -</div>
        </div>
        
        <!-- ç¬¬6ç« : äº¤ç‚¹è©³ç´°è¨ˆç®— Yæ–¹å‘ (4ãƒšãƒ¼ã‚¸) -->
        <div class="report-page" id="rep-page-detail-y1" data-chapter="6" data-section="2" data-title="äº¤ç‚¹è©³ç´°è¨ˆç®—:Yæ–¹å‘ (1/4)">
            <div class="report-header">
                <h1>ç¬¬6ç«  äº¤ç‚¹è©³ç´°è¨ˆç®—</h1>
            </div>
            <div class="report-section">
                <h3>6.2 Yæ–¹å‘ã®äº¤ç‚¹è©³ç´°è¨ˆç®— (1/4) - æå‚·é™ç•Œ å‰åŠ</h3>
            <div id="rep-detail-y1" class="logic-print" style="font-size:8pt;"></div>
            </div>
            <div class="page-number">- 19 -</div>
        </div>
        <div class="report-page" id="rep-page-detail-y2" data-chapter="6" data-section="2" data-title="äº¤ç‚¹è©³ç´°è¨ˆç®—ï¼šYæ–¹å‘ (2/4)">
            <div class="report-header">
                <h1>ç¬¬6ç«  äº¤ç‚¹è©³ç´°è¨ˆç®—</h1>
            </div>
            <div class="report-section">
                <h3>6.2 Yæ–¹å‘ã®äº¤ç‚¹è©³ç´°è¨ˆç®— (2/4) - æå‚·é™ç•Œ å¾ŒåŠ</h3>
            <div id="rep-detail-y2" class="logic-print" style="font-size:8pt;"></div>
            </div>
            <div class="page-number">- 20 -</div>
        </div>
        <div class="report-page" id="rep-page-detail-y3" data-chapter="6" data-section="2" data-title="äº¤ç‚¹è©³ç´°è¨ˆç®—ï¼šYæ–¹å‘ (3/4)">
            <div class="report-header">
                <h1>ç¬¬6ç«  äº¤ç‚¹è©³ç´°è¨ˆç®—</h1>
            </div>
            <div class="report-section">
                <h3>6.2 Yæ–¹å‘ã®äº¤ç‚¹è©³ç´°è¨ˆç®— (3/4) - å®‰å…¨é™ç•Œ å‰åŠ</h3>
            <div id="rep-detail-y3" class="logic-print" style="font-size:8pt;"></div>
            </div>
            <div class="page-number">- 21 -</div>
        </div>
        <div class="report-page" id="rep-page-detail-y4" data-chapter="6" data-section="2" data-title="äº¤ç‚¹è©³ç´°è¨ˆç®—ï¼šYæ–¹å‘ (4/4)">
            <div class="report-header">
                <h1>ç¬¬6ç«  äº¤ç‚¹è©³ç´°è¨ˆç®—</h1>
            </div>
            <div class="report-section">
                <h3>6.2 Yæ–¹å‘ã®äº¤ç‚¹è©³ç´°è¨ˆç®— (4/4) - å®‰å…¨é™ç•Œ å¾ŒåŠ</h3>
            <div id="rep-detail-y4" class="logic-print" style="font-size:8pt;"></div>
            </div>
            <div class="page-number">- 22 -</div>
        </div>
        
        <!-- ç¬¬7ç« : å±¤ã›ã‚“æ–­åŠ›ã®æ¯”è¼ƒãƒ»æ¤œè¨¼ (2ãƒšãƒ¼ã‚¸) -->
        <div class="report-page" id="rep-page-shear1" data-chapter="7" data-title="å±¤ã›ã‚“æ–­åŠ›ã®æ¯”è¼ƒãƒ»æ¤œè¨¼ (1/2)">
            <div class="report-header">
                <h1>ç¬¬7ç«  å±¤ã›ã‚“æ–­åŠ›ã®æ¯”è¼ƒãƒ»æ¤œè¨¼</h1>
            </div>
            <div id="rep-shear-content1" class="logic-print"></div>
            <div class="page-number">- 23 -</div>
        </div>
        <div class="report-page" id="rep-page-shear2" data-chapter="7" data-title="å±¤ã›ã‚“æ–­åŠ›ã®æ¯”è¼ƒãƒ»æ¤œè¨¼ (2/2)">
            <div class="report-header">
                <h1>ç¬¬7ç«  å±¤ã›ã‚“æ–­åŠ›ã®æ¯”è¼ƒãƒ»æ¤œè¨¼</h1>
            </div>
            <div id="rep-shear-content2" class="logic-print"></div>
            <div class="page-number">- 24 -</div>
        </div>
    </div>
</div>

<div id="sheet-modal" class="modal-overlay">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <h3 style="margin:0;">Excelè²¼ã‚Šä»˜ã‘: <span id="sheet-target-name" style="color:var(--primary);"></span></h3>
            <button onclick="closeSpreadsheet()" style="cursor:pointer; padding:5px 15px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
        <div style="margin-bottom:10px;">
            <label style="cursor:pointer;">
                <input type="checkbox" id="heq-input-checkbox" onchange="toggleHeqColumn()"> heqã‚’å…¥åŠ›ã™ã‚‹
            </label>
        </div>
        <div id="spreadsheet-container"></div>
        <div style="text-align:right; margin-top:10px;">
            <button class="btn-calc" style="font-size:1em; width:auto; margin:0;" onclick="applySheetData()">ãƒ‡ãƒ¼ã‚¿åæ˜ </button>
        </div>
    </div>
</div>

<div id="gs-modal" class="modal-overlay">
    <div class="modal-content" style="max-width:500px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <h3 style="margin:0;">Gsã‚¹ãƒšã‚¯ãƒˆãƒ«å…¥åŠ›</h3>
            <button onclick="closeGsSpreadsheet()" style="cursor:pointer; padding:5px 15px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
        <p style="font-size:0.85em; color:#666; margin:0 0 10px 0;">Excelã‹ã‚‰T(s)ã¨Gsã®2åˆ—ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚</p>
        <div id="gs-spreadsheet-container" style="height:300px;"></div>
        <div style="text-align:right; margin-top:10px;">
            <button class="btn-calc" style="font-size:1em; width:auto; margin:0;" onclick="applyGsData()">ãƒ‡ãƒ¼ã‚¿åæ˜ </button>
        </div>
    </div>
</div>

<div id="sa-modal" class="modal-overlay">
    <div class="modal-content" style="max-width:600px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <h3 style="margin:0;">Saã‚¹ãƒšã‚¯ãƒˆãƒ«å…¥åŠ› <span id="sa-modal-type" style="color:#005a9c;"></span></h3>
            <button onclick="closeSaSpreadsheet()" style="cursor:pointer; padding:5px 15px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
        <p style="font-size:0.85em; color:#666; margin:0 0 10px 0;">Excelã‹ã‚‰T(s)ã€Sa(m/sÂ²)ã®2åˆ—ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚</p>
        <div id="sa-spreadsheet-container" style="height:300px;"></div>
        <div style="text-align:right; margin-top:10px;">
            <button class="btn-calc" style="font-size:1em; width:auto; margin:0;" onclick="applySaData()">ãƒ‡ãƒ¼ã‚¿åæ˜ </button>
        </div>
    </div>
</div>

<script>
// --- Global Constants & State ---
const G_ACC = 9.80665; 
const DEF_GS = [ {t:0.1,g:2.5}, {t:0.6,g:2.5}, {t:0.7,g:2.14}, {t:1.0,g:1.5} ];

// â–¼â–¼â–¼ è¿½åŠ : ãƒ¬ãƒãƒ¼ãƒˆç”¨ãƒãƒ£ãƒ¼ãƒˆã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä¿æŒç”¨å¤‰æ•° â–¼â–¼â–¼
let repChartGs = null;
let repChartSa0 = null;
let repChartP = null;
// â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

// Gsã‚¹ãƒšã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿
let gsData = [];
let hotGs = null;
let chartGs = null;

// Saã‚¹ãƒšã‚¯ãƒˆãƒ«è‡ªç”±å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ {t: å‘¨æœŸ, sa: åŠ é€Ÿåº¦}
let saDataD = []; // æå‚·é™ç•Œç”¨
let saDataS = []; // å®‰å…¨é™ç•Œç”¨
let hotSa = null;
let currentSaType = 'd'; // ç¾åœ¨ç·¨é›†ä¸­ã®ã‚¿ã‚¤ãƒ— ('d' or 's')

// Standard Wall Data from CSV
// è€åŠ›å£ãƒ‡ãƒ¼ã‚¿ï¼ˆCSVã‹ã‚‰ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãŸã‚åˆæœŸå€¤ã¯ç©ºã€letã«å¤‰æ›´ï¼‰
let WALL_DATA = {};

// ç­‹äº¤ã„/ãƒ–ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ï¼ˆbrace_data.csvã‹ã‚‰èª­ã¿è¾¼ã‚€ï¼‰
let BRACE_DATA = {};

// --- å„å£è¦ç´ ã®åˆæœŸå‰›æ€§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ ---
let WALL_K0 = {};

// ç­‹äº¤ã„/ãƒ–ãƒ¬ãƒ¼ã‚¹ã®åˆæœŸå‰›æ€§ã‚­ãƒ£ãƒƒã‚·ãƒ¥
let BRACE_K0 = {};

// åˆæœŸå‰›æ€§ã‚’ç®—å‡ºã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥
function initWallK0() {
    for (let name in WALL_DATA) {
        let data = WALL_DATA[name];
        if (data.length > 0) {
            // åŸç‚¹ã‹ã‚‰æœ€åˆã®ç‚¹ã¾ã§ã®å‚¾ã
            let p = data[0];
            WALL_K0[name] = (p.r > 0) ? p.q / p.r : 10000;
        } else {
            WALL_K0[name] = 10000;
        }
    }
    
    // ç­‹äº¤ã„/ãƒ–ãƒ¬ãƒ¼ã‚¹ã®åˆæœŸå‰›æ€§ã‚‚è¨ˆç®—
    for (let name in BRACE_DATA) {
        let data = BRACE_DATA[name];
        if (data.length > 0) {
            let p = data[0];
            BRACE_K0[name] = (p.r > 0) ? p.q / p.r : 10000;
        } else {
            BRACE_K0[name] = 10000;
        }
    }
}

let calcRes = {}, chartObjs = {}, inputChartObjs = {}, currSheetTarget = '', hot = null;
let addedWalls = { x1: [], x2: [], y1: [], y2: [] }; // Added state for walls
let addedBraces = { x1: [], x2: [], y1: [], y2: [] }; // Added state for braces
let freeInputData = { x1: [], x2: [], y1: [], y2: [] }; // è¤‡æ•°ã®è‡ªç”±å…¥åŠ›é …ç›®ã‚’ç®¡ç†
let currentEditingFreeItem = null; // Excelè²¼ä»˜æ™‚ã«ç·¨é›†ä¸­ã®é …ç›®ã‚’è¿½è·¡

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å¾©å…ƒåŠ›ç‰¹æ€§ãƒ‡ãƒ¼ã‚¿ (1éšç”¨)
const DEFAULT_FREE_DATA_1F = [
    { r: 1/120, q: 60.00 },
    { r: 1/60, q: 120.00 },
    { r: 1/40, q: 130.00 },
    { r: 1/30, q: 140.00 },
    { r: 1/25, q: 120.00 },
    { r: 1/20, q: 100.00 },
    { r: 1/15, q: 90.00 }
];

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å¾©å…ƒåŠ›ç‰¹æ€§ãƒ‡ãƒ¼ã‚¿ (2éšç”¨)
const DEFAULT_FREE_DATA_2F = [
    { r: 1/120, q: 50.00 },
    { r: 1/60, q: 80.00 },
    { r: 1/40, q: 120.00 },
    { r: 1/30, q: 140.00 },
    { r: 1/25, q: 80.00 },
    { r: 1/20, q: 60.00 },
    { r: 1/15, q: 40.00 }
];

window.onload = async function() {
    toggleStories(); 
    
    // â–¼â–¼â–¼ å¤‰æ›´: CSVãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‹ã‚‰åˆæœŸåŒ– â–¼â–¼â–¼
    await loadWallDataFromServer();
    await loadBraceDataFromServer(); // ç­‹äº¤ã„/ãƒ–ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    // initWallSelectors(); // loadWallDataFromServerå†…ã§å‘¼ã³å‡ºã™ãŸã‚ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã¾ãŸã¯å‰Šé™¤
    // initWallK0();      // åŒä¸Š
    // â–²â–²â–² å¤‰æ›´ã“ã“ã¾ã§ â–²â–²â–²
    
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
    freeInputData = {
        x1: [{ name: 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ', qty: 1, data: JSON.parse(JSON.stringify(DEFAULT_FREE_DATA_1F)) }],
        x2: [{ name: 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ', qty: 1, data: JSON.parse(JSON.stringify(DEFAULT_FREE_DATA_2F)) }],
        y1: [{ name: 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ', qty: 1, data: JSON.parse(JSON.stringify(DEFAULT_FREE_DATA_1F)) }],
        y2: [{ name: 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ', qty: 1, data: JSON.parse(JSON.stringify(DEFAULT_FREE_DATA_2F)) }]
    };
    
    // åˆæœŸåŒ–æ™‚ã¯è‡ªç”±å…¥åŠ›ãƒªã‚¹ãƒˆã®ã¿åˆæœŸåŒ–
    ['x1','y1','x2','y2'].forEach(id => {
        renderFreeInputList(id);
        updateInputGraph(id);
    });
    
    // Gsã‚¹ãƒšã‚¯ãƒˆãƒ«ã‚°ãƒ©ãƒ•ã‚’åˆæœŸåŒ–ï¼ˆç¬¬2ç¨®ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤ºï¼‰
    updateGsChart();
    
    // å¿œç­”ã‚¹ãƒšã‚¯ãƒˆãƒ«Sa0ã‚°ãƒ©ãƒ•ã‚’åˆæœŸåŒ–
    updateSa0Chart();
    
    // pä¿‚æ•°ã‚°ãƒ©ãƒ•ã‚’åˆæœŸåŒ–
    updatePChart();
    
    document.getElementById('report-date').innerText = "è¨ˆç®—æ—¥: " + new Date().toLocaleDateString();
    
    toggleShearInput();
    
    // è¡¨ç´™ç”¨æ—¥ä»˜ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
    const today = new Date();
    const dateStr = today.getFullYear() + "å¹´" + (today.getMonth() + 1) + "æœˆ" + today.getDate() + "æ—¥";
    document.getElementById('inp_cover_date').value = dateStr;
};

// --- æ–°è¦è¿½åŠ : ã‚µãƒ¼ãƒãƒ¼ä¸Šã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€é–¢æ•° ---
async function loadWallDataFromServer() {
    try {
        // CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ (HTMLã¨åŒã˜éšå±¤ã« wall_data.csv ãŒã‚ã‚‹ã¨ä»®å®š)
        // å¿…è¦ã«å¿œã˜ã¦ãƒ‘ã‚¹ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„
        const response = await fetch('./wall_data.csv'); 
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const text = await response.text();
        parseWallCSV(text);
        
        // ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰å¾Œã«åˆæœŸåŒ–å‡¦ç†ã‚’å®Ÿè¡Œ
        initWallSelectors();
        initWallK0();
        
        console.log("è€åŠ›å£ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:", Object.keys(WALL_DATA).length + "ä»¶");
        
    } catch (e) {
        console.error("è€åŠ›å£ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
        alert("è€åŠ›å£ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nã‚µãƒ¼ãƒãƒ¼ç’°å¢ƒã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹ã€wall_data.csvãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    }
}

// --- ç­‹äº¤ã„/ãƒ–ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿é–¢æ•° ---
async function loadBraceDataFromServer() {
    try {
        const response = await fetch('./brace_data.csv'); 
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const text = await response.text();
        parseBraceCSV(text);
        
        // ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰å¾Œã«åˆæœŸåŒ–å‡¦ç†ã‚’å®Ÿè¡Œ
        initBraceSelectors();
        
        console.log("ç­‹äº¤ã„/ãƒ–ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:", Object.keys(BRACE_DATA).length + "ä»¶");
        
    } catch (e) {
        console.error("ç­‹äº¤ã„/ãƒ–ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
        alert("ç­‹äº¤ã„/ãƒ–ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nã‚µãƒ¼ãƒãƒ¼ç’°å¢ƒã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹ã€brace_data.csvãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    }
}

// CSVãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦WALL_DATAã«æ ¼ç´ã™ã‚‹ï¼ˆä¿®æ­£ç‰ˆï¼‰
function parseWallCSV(text) {
    WALL_DATA = {}; // ãƒªã‚»ãƒƒãƒˆ
    const lines = text.split(/\r?\n/);
    
    lines.forEach(line => {
        // ç©ºè¡Œã‚„ã‚³ãƒ¡ãƒ³ãƒˆè¡Œ(#)ã€ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—
        if (!line.trim() || line.startsWith('#') || line.toLowerCase().startsWith('name')) return;
        
        // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š: åç§°, r, q, heq(ä»»æ„)
        const parts = line.split(',');
        if (parts.length < 3) return;
        
        const name = parts[0].trim();
        const r = parseFloat(parts[1]);
        const q = parseFloat(parts[2]);
        
        // 4åˆ—ç›®ãŒã‚ã‚Œã° heq ã¨ã—ã¦èª­ã¿è¾¼ã‚€ï¼ˆãªã‘ã‚Œã° nullï¼‰
        let heq = null;
        if (parts.length >= 4) {
            const val = parseFloat(parts[3]);
            if (!isNaN(val)) {
                heq = val;
            }
        }
        
        if (name && !isNaN(r) && !isNaN(q)) {
            if (!WALL_DATA[name]) {
                WALL_DATA[name] = [];
            }
            // heq ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¿½åŠ ã—ã¦æ ¼ç´
            WALL_DATA[name].push({ r: r, q: q, heq: heq });
        }
    });
    
    // ãƒ‡ãƒ¼ã‚¿å†…ã§rã®æ˜‡é †ã«ã‚½ãƒ¼ãƒˆã—ã¦ãŠã
    for (let key in WALL_DATA) {
        WALL_DATA[key].sort((a, b) => a.r - b.r);
    }
}

// CSVãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦BRACE_DATAã«æ ¼ç´ã™ã‚‹ï¼ˆç­‹äº¤ã„/ãƒ–ãƒ¬ãƒ¼ã‚¹ç”¨ï¼‰
function parseBraceCSV(text) {
    BRACE_DATA = {}; // ãƒªã‚»ãƒƒãƒˆ
    const lines = text.split(/\r?\n/);
    
    lines.forEach(line => {
        // ç©ºè¡Œã‚„ã‚³ãƒ¡ãƒ³ãƒˆè¡Œ(#)ã€ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—
        if (!line.trim() || line.startsWith('#') || line.toLowerCase().includes('åç§°')) return;
        
        // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š: åç§°, r, q, heq(ä»»æ„), å£å¹…, éšé«˜
        const parts = line.split(',');
        if (parts.length < 6) return;
        
        const name = parts[0].trim();
        const r = parseFloat(parts[1]);
        const q = parseFloat(parts[2]);
        
        // 4åˆ—ç›®ãŒã‚ã‚Œã° heq ã¨ã—ã¦èª­ã¿è¾¼ã‚€ï¼ˆãªã‘ã‚Œã° nullï¼‰
        let heq = null;
        if (parts.length >= 4 && parts[3].trim()) {
            const val = parseFloat(parts[3]);
            if (!isNaN(val)) {
                heq = val;
            }
        }
        
        // 5åˆ—ç›®ã€6åˆ—ç›®: å£å¹…ã¨éšé«˜ï¼ˆåŸºæº–å€¤ï¼‰
        const baseWidth = parseFloat(parts[4]);
        const baseHeight = parseFloat(parts[5]);
        
        if (name && !isNaN(r) && !isNaN(q) && !isNaN(baseWidth) && !isNaN(baseHeight)) {
            if (!BRACE_DATA[name]) {
                BRACE_DATA[name] = {
                    baseWidth: baseWidth,
                    baseHeight: baseHeight,
                    data: []
                };
            }
            BRACE_DATA[name].data.push({ r: r, q: q, heq: heq });
        }
    });
    
    // ãƒ‡ãƒ¼ã‚¿å†…ã§rã®æ˜‡é †ã«ã‚½ãƒ¼ãƒˆã—ã¦ãŠã
    for (let key in BRACE_DATA) {
        BRACE_DATA[key].data.sort((a, b) => a.r - b.r);
    }
}

function initWallSelectors() {
    const opts = '<option value="">--- è€åŠ›å£ã‚’é¸æŠ ---</option>' + 
        Object.keys(WALL_DATA).map(k => `<option value="${k}">${k}</option>`).join('');
    ['x1','x2','y1','y2'].forEach(id => {
        document.getElementById(`sel-wall-${id}`).innerHTML = opts;
    });
}

function initBraceSelectors() {
    const opts = '<option value="">--- ç­‹äº¤ã„/ãƒ–ãƒ¬ãƒ¼ã‚¹ã‚’é¸æŠ ---</option>' + 
        Object.keys(BRACE_DATA).map(k => `<option value="${k}">${k}</option>`).join('');
    ['x1','x2','y1','y2'].forEach(id => {
        document.getElementById(`sel-brace-${id}`).innerHTML = opts;
    });
}

// ã€æ–°è¦è¿½åŠ ã€‘ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿å‰Šé™¤ç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
function checkAndRemoveDefault(id) {
    // è‡ªç”±å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ãŒ1ã¤ã ã‘ã§ã€ã‹ã¤åå‰ãŒã€Œãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã€ã®å ´åˆã®ã¿å‰Šé™¤
    if (freeInputData[id] && freeInputData[id].length === 1 && freeInputData[id][0].name === 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ') {
        freeInputData[id] = [];
        renderFreeInputList(id); // ãƒªã‚¹ãƒˆè¡¨ç¤ºã‚’æ›´æ–°ã—ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’æ¶ˆã™
        updateInputGraph(id);    // ã‚°ãƒ©ãƒ•ã‚‚æ›´æ–°
    }
}

// --- Wall Management ---
function addWall(id) {
    // â–¼â–¼â–¼ è¿½åŠ éƒ¨åˆ†: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãŒã‚ã‚Œã°å‰Šé™¤ â–¼â–¼â–¼
    checkAndRemoveDefault(id);
    // â–²â–²â–² è¿½åŠ éƒ¨åˆ†ã“ã“ã¾ã§ â–²â–²â–²

    const sel = document.getElementById(`sel-wall-${id}`);
    const name = sel.value;
    const qtyInput = document.getElementById(`qty-wall-${id}`);
    const qty = parseFloat(qtyInput.value);
    
    if(!name || name === '') {
        alert('è€åŠ›å£ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        return;
    }
    if(qty <= 0 || isNaN(qty)) {
        alert('é…ç½®æ•°é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
    }
    
    addedWalls[id].push({ name: name, qty: qty });
    renderWallList(id);
    updateInputGraph(id);
    
    // Reset inputs
    qtyInput.value = "1";
    sel.value = "";
}

function removeWall(id, idx) {
    addedWalls[id].splice(idx, 1);
    renderWallList(id);
    updateInputGraph(id);
}

function renderWallList(id) {
    const list = document.getElementById(`list-wall-${id}`);
    list.innerHTML = '';
    addedWalls[id].forEach((w, i) => {
        const div = document.createElement('div');
        div.className = 'wall-item';
        div.innerHTML = `<span>${w.name} Ã— ${w.qty}</span> <button class="btn-sm" style="color:red;" onclick="removeWall('${id}', ${i})">å‰Šé™¤</button>`;
        list.appendChild(div);
    });
}

// --- Brace Management (ç­‹äº¤ã„/ãƒ–ãƒ¬ãƒ¼ã‚¹) ---
function addBrace(id) {
    checkAndRemoveDefault(id);
    
    const sel = document.getElementById(`sel-brace-${id}`);
    const name = sel.value;
    const widthInput = document.getElementById(`width-brace-${id}`);
    const width = parseFloat(widthInput.value);
    const qtyInput = document.getElementById(`qty-brace-${id}`);
    const qty = parseInt(qtyInput.value);
    
    if(!name || name === '') {
        alert('ç­‹äº¤ã„/ãƒ–ãƒ¬ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        return;
    }
    if(width <= 0 || isNaN(width)) {
        alert('å£å¹…ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
    }
    if(qty <= 0 || isNaN(qty)) {
        alert('ç®‡æ‰€æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
    }
    
    // éšé«˜ã‚’å–å¾—
    const floor = id.includes('2') ? '2' : '1';
    const height = parseFloat(document.getElementById('inp_H' + floor).value) || 3.0;
    
    // cosÎ¸ã«ã‚ˆã‚‹è£œæ­£ç‡ã‚’è¨ˆç®—
    const braceInfo = BRACE_DATA[name];
    if (!braceInfo) {
        alert('é¸æŠã—ãŸç­‹äº¤ã„/ãƒ–ãƒ¬ãƒ¼ã‚¹ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
        return;
    }
    
    const baseTheta = Math.atan2(braceInfo.baseHeight, braceInfo.baseWidth);
    const baseCos = Math.cos(baseTheta);
    
    const actualTheta = Math.atan2(height, width);
    const actualCos = Math.cos(actualTheta);
    
    const correctionFactor = actualCos / baseCos;
    
    addedBraces[id].push({ 
        name: name, 
        width: width, 
        qty: qty, 
        height: height,
        correctionFactor: correctionFactor 
    });
    
    renderBraceList(id);
    updateInputGraph(id);
    
    // Reset inputs
    widthInput.value = "0.91";
    qtyInput.value = "1";
    sel.value = "";
}

function removeBrace(id, idx) {
    addedBraces[id].splice(idx, 1);
    renderBraceList(id);
    updateInputGraph(id);
}

function renderBraceList(id) {
    const list = document.getElementById(`list-brace-${id}`);
    list.innerHTML = '';
    addedBraces[id].forEach((b, i) => {
        const div = document.createElement('div');
        div.className = 'wall-item';
        const factor = (b.correctionFactor * 100).toFixed(1);
        div.innerHTML = `<span>${b.name} W=${b.width}m H=${b.height.toFixed(2)}m Ã— ${b.qty}ç®‡æ‰€ (è£œæ­£ç‡:${factor}%)</span> <button class="btn-sm" style="color:red;" onclick="removeBrace('${id}', ${i})">å‰Šé™¤</button>`;
        list.appendChild(div);
    });
}

// --- Free Input Item Management (è¤‡æ•°è‡ªç”±å…¥åŠ›å¯¾å¿œ) ---
function addFreeInputItem(id) {
    // â–¼â–¼â–¼ è¿½åŠ éƒ¨åˆ†: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãŒã‚ã‚Œã°å‰Šé™¤ â–¼â–¼â–¼
    checkAndRemoveDefault(id);
    // â–²â–²â–² è¿½åŠ éƒ¨åˆ†ã“ã“ã¾ã§ â–²â–²â–²

    const nameInput = document.getElementById(`free-name-${id}`);
    const qtyInput = document.getElementById(`free-qty-${id}`);
    const name = nameInput.value.trim() || `è‡ªç”±å…¥åŠ›${freeInputData[id].length + 1}`;
    const qty = parseFloat(qtyInput.value) || 1;
    
    if(qty <= 0) {
        alert('æ•°é‡ã¯0ã‚ˆã‚Šå¤§ãã„å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
    }
    
    freeInputData[id].push({ name: name, qty: qty, data: [] });
    renderFreeInputList(id);
    updateInputGraph(id);
    
    // Reset input
    nameInput.value = '';
    qtyInput.value = '1';
}

function removeFreeInputItem(id, idx) {
    freeInputData[id].splice(idx, 1);
    renderFreeInputList(id);
    updateInputGraph(id);
}

function editFreeInputItem(id, idx) {
    currentEditingFreeItem = { id: id, idx: idx };
    const item = freeInputData[id][idx];
    
    document.getElementById('sheet-target-name').innerText = `${id.toUpperCase()} - ${item.name} (Ã—${item.qty})`;
    document.getElementById('sheet-modal').style.display = 'flex';
    
    // Prepare data for spreadsheet
    let floor = id.includes('2') ? '2' : '1';
    let h = parseFloat(document.getElementById('inp_H'+floor).value) || 3.0;
    
    // heqãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    const hasHeq = item.data.some(p => p.heq !== undefined && p.heq !== null);
    document.getElementById('heq-input-checkbox').checked = hasHeq;
    
    let data = item.data.map(p => {
        let n = (p.r > 0) ? (1/p.r).toFixed(1) : '';
        if(hasHeq) {
            return [`1/${n}`, p.q, p.heq !== undefined ? p.heq : null];
        } else {
            return [`1/${n}`, p.q];
        }
    });
    
    // 100è¡Œã¾ã§æ‹¡å¼µ
    const totalRows = 100;
    while(data.length < totalRows) {
        data.push(hasHeq ? [null, null, null] : [null, null]);
    }
    
    if(hot) hot.destroy();
    
    if(hasHeq) {
        hot = new Handsontable(document.getElementById('spreadsheet-container'), {
            data: data, colHeaders: ['å¤‰å½¢è§’(1/N) or rad', 'Q(kN)', 'heq'], 
            columns: [{}, { type: 'numeric' }, { type: 'numeric' }],
            rowHeaders: true, contextMenu: true, width: '100%', height: '100%', licenseKey: 'non-commercial-and-evaluation'
        });
    } else {
        hot = new Handsontable(document.getElementById('spreadsheet-container'), {
            data: data, colHeaders: ['å¤‰å½¢è§’(1/N) or rad', 'Q(kN)'], 
            columns: [{}, { type: 'numeric' }],
            rowHeaders: true, contextMenu: true, width: '100%', height: '100%', licenseKey: 'non-commercial-and-evaluation'
        });
    }
}

function renderFreeInputList(id) {
    const list = document.getElementById(`free-list-${id}`);
    list.innerHTML = '';
    freeInputData[id].forEach((item, i) => {
        const div = document.createElement('div');
        div.className = 'wall-item';
        const pointCount = item.data.length;
        const qtyStr = item.qty !== 1 ? ` Ã—${item.qty}` : '';
        div.innerHTML = `<span>${item.name}${qtyStr} (${pointCount}ç‚¹)</span> 
            <span>
                <button class="btn-sm" onclick="editFreeInputItem('${id}', ${i})">ç·¨é›†</button>
                <button class="btn-sm" style="color:red;" onclick="removeFreeInputItem('${id}', ${i})">å‰Šé™¤</button>
            </span>`;
        list.appendChild(div);
    });
}

// --- Composite Force Logic (Combine Walls + Free Input) ---
// å„å¤‰å½¢è§’ã«å¯¾ã—ã¦ã€å…¨è¦ç´ ã®åˆè¨ˆQãƒ»åˆè¨ˆheq (åŠ é‡å¹³å‡) ã‚’è¿”ã™
function getCompositeForce(id) {
    // 1. Collect all radian points from all sources
    let allRads = new Set();
    allRads.add(0); // Ensure origin
    
    // Add free input item key points (è¤‡æ•°ã®è‡ªç”±å…¥åŠ›é …ç›®)
    freeInputData[id].forEach(item => {
        item.data.forEach(d => allRads.add(d.r));
    });

    // Add standard wall key points
    addedWalls[id].forEach(w => {
        let data = WALL_DATA[w.name];
        if(data) {
            data.forEach(d => allRads.add(d.r));
        }
    });
    
    // Add brace key points (ç­‹äº¤ã„/ãƒ–ãƒ¬ãƒ¼ã‚¹)
    addedBraces[id].forEach(b => {
        let braceInfo = BRACE_DATA[b.name];
        if(braceInfo && braceInfo.data) {
            braceInfo.data.forEach(d => allRads.add(d.r));
        }
    });
    
    // Sort radians
    let sortedRads = Array.from(allRads).sort((a,b) => a - b);
    
    // éšé«˜ã‚’å–å¾—ï¼ˆradã‹ã‚‰dã¸ã®å¤‰æ›ç”¨ï¼‰
    let floor = id.includes('2') ? '2' : '1';
    let h = parseFloat(document.getElementById('inp_H'+floor).value) || 3.0;
    
    // 2. Calculate Sum Q and weighted heq at each radian
    // heq_story = Î£(heq_i * Q_i) / Î£Q_i
    let composite = sortedRads.map(rad => {
        let totalQ = 0;
        let sumHeqQ = 0; // heq_i * Q_i ã®åˆè¨ˆ
        let d = rad * h; // å¤‰ä½ (m)
        
        // --- Free Input items ã®å‡¦ç† ---
        freeInputData[id].forEach(item => {
            if(item.data.length > 0) {
                const qty = item.qty || 1;
                let q_elem = interpRadQ(item.data, rad) * qty;
                
                // heqãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const hasInputHeq = item.data.some(p => p.heq !== undefined && p.heq !== null);
                
                let heq_elem;
                if(hasInputHeq) {
                    // å…¥åŠ›ã•ã‚ŒãŸheqã‚’è£œé–“ã—ã¦å–å¾—
                    heq_elem = interpRadHeq(item.data, rad);
                } else {
                    // å¾“æ¥é€šã‚Šã®è¨ˆç®—æ–¹æ³•: heq = (d - Q/K0) / d * 2 / (4Ï€)
                    // è‡ªç”±å…¥åŠ›ã®åˆæœŸå‰›æ€§ K0
                    let K0_free = (item.data[0].r > 0) ? item.data[0].q / (item.data[0].r * h) : 10000;
                    let q_single = q_elem / qty; // 1è¦ç´ ã‚ãŸã‚Šã®Q
                    
                    if (d > 0 && K0_free > 0) {
                        let elasticDef = q_single / K0_free; // å¼¾æ€§å¤‰å½¢
                        heq_elem = (d - elasticDef) / d * 2 / (4 * Math.PI);
                        if (heq_elem < 0) heq_elem = 0;
                    } else {
                        heq_elem = 0;
                    }
                }
                
                totalQ += q_elem;
                sumHeqQ += heq_elem * q_elem;
            }
        });
        
        // --- Standard Wall items ã®å‡¦ç† (ä¿®æ­£ç‰ˆ: heqå¯¾å¿œ) ---
        addedWalls[id].forEach(w => {
            let data = WALL_DATA[w.name];
            if(data) {
                let q_elem = interpRadQ(data, rad) * w.qty;
                
                // ãƒ‡ãƒ¼ã‚¿å†…ã«æœ‰åŠ¹ãª heq ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const hasExplicitHeq = data.some(p => p.heq !== undefined && p.heq !== null);
                
                let heq_elem = 0;

                if (hasExplicitHeq) {
                    // ã€A: heqæŒ‡å®šã‚ã‚Šã€‘CSVã®å€¤ã‚’è£œé–“ã—ã¦ä½¿ç”¨
                    // è‡ªç”±å…¥åŠ›ã¨åŒã˜ interpRadHeq é–¢æ•°ã‚’åˆ©ç”¨
                    heq_elem = interpRadHeq(data, rad);

                } else {
                    // ã€B: heqæŒ‡å®šãªã—ã€‘å¾“æ¥é€šã‚Šã®å‰›æ€§ä½ä¸‹ç‡ã«ã‚ˆã‚‹è‡ªå‹•è¨ˆç®—
                    let q_single = q_elem / w.qty; // 1è¦ç´ ã‚ãŸã‚Šã®Q
                    
                    // å£è¦ç´ ã®åˆæœŸå‰›æ€§ K0 (å¤‰ä½ãƒ™ãƒ¼ã‚¹: kN/m)
                    let K0_wall_rad = WALL_K0[w.name] || 10000;
                    let K0_wall = K0_wall_rad / h; // å¤‰ä½ãƒ™ãƒ¼ã‚¹ã«å¤‰æ›
                    
                    // heq = (d - Q/K0) / d * 2 / (4Ï€)
                    if (d > 0 && K0_wall > 0) {
                        let elasticDef = q_single / K0_wall; // å¼¾æ€§å¤‰å½¢
                        heq_elem = (d - elasticDef) / d * 2 / (4 * Math.PI);
                        if (heq_elem < 0) heq_elem = 0;
                    }
                }
                
                totalQ += q_elem;
                sumHeqQ += heq_elem * q_elem;
            }
        });
        
        // --- Brace items ã®å‡¦ç† (ç­‹äº¤ã„/ãƒ–ãƒ¬ãƒ¼ã‚¹) ---
        addedBraces[id].forEach(b => {
            let braceInfo = BRACE_DATA[b.name];
            if(braceInfo && braceInfo.data) {
                // cosÎ¸è£œæ­£ã‚’é©ç”¨ã—ãŸè€åŠ›
                let q_base = interpRadQ(braceInfo.data, rad);
                let q_elem = q_base * b.correctionFactor * b.qty;
                
                // ãƒ‡ãƒ¼ã‚¿å†…ã«æœ‰åŠ¹ãª heq ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const hasExplicitHeq = braceInfo.data.some(p => p.heq !== undefined && p.heq !== null);
                
                let heq_elem = 0;

                if (hasExplicitHeq) {
                    // heqæŒ‡å®šã‚ã‚Šï¼šCSVã®å€¤ã‚’è£œé–“ã—ã¦ä½¿ç”¨
                    heq_elem = interpRadHeq(braceInfo.data, rad);
                } else {
                    // heqæŒ‡å®šãªã—ï¼šå¾“æ¥é€šã‚Šã®å‰›æ€§ä½ä¸‹ç‡ã«ã‚ˆã‚‹è‡ªå‹•è¨ˆç®—
                    let q_single = q_elem / b.qty; // 1ç®‡æ‰€ã‚ãŸã‚Šã®Q
                    
                    // ãƒ–ãƒ¬ãƒ¼ã‚¹ã®åˆæœŸå‰›æ€§ K0 (å¤‰ä½ãƒ™ãƒ¼ã‚¹: kN/m)
                    let K0_brace_rad = BRACE_K0[b.name] || 10000;
                    // cosÎ¸è£œæ­£ã‚’åˆæœŸå‰›æ€§ã«ã‚‚é©ç”¨
                    K0_brace_rad = K0_brace_rad * b.correctionFactor;
                    let K0_brace = K0_brace_rad / h; // å¤‰ä½ãƒ™ãƒ¼ã‚¹ã«å¤‰æ›
                    
                    // heq = (d - Q/K0) / d * 2 / (4Ï€)
                    if (d > 0 && K0_brace > 0) {
                        let elasticDef = q_single / K0_brace; // å¼¾æ€§å¤‰å½¢
                        heq_elem = (d - elasticDef) / d * 2 / (4 * Math.PI);
                        if (heq_elem < 0) heq_elem = 0;
                    }
                }
                
                totalQ += q_elem;
                sumHeqQ += heq_elem * q_elem;
            }
        });
        
        // éšå…¨ä½“ã®åŠ é‡å¹³å‡ heq
        let heq_story = (totalQ > 0) ? sumHeqQ / totalQ : 0;
        
        return { r: rad, q: totalQ, heq: heq_story };
    });
    
    return composite;
}

function interpRadQ(data, r) {
    // data must be sorted by r
    // ensure data has origin if needed, or assume linear from 0
    if(data.length === 0) return 0;
    
    // sort data just in case
    data.sort((a,b) => a.r - b.r);
    
    if(r <= 0) return 0;
    if(r <= data[0].r) {
        // Interpolate from 0
        return (data[0].q / data[0].r) * r;
    }
    if(r >= data[data.length-1].r) {
        // Extrapolate slope of last segment or flat?
        // Usually degrading, let's extend last slope
        let last = data[data.length-1];
        let prev = data[data.length-2] || {r:0, q:0};
        let slope = (last.q - prev.q) / (last.r - prev.r);
        return last.q + (r - last.r) * slope;
    }
    
    for(let i=0; i<data.length-1; i++) {
        if(r >= data[i].r && r <= data[i+1].r) {
            let ratio = (r - data[i].r) / (data[i+1].r - data[i].r);
            return data[i].q + ratio * (data[i+1].q - data[i].q);
        }
    }
    return 0;
}

// è‡ªç”±å…¥åŠ›ã®heqã‚’è£œé–“å–å¾—
function interpRadHeq(data, r) {
    if(data.length === 0) return 0;
    
    // heqãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆã®ã¿ã‚’æŠ½å‡º
    let heqData = data.filter(p => p.heq !== undefined && p.heq !== null);
    if(heqData.length === 0) return 0;
    
    heqData.sort((a,b) => a.r - b.r);
    
    if(r <= 0) return heqData[0].heq || 0;
    if(r <= heqData[0].r) {
        // æœ€åˆã®heqå€¤ã‚’ä½¿ç”¨
        return heqData[0].heq || 0;
    }
    if(r >= heqData[heqData.length-1].r) {
        // æœ€å¾Œã®heqå€¤ã‚’ä½¿ç”¨
        return heqData[heqData.length-1].heq || 0;
    }
    
    for(let i=0; i<heqData.length-1; i++) {
        if(r >= heqData[i].r && r <= heqData[i+1].r) {
            let ratio = (r - heqData[i].r) / (heqData[i+1].r - heqData[i].r);
            let heq1 = heqData[i].heq || 0;
            let heq2 = heqData[i+1].heq || 0;
            return heq1 + ratio * (heq2 - heq1);
        }
    }
    return 0;
}

// --- Modified Input Graphs ---
function updateInputGraph(id) {
    // Calculate composite data
    let compositeData = getCompositeForce(id);
    
    // Use deformation angle (rad) for X-axis
    let chartData = compositeData.map(p => ({ x: p.r, y: p.q }));

    if (!inputChartObjs[id]) {
        const ctx = document.getElementById(`chart-in-${id}`);
        if(ctx) {
            inputChartObjs[id] = new Chart(ctx.getContext('2d'), {
                type: 'scatter',
                data: { datasets: [{ label: 'Total Q-Î´', data: chartData, borderColor: '#005a9c', showLine: true, borderWidth: 2 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { x: { title: {display:true, text:'å¤‰å½¢è§’(rad)'}, min:0 }, y: { title: {display:true, text:'Q(kN)'}, min:0 } },
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => `(${c.parsed.x.toFixed(4)}rad, ${c.parsed.y.toFixed(1)}kN)` } } }
                }
            });
        }
    } else {
        inputChartObjs[id].data.datasets[0].data = chartData;
        inputChartObjs[id].update();
    }
}

function toggleStories() {
    const s = document.getElementById('inp_Stories').value;
    const els = document.querySelectorAll('.story-2-only');
    els.forEach(e => {
        e.style.display = (s === '1') ? 'none' : 'block';
        if(e.tagName === 'TD' || e.tagName === 'TH') {
             e.style.display = (s === '1') ? 'none' : 'table-cell';
        }
    });
    // éšæ•°å¤‰æ›´æ™‚ã«pä¿‚æ•°ã‚°ãƒ©ãƒ•ã‚‚æ›´æ–°
    if(document.getElementById('inp_pq').value === 'yes') {
        updatePChart();
    }
}

function toggleSkipY() {
    const skip = document.getElementById('chk-skip-y').checked;
    document.getElementById('force-y-input-area').style.display = skip ? 'none' : 'block';
}

// p,qå…¥åŠ›åˆ‡æ›¿
function togglePqInput() {
    const pqMode = document.getElementById('inp_pq').value;
    document.getElementById('pq-chart-area').style.display = (pqMode === 'yes') ? 'block' : 'none';
    document.getElementById('pq-desc').style.display = (pqMode === 'yes') ? 'block' : 'none';
    if(pqMode === 'yes') {
        updatePChart();
    }
}

// pä¿‚æ•°ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
let chartP = null;
function updatePChart(canvasId = 'chart-p') {
    const canvas = document.getElementById(canvasId);
    if(!canvas) return null;
    
    const stories = parseInt(document.getElementById('inp_Stories').value);
    
    // pä¿‚æ•°ã®ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆ2éšå»ºã¦ã¨å¹³å±‹ã§ç•°ãªã‚‹ï¼‰
    let data1F = []; // å¹³å±‹ç”¨
    let data2F = []; // 2éšå»ºã¦ç”¨
    
    for(let Te = 0; Te <= 0.5; Te += 0.01) {
        // 2éšå»ºã¦
        let p2;
        if(Te <= 0.16) p2 = 1.0 - (0.15/0.16) * Te;
        else p2 = 0.85;
        if(p2 < 0.7) p2 = 0.7;
        data2F.push({ x: Te, y: p2 });
        
        // å¹³å±‹
        let p1;
        if(Te <= 0.16) p1 = 1.0 - (0.20/0.16) * Te;
        else p1 = 0.80;
        if(p1 < 0.7) p1 = 0.7;
        data1F.push({ x: Te, y: p1 });
    }
    
    const datasets = [];
    if(stories === 2) {
        datasets.push({
            label: 'p (2éšå»ºã¦)',
            data: data2F,
            borderColor: '#005a9c',
            backgroundColor: '#005a9c',
            borderWidth: 2,
            showLine: true,
            pointRadius: 0,
            fill: false
        });
    } else {
        datasets.push({
            label: 'p (å¹³å±‹)',
            data: data1F,
            borderColor: '#dc3545',
            backgroundColor: '#dc3545',
            borderWidth: 2,
            showLine: true,
            pointRadius: 0,
            fill: false
        });
    }
    
    // æ—¢å­˜ã®ã‚°ãƒ©ãƒ•ãŒã‚ã‚Œã°ç ´æ£„
    if(canvasId === 'chart-p' && chartP) {
        chartP.destroy();
    }
    
    const newChart = new Chart(canvas.getContext('2d'), {
        type: 'scatter',
        data: { datasets: datasets },
        options: {
            animation: false,
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { type: 'linear', position: 'bottom', title: { display: true, text: 'Te (s)', font: { size: 10 } }, min: 0, max: 0.5 },
                y: { title: { display: true, text: 'p', font: { size: 10 } }, min: 0.6, max: 1.05 }
            },
            plugins: {
                legend: { display: true, position: 'top', labels: { font: { size: 9 } } }
            }
        }
    });
    
    if(canvasId === 'chart-p') {
        chartP = newChart;
    }
    
    return newChart;
}

// å¿œç­”ã‚¹ãƒšã‚¯ãƒˆãƒ«Sa0ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
let chartSa0 = null;
function updateSa0Chart(canvasId = 'chart-sa0') {
    const canvas = document.getElementById(canvasId);
    if(!canvas) return null;
    
    const saMode = document.getElementById('inp_Sa_mode')?.value || 'standard';
    
    // æ—¢å­˜ã®ã‚°ãƒ©ãƒ•ãŒã‚ã‚Œã°ç ´æ£„
    if(canvasId === 'chart-sa0' && chartSa0) {
        chartSa0.destroy();
    }
    
    let datasets = [];
    
    if(saMode === 'custom') {
        // è‡ªç”±å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ - æå‚·é™ç•Œã¨å®‰å…¨é™ç•Œã‚’åˆ¥ã€…ã«è¡¨ç¤º
        
        // å®‰å…¨é™ç•Œç”¨ï¼ˆè‡ªç”±å…¥åŠ›ãŒã‚ã‚Œã°ãã‚Œã€ãªã‘ã‚Œã°å‘Šç¤ºå€¤ï¼‰
        if(saDataS.length > 0) {
            const dataS = saDataS.map(d => ({ x: d.t, y: d.sa }));
            datasets.push({
                label: 'Sa (å®‰å…¨é™ç•Œãƒ»è‡ªç”±å…¥åŠ›)',
                data: dataS,
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220,53,69,0.1)',
                borderWidth: 2,
                showLine: true,
                pointRadius: 2,
                fill: true
            });
        } else {
            // å‘Šç¤ºå€¤ã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            let dataSafety = [];
            for(let T = 0; T <= 3.0; T += 0.02) {
                dataSafety.push({ x: T, y: getSao(T, 's') });
            }
            datasets.push({
                label: 'Sa0 (å®‰å…¨é™ç•Œãƒ»å‘Šç¤ºå€¤)',
                data: dataSafety,
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220,53,69,0.05)',
                borderWidth: 1.5,
                borderDash: [5, 3],
                showLine: true,
                pointRadius: 0,
                fill: true
            });
        }
        
        // æå‚·é™ç•Œç”¨ï¼ˆè‡ªç”±å…¥åŠ›ãŒã‚ã‚Œã°ãã‚Œã€ãªã‘ã‚Œã°å‘Šç¤ºå€¤ï¼‰
        if(saDataD.length > 0) {
            const dataD = saDataD.map(d => ({ x: d.t, y: d.sa }));
            datasets.push({
                label: 'Sa (æå‚·é™ç•Œãƒ»è‡ªç”±å…¥åŠ›)',
                data: dataD,
                borderColor: '#28a745',
                backgroundColor: 'rgba(40,167,69,0.1)',
                borderWidth: 2,
                showLine: true,
                pointRadius: 2,
                fill: true
            });
        } else {
            // å‘Šç¤ºå€¤ã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            let dataDamage = [];
            for(let T = 0; T <= 3.0; T += 0.02) {
                dataDamage.push({ x: T, y: getSao(T, 'd') });
            }
            datasets.push({
                label: 'Sa0 (æå‚·é™ç•Œãƒ»å‘Šç¤ºå€¤)',
                data: dataDamage,
                borderColor: '#28a745',
                backgroundColor: 'rgba(40,167,69,0.05)',
                borderWidth: 1.5,
                borderDash: [5, 3],
                showLine: true,
                pointRadius: 0,
                fill: true
            });
        }
    } else {
        // æ¨™æº–ãƒ¢ãƒ¼ãƒ‰ï¼ˆå‘Šç¤ºæº–æ‹ ï¼‰
        let dataDamage = [];
        let dataSafety = [];
        
        for(let T = 0; T <= 3.0; T += 0.02) {
            const sa0d = getSao(T, 'd');
            const sa0s = getSao(T, 's');
            dataDamage.push({ x: T, y: sa0d });
            dataSafety.push({ x: T, y: sa0s });
        }
        
        datasets.push({
            label: 'Sa0 (å®‰å…¨é™ç•Œ)',
            data: dataSafety,
            borderColor: '#dc3545',
            backgroundColor: 'rgba(220,53,69,0.1)',
            borderWidth: 2,
            showLine: true,
            pointRadius: 0,
            fill: true
        });
        datasets.push({
            label: 'Sa0 (æå‚·é™ç•Œ)',
            data: dataDamage,
            borderColor: '#28a745',
            backgroundColor: 'rgba(40,167,69,0.1)',
            borderWidth: 2,
            showLine: true,
            pointRadius: 0,
            fill: true
        });
    }
    
    const newChart = new Chart(canvas.getContext('2d'), {
        type: 'scatter',
        data: { datasets: datasets },
        options: {
            animation: false,
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { type: 'linear', position: 'bottom', title: { display: true, text: 'T (s)', font: { size: 10 } }, min: 0, max: 3 },
                y: { title: { display: true, text: 'Sa (m/sÂ²)', font: { size: 10 } }, min: 0 }
            },
            plugins: {
                legend: { display: true, position: 'top', labels: { font: { size: 9 } } }
            }
        }
    });
    
    if(canvasId === 'chart-sa0') {
        chartSa0 = newChart;
    }
    
    return newChart;
}

// Saå…¥åŠ›ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
function toggleSaInput() {
    const mode = document.getElementById('inp_Sa_mode').value;
    document.getElementById('sa-standard-desc').style.display = (mode === 'standard') ? 'block' : 'none';
    document.getElementById('inp_Sa_custom_input').style.display = (mode === 'custom') ? 'block' : 'none';
    if(mode === 'custom') {
        renderSaDataList('d');
        renderSaDataList('s');
    }
    updateSa0Chart();
}

// Saã‚¹ãƒšã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿ä¸€è¦§ã‚’è¡¨ç¤º
function renderSaDataList(type) {
    const container = document.getElementById('sa-data-list-' + type);
    if(!container) return;
    
    const data = (type === 'd') ? saDataD : saDataS;
    
    if(data.length === 0) {
        container.innerHTML = '<span style="color:#999;">ãƒ‡ãƒ¼ã‚¿ãªã—</span>';
        return;
    }
    let html = '<table style="width:100%; font-size:0.9em;"><thead><tr><th>T(s)</th><th>Sa</th></tr></thead><tbody>';
    data.forEach(d => {
        html += `<tr><td>${d.t.toFixed(3)}</td><td>${d.sa.toFixed(3)}</td></tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
}

// Saã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã
function openSaSpreadsheet(type) {
    currentSaType = type;
    document.getElementById('sa-modal').style.display = 'flex';
    document.getElementById('sa-modal-type').innerText = (type === 'd') ? 'ï¼ˆæå‚·é™ç•Œç”¨ï¼‰' : 'ï¼ˆå®‰å…¨é™ç•Œç”¨ï¼‰';
    
    let data = [];
    const srcData = (type === 'd') ? saDataD : saDataS;
    if(srcData.length > 0) {
        srcData.forEach(d => data.push([d.t, d.sa]));
    }
    while(data.length < 50) data.push([null, null]);
    
    if(hotSa) hotSa.destroy();
    hotSa = new Handsontable(document.getElementById('sa-spreadsheet-container'), {
        data: data,
        colHeaders: ['T (s)', 'Sa (m/sÂ²)'],
        columns: [{ type: 'numeric' }, { type: 'numeric' }],
        rowHeaders: true,
        contextMenu: true,
        width: '100%',
        height: '100%',
        licenseKey: 'non-commercial-and-evaluation'
    });
}

// Saã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‰ã˜ã‚‹
function closeSaSpreadsheet() {
    document.getElementById('sa-modal').style.display = 'none';
}

// Saãƒ‡ãƒ¼ã‚¿ã‚’åæ˜ 
function applySaData() {
    if(!hotSa) return;
    
    const raw = hotSa.getData();
    let newData = [];
    
    raw.forEach(row => {
        const t = parseFloat(row[0]);
        const sa = parseFloat(row[1]);
        if(!isNaN(t) && !isNaN(sa) && t >= 0 && sa >= 0) {
            newData.push({ t: t, sa: sa });
        }
    });
    
    // Tã§ã‚½ãƒ¼ãƒˆ
    newData.sort((a, b) => a.t - b.t);
    
    // å¯¾è±¡ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
    if(currentSaType === 'd') {
        saDataD = newData;
    } else {
        saDataS = newData;
    }
    
    renderSaDataList(currentSaType);
    updateSa0Chart();
    closeSaSpreadsheet();
}

// Saãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
function clearSaData(type) {
    const label = (type === 'd') ? 'æå‚·é™ç•Œç”¨' : 'å®‰å…¨é™ç•Œç”¨';
    if(confirm(label + 'Saã‚¹ãƒšã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
        if(type === 'd') {
            saDataD = [];
        } else {
            saDataS = [];
        }
        renderSaDataList(type);
        updateSa0Chart();
    }
}

function switchTab(t) {
    document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
    document.querySelectorAll('.tab-link').forEach(e => e.classList.remove('active'));
    document.getElementById('tab-'+t).classList.add('active');
    document.querySelector(`.tab-link[onclick="switchTab('${t}')"]`).classList.add('active');
}

function toggleTcInput() {
    let v = document.getElementById('inp_Tc_mode').value;
    document.getElementById('inp_Tc_custom_input').style.display = (v === 'custom') ? 'block' : 'none';
    if(v === 'custom') {
        renderGsDataList();
    }
    updateGsChart();
}

// ã‚°ãƒ©ãƒ•è¡¨ç¤ºç”¨ã®Gsè¨ˆç®—ï¼ˆgetGsé–¢æ•°ã¨ã¯åˆ¥ã«ã€å»ºç‰©ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãªã—ã§ä½¿ç”¨ï¼‰
function getGsForChart(tcMode, T) {
    let Gs = 1.5;
    if (tcMode === '1') { 
        if (T < 0.576) Gs = 1.5;
        else if (T < 0.64) Gs = 0.864 / T;
        else Gs = 1.35;
    } else if (tcMode === '3') {
        const T2_3 = 0.64 * 2.7 / 1.5; 
        if (T < 0.64) Gs = 1.5;
        else if (T < T2_3) Gs = 1.5 * T / 0.64;
        else Gs = 2.7;
    } else {
        // ç¬¬2ç¨®ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
        const T2_2 = 0.64 * 2.025 / 1.5; 
        if (T < 0.64) Gs = 1.5;
        else if (T < T2_2) Gs = 1.5 * T / 0.64;
        else Gs = 2.025;
    }
    return Gs;
}

// Gsã‚¹ãƒšã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿ä¸€è¦§ã‚’è¡¨ç¤º
function renderGsDataList() {
    const container = document.getElementById('gs-data-list');
    if(gsData.length === 0) {
        container.innerHTML = '<span style="color:#999;">ãƒ‡ãƒ¼ã‚¿ãªã—ï¼ˆExcelè²¼ä»˜ã§å…¥åŠ›ï¼‰</span>';
        return;
    }
    let html = '<table style="width:100%; font-size:0.9em;"><thead><tr><th>T(s)</th><th>Gs</th></tr></thead><tbody>';
    gsData.forEach(d => {
        html += `<tr><td>${d.t.toFixed(3)}</td><td>${d.g.toFixed(3)}</td></tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
}

// Gsã‚¹ãƒšã‚¯ãƒˆãƒ«ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
function updateGsChart() {
    const canvas = document.getElementById('chart-gs');
    if(!canvas) return;
    
    if(chartGs) chartGs.destroy();
    
    const tcMode = document.getElementById('inp_Tc_mode').value;
    let data = [];
    let label = 'Gs';
    
    if(tcMode === 'custom') {
        // è‡ªç”±å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰
        if(gsData.length === 0) {
            chartGs = null;
            return;
        }
        data = gsData.map(d => ({ x: d.t, y: d.g }));
        label = 'Gs (è‡ªç”±å…¥åŠ›)';
    } else {
        // ç¬¬1ï½3ç¨®ã®æ¨™æº–ã‚¹ãƒšã‚¯ãƒˆãƒ«ç”Ÿæˆ
        const mockBldg = { tcMode: tcMode, gsPts: [] };
        const typeNames = { '1': 'ç¬¬1ç¨®', '2': 'ç¬¬2ç¨®', '3': 'ç¬¬3ç¨®' };
        label = 'Gs (' + typeNames[tcMode] + ')';
        
        // T=0ã‹ã‚‰3ç§’ã¾ã§ã®ã‚¹ãƒšã‚¯ãƒˆãƒ«ç‚¹ã‚’ç”Ÿæˆ
        const tValues = [0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.576, 0.6, 0.64, 0.7, 0.8, 0.864, 0.9, 1.0, 1.152, 1.2, 1.5, 2.0, 2.5, 3.0];
        tValues.forEach(t => {
            const gs = getGsForChart(tcMode, t);
            data.push({ x: t, y: gs });
        });
        // é‡è¤‡é™¤å»ã¨ã‚½ãƒ¼ãƒˆ
        data.sort((a, b) => a.x - b.x);
    }
    
    chartGs = new Chart(canvas.getContext('2d'), {
        type: 'scatter',
        data: {
            datasets: [{
                label: label,
                data: data,
                borderColor: '#005a9c',
                backgroundColor: '#005a9c',
                borderWidth: 2,
                showLine: true,
                pointRadius: 2,
                fill: false
            }]
        },
        options: {
            animation: false,
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { type: 'linear', position: 'bottom', title: { display: true, text: 'T (s)', font: { size: 10 } }, min: 0 },
                y: { title: { display: true, text: 'Gs', font: { size: 10 } }, min: 0 }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });
}

// Gsã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã
function openGsSpreadsheet() {
    document.getElementById('gs-modal').style.display = 'flex';
    
    let data = [];
    // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°èª­ã¿è¾¼ã¿
    if(gsData.length > 0) {
        gsData.forEach(d => data.push([d.t, d.g]));
    }
    // 50è¡Œã¾ã§æ‹¡å¼µ
    while(data.length < 50) data.push([null, null]);
    
    if(hotGs) hotGs.destroy();
    hotGs = new Handsontable(document.getElementById('gs-spreadsheet-container'), {
        data: data,
        colHeaders: ['T (s)', 'Gs'],
        columns: [{ type: 'numeric' }, { type: 'numeric' }],
        rowHeaders: true,
        contextMenu: true,
        width: '100%',
        height: '100%',
        licenseKey: 'non-commercial-and-evaluation'
    });
}

// Gsã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‰ã˜ã‚‹
function closeGsSpreadsheet() {
    document.getElementById('gs-modal').style.display = 'none';
}

// Gsãƒ‡ãƒ¼ã‚¿ã‚’åæ˜ 
function applyGsData() {
    if(!hotGs) return;
    
    const raw = hotGs.getData();
    gsData = [];
    
    raw.forEach(row => {
        const t = parseFloat(row[0]);
        const g = parseFloat(row[1]);
        if(!isNaN(t) && !isNaN(g) && t >= 0 && g >= 0) {
            gsData.push({ t: t, g: g });
        }
    });
    
    // Tã§ã‚½ãƒ¼ãƒˆ
    gsData.sort((a, b) => a.t - b.t);
    
    renderGsDataList();
    updateGsChart();
    closeGsSpreadsheet();
}

// Gsãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
function clearGsData() {
    if(confirm('Gsã‚¹ãƒšã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
        gsData = [];
        renderGsDataList();
        updateGsChart();
    }
}

function addRow(id, n='', q='') {
    let floor = id.includes('2') ? '2' : '1';
    let h = parseFloat(document.getElementById('inp_H'+floor).value) || 3.0;
    let mm = (n && n!=0) ? (h*1000/n).toFixed(2) : '';
    
    // Trigger updateInputGraph on input
    const trigger = `oninput="updateInputGraph('${id}')"`;
    const syncD = `oninput="syncDisp(this); updateInputGraph('${id}')"`;
    const syncN = `oninput="syncInvN(this); updateInputGraph('${id}')"`;

    document.querySelector(`#table-${id} tbody`).insertAdjacentHTML('beforeend', 
        `<tr data-floor="${floor}">
            <td>1/<input type="number" class="inp-invN" value="${n}" ${syncD} placeholder="120"></td>
            <td><input type="number" class="inp-disp" value="${mm}" ${syncN}></td>
            <td><input type="number" class="inp-force" value="${q}" ${trigger}></td>
            <td><button class="btn-sm" onclick="this.closest('tr').remove(); updateInputGraph('${id}')" style="color:red;">Ã—</button></td>
        </tr>`);
}

function syncDisp(e) {
    let r = e.closest('tr'), h = parseFloat(document.getElementById('inp_H'+r.dataset.floor).value);
    let n = parseFloat(e.value);
    if(n > 0 && h > 0) r.querySelector('.inp-disp').value = (h*1000/n).toFixed(2);
}
function syncInvN(e) {
    let r = e.closest('tr'), h = parseFloat(document.getElementById('inp_H'+r.dataset.floor).value);
    let d = parseFloat(e.value);
    if(d > 0 && h > 0) r.querySelector('.inp-invN').value = (h*1000/d).toFixed(1);
}
function showLog(d) {
    document.getElementById('log-container-x').style.display = d==='x'?'block':'none';
    document.getElementById('log-container-y').style.display = d==='y'?'block':'none';
}

function openSpreadsheet(id) {
    // â–¼â–¼â–¼ è¿½åŠ éƒ¨åˆ†: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãŒã‚ã‚Œã°å‰Šé™¤ â–¼â–¼â–¼
    checkAndRemoveDefault(id);
    // â–²â–²â–² è¿½åŠ éƒ¨åˆ†ã“ã“ã¾ã§ â–²â–²â–²

    // æ–°è¦è‡ªç”±å…¥åŠ›é …ç›®ã‚’ä½œæˆã—ã¦ã‹ã‚‰ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚‹
    const nameInput = document.getElementById(`free-name-${id}`);
    const qtyInput = document.getElementById(`free-qty-${id}`);
    const name = nameInput.value.trim() || `è‡ªç”±å…¥åŠ›${freeInputData[id].length + 1}`;
    const qty = parseFloat(qtyInput.value) || 1;
    
    if(qty <= 0) {
        alert('æ•°é‡ã¯0ã‚ˆã‚Šå¤§ãã„å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
    }
    
    // æ–°è¦é …ç›®ã‚’è¿½åŠ 
    freeInputData[id].push({ name: name, qty: qty, data: [] });
    const newIdx = freeInputData[id].length - 1;
    
    // é …ç›®åå…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
    nameInput.value = '';
    qtyInput.value = '1';
    
    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’è¨­å®š
    currentEditingFreeItem = { id: id, idx: newIdx };
    
    const qtyStr = qty !== 1 ? ` (Ã—${qty})` : '';
    document.getElementById('sheet-target-name').innerText = `${id.toUpperCase()} - ${name}${qtyStr}`;
    document.getElementById('sheet-modal').style.display = 'flex';
    
    // heqãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('heq-input-checkbox').checked = false;
    
    let data = [];
    for(let i=0; i<100; i++) data.push([null, null]);
    if(hot) hot.destroy();
    hot = new Handsontable(document.getElementById('spreadsheet-container'), {
        data: data, colHeaders: ['å¤‰å½¢è§’(1/N) or rad', 'Q(kN)'], columns: [{}, { type: 'numeric' }],
        rowHeaders: true, contextMenu: true, width: '100%', height: '100%', licenseKey: 'non-commercial-and-evaluation'
    });
}
function closeSpreadsheet(){ 
    document.getElementById('sheet-modal').style.display = 'none'; 
    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã«ãƒ‡ãƒ¼ã‚¿ãŒç©ºã®é …ç›®ã¯å‰Šé™¤
    if(currentEditingFreeItem) {
        const { id, idx } = currentEditingFreeItem;
        if(freeInputData[id][idx] && freeInputData[id][idx].data.length === 0) {
            freeInputData[id].splice(idx, 1);
            renderFreeInputList(id);
        }
        currentEditingFreeItem = null;
    }
}

// heqãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹åˆ‡ã‚Šæ›¿ãˆæ™‚ã«ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®åˆ—ã‚’å¤‰æ›´
function toggleHeqColumn() {
    if(!hot) return;
    const useHeq = document.getElementById('heq-input-checkbox').checked;
    const currentData = hot.getData();
    
    let newData;
    if(useHeq) {
        // 2åˆ—â†’3åˆ—ã«å¤‰æ›
        newData = currentData.map(row => {
            if(row.length === 2) {
                return [row[0], row[1], null];
            }
            return row;
        });
    } else {
        // 3åˆ—â†’2åˆ—ã«å¤‰æ›
        newData = currentData.map(row => {
            return [row[0], row[1]];
        });
    }
    
    // 100è¡Œã¾ã§æ‹¡å¼µ
    while(newData.length < 100) {
        newData.push(useHeq ? [null, null, null] : [null, null]);
    }
    
    hot.destroy();
    if(useHeq) {
        hot = new Handsontable(document.getElementById('spreadsheet-container'), {
            data: newData, colHeaders: ['å¤‰å½¢è§’(1/N) or rad', 'Q(kN)', 'heq'], 
            columns: [{}, { type: 'numeric' }, { type: 'numeric' }],
            rowHeaders: true, contextMenu: true, width: '100%', height: '100%', licenseKey: 'non-commercial-and-evaluation'
        });
    } else {
        hot = new Handsontable(document.getElementById('spreadsheet-container'), {
            data: newData, colHeaders: ['å¤‰å½¢è§’(1/N) or rad', 'Q(kN)'], 
            columns: [{}, { type: 'numeric' }],
            rowHeaders: true, contextMenu: true, width: '100%', height: '100%', licenseKey: 'non-commercial-and-evaluation'
        });
    }
}

function applySheetData(){
    if(!hot || !currentEditingFreeItem) return;
    const d = hot.getData();
    const { id, idx } = currentEditingFreeItem;
    const floor = id.includes('2') ? '2' : '1';
    const h = parseFloat(document.getElementById('inp_H'+floor).value) || 3.0;
    const useHeq = document.getElementById('heq-input-checkbox').checked;
    
    let newData = [];
    d.forEach(r => {
        let val = r[0], q = parseFloat(r[1]);
        let heq = useHeq ? parseFloat(r[2]) : undefined;
        
        if(val != null && !isNaN(q)) {
            let rad = 0;
            if(typeof val === 'string' && val.includes('/')) {
                let parts = val.split('/');
                if(parts.length==2) {
                    let n = parseFloat(parts[1]);
                    if(n > 0) rad = 1/n;
                }
            } else if(!isNaN(parseFloat(val))) {
                let v = parseFloat(val);
                if(v > 1) rad = 1/v; // 1/Nå½¢å¼
                else if(v > 0) rad = v; // radå½¢å¼
            }
            if(rad > 0) {
                let dataPoint = { r: rad, q: q };
                if(useHeq && !isNaN(heq)) {
                    dataPoint.heq = heq;
                }
                newData.push(dataPoint);
            }
        }
    });
    
    // ã‚½ãƒ¼ãƒˆã—ã¦é‡è¤‡ã‚’é™¤å»
    newData.sort((a,b) => a.r - b.r);
    
    freeInputData[id][idx].data = newData;
    renderFreeInputList(id);
    updateInputGraph(id);
    
    currentEditingFreeItem = null;
    document.getElementById('sheet-modal').style.display = 'none';
}

// --- Logic Helpers ---
function getBldg() {
    let stories = parseInt(document.getElementById('inp_Stories').value);
    let tcMode = document.getElementById('inp_Tc_mode').value;
    let gsPts = [];
    if(tcMode === 'custom') {
        // gsDataã‹ã‚‰å–å¾—
        gsPts = gsData.map(d => ({ t: d.t, g: d.g }));
        gsPts.sort((a,b) => a.t - b.t);
    }
    
    // Saãƒ¢ãƒ¼ãƒ‰
    let saMode = document.getElementById('inp_Sa_mode')?.value || 'standard';
    let saPtsD = []; // æå‚·é™ç•Œç”¨
    let saPtsS = []; // å®‰å…¨é™ç•Œç”¨
    if(saMode === 'custom') {
        saPtsD = saDataD.map(d => ({ t: d.t, sa: d.sa }));
        saPtsD.sort((a,b) => a.t - b.t);
        saPtsS = saDataS.map(d => ({ t: d.t, sa: d.sa }));
        saPtsS.sort((a,b) => a.t - b.t);
    }
    
    let b = {
        name: document.getElementById('inp_BuildingName').value,
        stories: stories,
        Z: parseFloat(document.getElementById('inp_Z').value),
        tcMode: tcMode, gsPts: gsPts,
        saMode: saMode, saPtsD: saPtsD, saPtsS: saPtsS,
        pqMode: document.getElementById('inp_pq').value,
        W1: parseFloat(document.getElementById('inp_W1').value),
        H1: parseFloat(document.getElementById('inp_H1').value)
    };
    
    if(stories === 2) {
        b.W2 = parseFloat(document.getElementById('inp_W2').value);
        b.H2 = parseFloat(document.getElementById('inp_H2').value);
    } else {
        b.W2 = 0; b.H2 = 0;
    }
    return b;
}

// NOTE: Returns composite curve with {d: meter, q: kN, heq: equivalent damping}
function getForce(id) {
    let composite = getCompositeForce(id);
    // Convert rad to displacement (m) for the engine
    let floor = id.includes('2') ? '2' : '1';
    let h = parseFloat(document.getElementById('inp_H'+floor).value) || 3.0;
    
    // heqæƒ…å ±ã‚‚å«ã‚ã¦å¤‰æ›
    let u = composite.map(p => ({ d: p.r * h, q: p.q, heq: p.heq || 0 }));
    
    // Ensure strict monotonicity for displacement and remove duplicates
    u.sort((a,b) => a.d - b.d);
    let cleanU = [];
    if(u.length > 0) cleanU.push(u[0]);
    for(let i=1; i<u.length; i++) {
        if(u[i].d > cleanU[cleanU.length-1].d + 1e-6) {
            cleanU.push(u[i]);
        }
    }
    if(cleanU.length === 0 || cleanU[0].d !== 0) {
        cleanU.unshift({d:0, q:0, heq:0});
    }

    return cleanU;
}

function interpQ(pts, d) {
    if(d <= 0) return 0;
    let n = pts.length;
    if(n===0) return 0;
    if(d >= pts[n-1].d) {
        let denom = pts[n-1].d - pts[n-2].d;
        let s = (denom !== 0) ? (pts[n-1].q - pts[n-2].q) / denom : 0;
        return pts[n-1].q + (d - pts[n-1].d) * s;
    }
    for(let i=0; i<n-1; i++) {
        if(d >= pts[i].d && d <= pts[i+1].d) {
            return pts[i].q + (d - pts[i].d) * (pts[i+1].q - pts[i].q) / (pts[i+1].d - pts[i].d);
        }
    }
    return 0;
}

// heq ã‚’è£œé–“å–å¾— (è¦ç´ ç´¯ç©æ–¹å¼ã§ç®—å‡ºæ¸ˆã¿ã®heqã‚’ä½¿ç”¨)
function interpHeq(pts, d) {
    if(d <= 0) return 0;
    let n = pts.length;
    if(n===0) return 0;
    if(d >= pts[n-1].d) {
        // ç¯„å›²å¤–ã¯æœ€å¾Œã®ç‚¹ã®heqã‚’ä½¿ç”¨
        return pts[n-1].heq || 0;
    }
    for(let i=0; i<n-1; i++) {
        if(d >= pts[i].d && d <= pts[i+1].d) {
            let ratio = (pts[i+1].d - pts[i].d) > 0 ? 
                        (d - pts[i].d) / (pts[i+1].d - pts[i].d) : 0;
            let heq1 = pts[i].heq || 0;
            let heq2 = pts[i+1].heq || 0;
            return heq1 + ratio * (heq2 - heq1);
        }
    }
    return 0;
}

function getSao(T, type) {
    if (type === 'd') {
        if (T < 0.16) return 0.64 + 6.0 * T;
        if (T < 0.64) return 1.6;
        return 1.024 / T;
    } else {
        if (T < 0.16) return 3.2 + 30.0 * T; 
        if (T < 0.64) return 8.0;
        return 5.12 / T;
    }
}

// è‡ªç”±å…¥åŠ›Saã‚¹ãƒšã‚¯ãƒˆãƒ«ã‹ã‚‰è£œé–“å–å¾—ï¼ˆæå‚·é™ç•Œ/å®‰å…¨é™ç•Œåˆ¥ï¼‰
function getSaCustom(pts, T) {
    if(!pts || pts.length === 0) return null; // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯nullã‚’è¿”ã™
    if(T <= pts[0].t) return pts[0].sa;
    if(T >= pts[pts.length-1].t) return pts[pts.length-1].sa;
    for(let i=0; i<pts.length-1; i++) {
        if(T >= pts[i].t && T <= pts[i+1].t) {
            const ratio = (pts[i+1].t - pts[i].t) > 0 ? (T - pts[i].t) / (pts[i+1].t - pts[i].t) : 0;
            return pts[i].sa + ratio * (pts[i+1].sa - pts[i].sa);
        }
    }
    return null;
}

function getGs(b, T) {
    if(b.tcMode === 'custom') {
        let pts = b.gsPts;
        if(pts.length === 0) return 2.5; 
        if(T <= pts[0].t) return pts[0].g;
        if(T >= pts[pts.length-1].t) return pts[pts.length-1].g;
        for(let i=0; i<pts.length-1; i++) {
            if(T >= pts[i].t && T <= pts[i+1].t) {
                return pts[i].g + (pts[i+1].g - pts[i].g) * (T - pts[i].t) / (pts[i+1].t - pts[i].t);
            }
        }
        return 2.5;
    }
    let Gs = 1.5;
    if (b.tcMode === '1') { 
        if (T < 0.576) Gs = 1.5;
        else if (T < 0.64) Gs = 0.864 / T;
        else Gs = 1.35;
    } else if (b.tcMode === '3') {
        const T2_3 = 0.64 * 2.7 / 1.5; 
        if (T < 0.64) Gs = 1.5;
        else if (T < T2_3) Gs = 1.5 * T / 0.64;
        else Gs = 2.7;
    } else {
        const T2_2 = 0.64 * 2.025 / 1.5; 
        if (T < 0.64) Gs = 1.5;
        else if (T < T2_2) Gs = 1.5 * T / 0.64;
        else Gs = 2.025;
    }
    return Gs;
}

function checkDiscriminant(b, f1, f2, limitD) {
    if(b.stories === 1) return { lhs:0, rhs:0, isSafe:true }; 
    const limitR = 1/limitD;
    const Qd1 = interpQ(f1, limitR * b.H1);
    const Qd2 = interpQ(f2, limitR * b.H2);
    const H_ratio = b.H2 / b.H1;
    const W_ratio = b.W1 / b.W2; 
    const lhs = (Qd1 > 0) ? Qd2 / Qd1 : 0;
    const rhs = (1 + H_ratio) / (1 + H_ratio + W_ratio);
    const isSafe = lhs > rhs * 1.05;
    return { lhs, rhs, isSafe };
}

function calc(b, f1, f2) {
    const m1 = b.W1 / G_ACC;
    
    const getInitialStiffness = (pts) => {
        if(pts.length < 2) return 10000;
        let p0 = (pts[0].d === 0) ? pts[0] : {d:0, q:0};
        let p1 = (pts[0].d === 0) ? pts[1] : pts[0]; 
        if(!p1 || p1.d === 0) return 10000;
        return (p1.q - p0.q) / (p1.d - p0.d);
    };
    const K10 = getInitialStiffness(f1);

    let steps = [];
    const maxR = 0.1;
    const rStep = 0.0001;

    let m2 = 0, K20 = 0;
    if(b.stories === 2) {
        m2 = b.W2 / G_ACC;
        K20 = getInitialStiffness(f2);
    }

    const calcEigen = (k1, k2) => {
        if(b.stories === 1) {
            const T = (k1 > 0) ? 2 * Math.PI * Math.sqrt(m1 / k1) : 0;
            return { w2: 0, T: T, u2: 0 };
        }
        if(k1 < 1) k1 = 1;
        if(k2 < 1) k2 = 1;
        const A = m1 * m2;
        const B = - (m1 * k2 + m2 * k1 + m2 * k2);
        const C = k1 * k2;
        const det = B*B - 4*A*C;
        if(det < 0) return { w2: 0, T: 0, u2: 1.0 }; 
        const w2 = (-B - Math.sqrt(det)) / (2*A); 
        const T = (w2 > 0) ? 2 * Math.PI / Math.sqrt(w2) : 0;
        let u2 = 1.0;
        if (k2 > 1e-4) u2 = (k1 + k2 - m1 * w2) / k2;
        return { w2, T, u2 };
    };

    const initEigen = calcEigen(K10, K20);
    const T0 = initEigen.T;
    let currentU2 = (b.stories === 2) ? initEigen.u2 : 0;

    for(let r = 0; r <= maxR; r += rStep) {
        let d1 = r * b.H1;       
        let Q1 = interpQ(f1, d1);
        let K1 = (d1 > 0) ? Q1 / d1 : K10;

        let d2 = 0, Q2 = 0, K2 = 0;
        if(b.stories === 2) {
            let u_ratio = (currentU2 > 1.0) ? currentU2 : 1.0;
            d2 = d1 * (u_ratio - 1.0); 
            Q2 = interpQ(f2, d2);
            K2 = (d2 > 0) ? Q2 / d2 : K20;
        }

        let eigen = calcEigen(K1, K2);
        let Te = eigen.T;
        if(Te < 0.01) Te = 0.01;

        if(b.stories === 2) currentU2 = eigen.u2;
        let u1 = 1.0;
        let u2 = eigen.u2; 

        let sum_m_u  = m1 * u1 + m2 * u2;
        let sum_m_u2 = m1 * u1**2 + m2 * u2**2;
        let sum_m_u_h = m1 * u1 * b.H1 + m2 * u2 * (b.H1 + b.H2);

        let Me = (sum_m_u2 > 0) ? (sum_m_u)**2 / sum_m_u2 : (m1 + m2);
        let beta_u = (sum_m_u > 0) ? sum_m_u2 / sum_m_u : 1.0;
        let Delta = beta_u * d1;
        let He = (sum_m_u > 0) ? sum_m_u_h / sum_m_u : b.H1;

        // ------------------------------------------------------------------
        // ã€ä¿®æ­£ã€‘æ¸›è¡°æ€§èƒ½ (æŒ‡å®šè¨ˆç®—å¼ã«ã‚ˆã‚‹heqç®—å‡º)
        // heq1 = (Î´z1 - Q1/K10) Ã— Q1 / Î´z1 / Q1 Ã— 2 / 4 / Ï€
        // heq2 = ((Î´z2-Î´z1) - Q2/K20) Ã— Q2 / (Î´z2-Î´z1) / Q2 Ã— 2 / 4 / Ï€
        // ------------------------------------------------------------------
        
        // --- 1. å„éšã®ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã‚¨ãƒãƒ«ã‚®ãƒ¼ (Wi) ç®—å‡º ---
        // WA (ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã‚¨ãƒãƒ«ã‚®ãƒ¼) = 1/2 * Q * Î´
        let wa1 = 0.5 * Q1 * d1;
        let wa2 = (b.stories === 2) ? 0.5 * Q2 * d2 : 0;
        let WA = wa1 + wa2; // å…¨ä½“ã®ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã‚¨ãƒãƒ«ã‚®ãƒ¼

        // --- 2. å„éšã®ç­‰ä¾¡æ¸›è¡°å®šæ•° (heq) ã‚’å–å¾— ---
        // getCompositeForce ã§è¨ˆç®—ã•ã‚ŒãŸåŠ é‡å¹³å‡heqã‚’ä½¿ç”¨
        // - heqãŒå…¥åŠ›ã•ã‚ŒãŸè¦ç´ : å…¥åŠ›å€¤ã‚’è£œé–“ã—ã¦ä½¿ç”¨
        // - heqãŒå…¥åŠ›ã•ã‚Œã¦ã„ãªã„è¦ç´ : heq = (d - Q/K0) / d * 2 / (4Ï€) ã§ç®—å‡º
        // ã“ã‚Œã‚‰ã‚’å„è¦ç´ ã®ã›ã‚“æ–­åŠ›Qã§åŠ é‡å¹³å‡ã—ãŸã‚‚ã®ãŒéšã®heqã¨ãªã‚‹
        let heq1 = interpHeq(f1, d1);
        
        let heq2 = 0;
        if (b.stories === 2 && d2 > 0) {
            heq2 = interpHeq(f2, d2);
        }

        // --- 3. Î”W (å±¥æ­´æ¸›è¡°ã‚¨ãƒãƒ«ã‚®ãƒ¼) ã®ç®—å‡º ---
        // Î”W = 4Ï€(heq1ï½¥W1 + heq2ï½¥W2)
        let dW = 4 * Math.PI * (heq1 * wa1 + heq2 * wa2);

        // --- 4. å…¨ä½“ã®ç­‰ä¾¡æ¸›è¡°å®šæ•° h ã®ç®—å‡º ---
        // å®šç¾©å¼: h = 0.05 + Î”W / (4Ï€ * WA)
        let h = 0.05;
        if (WA > 0) {
            h += dW / (4 * Math.PI * WA);
        }

        // ä¸Šé™å€¤ã®é©ç”¨ (ä¸€èˆ¬çš„ã«0.25)
        if(h > 0.25) h = 0.25;

        // --- 5. QA (ç­‰ä¾¡ã›ã‚“æ–­åŠ›) ã‚’ã‚¨ãƒãƒ«ã‚®ãƒ¼ç­‰ä¾¡ã«ã‚ˆã‚Šé€†ç®— ---
        // WA = 0.5 * QA * Delta ã‚ˆã‚Š QA = 2 * WA / Delta
        let QA = (Delta > 0) ? (2 * WA / Delta) : 0;
        let Ke = (Delta > 0) ? QA / Delta : 0;

        // æ¸›è¡°ä½æ¸›ä¿‚æ•° Fhï¼ˆå‘Šç¤ºæº–æ‹ ï¼šh = 0.05 + Î”W/(4Ï€WA) ã‚’ä½¿ç”¨ï¼‰
        let Fh_d = 1.0; 
        let Fh_s = 1.5 / (1 + 10 * h);

        // å¿œç­”ã‚¹ãƒšã‚¯ãƒˆãƒ«ã®å–å¾—ï¼ˆæ¨™æº–/è‡ªç”±å…¥åŠ›ã§åˆ†å²ï¼‰
        let Sao_d, Sao_s, S0d, S0s, Gs_val;
        let saCustomInfo = null; // è‡ªç”±å…¥åŠ›æ™‚ã®æƒ…å ±ä¿æŒç”¨
        
        if(b.saMode === 'custom') {
            // è‡ªç”±å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ - æå‚·é™ç•Œã¨å®‰å…¨é™ç•Œã‚’åˆ¥ã€…ã«å‡¦ç†
            
            // è‡ªç”±å…¥åŠ›æ™‚ã®æ¸›è¡°å®šæ•° h ã®è¨ˆç®—ãƒ«ãƒ¼ãƒ«:
            // dW/(4Ï€*WA) < 0.05 ã®å ´åˆ: h = 0.05
            // dW/(4Ï€*WA) â‰§ 0.05 ã®å ´åˆ: h = dW/(4Ï€*WA)
            let h_raw = 0;
            if (WA > 0) {
                h_raw = dW / (4 * Math.PI * WA);
            }
            let h_custom = Math.max(0.05, h_raw);
            if(h_custom > 0.25) h_custom = 0.25; // ä¸Šé™å€¤
            
            // è‡ªç”±å…¥åŠ›ç”¨ã® Fh ã‚’å†è¨ˆç®—
            let Fh_s_custom = 1.5 / (1 + 10 * h_custom);
            
            // æå‚·é™ç•Œç”¨Saï¼ˆè‡ªç”±å…¥åŠ›ãŒã‚ã‚Œã°ãã‚Œã€ãªã‘ã‚Œã°å‘Šç¤ºå€¤ï¼‰
            const Sa_d_custom = getSaCustom(b.saPtsD, Te);
            if(Sa_d_custom !== null) {
                Sao_d = Sa_d_custom;
            } else {
                Sao_d = getSao(Te, 'd');
            }
            
            // å®‰å…¨é™ç•Œç”¨Saï¼ˆè‡ªç”±å…¥åŠ›ãŒã‚ã‚Œã°ãã‚Œã€ãªã‘ã‚Œã°å‘Šç¤ºå€¤ï¼‰
            const Sa_s_custom = getSaCustom(b.saPtsS, Te);
            if(Sa_s_custom !== null) {
                Sao_s = Sa_s_custom;
            } else {
                Sao_s = getSao(Te, 's');
            }
            
            S0d = Sao_d * b.Z;
            S0s = Sao_s * b.Z;
            Gs_val = getGs(b, Te); // å‘Šç¤ºæº–æ‹ ã¨åŒæ§˜ã«Gsã‚’è¨ˆç®—
            
            // è‡ªç”±å…¥åŠ›ç”¨ã® h ã¨ Fh ã‚’ä½¿ç”¨
            h = h_custom;
            Fh_s = Fh_s_custom;
            
            saCustomInfo = { 
                h: h_custom, Fh: Fh_s_custom,
                h_raw: h_raw, // è£œæ­£å‰ã®å€¤
                usedCustomD: Sa_d_custom !== null,
                usedCustomS: Sa_s_custom !== null
            };
        } else {
            // æ¨™æº–ãƒ¢ãƒ¼ãƒ‰ï¼ˆå‘Šç¤ºæº–æ‹ ï¼‰
            Sao_d = getSao(Te, 'd');
            Sao_s = getSao(Te, 's');
            S0d = Sao_d * b.Z;
            S0s = Sao_s * b.Z;
            Gs_val = getGs(b, Te);
        }

        let p = 1.0, q = 1.0;
        if(b.pqMode === 'yes') {
            if(b.stories === 2) {
                if(Te <= 0.16) p = 1.0 - (0.15/0.16) * Te;
                else p = 0.85;
            } else {
                if(Te <= 0.16) p = 1.0 - (0.20/0.16) * Te;
                else p = 0.80;
            }
            if(p < 0.7) p = 0.7; 
            let mu_ratio = Me / (m1 + m2);
            if(mu_ratio < 0.75 && mu_ratio > 0) q = 0.75 / mu_ratio; 
            else q = 1.0;
        }


        let SAd = S0d * Gs_val * p * q * Fh_d;
        let SAs = S0s * Gs_val * Fh_s * p * q; 
        
        let Qnd = SAd * Me; 
        let Qns = SAs * Me;
        let SDd = SAd * (Te / (2*Math.PI))**2;
        let SDs = SAs * (Te / (2*Math.PI))**2;

        let req_R_d = (He > 0) ? SDd / He : 0;
        let req_R_s = (He > 0) ? SDs / He : 0;

        let d1_req_d = (beta_u > 0) ? SDd / beta_u : 0;
        let d1_req_s = (beta_u > 0) ? SDs / beta_u : 0;
        let d2_req_d = d1_req_d * (u2 - 1.0);
        let d2_req_s = d1_req_s * (u2 - 1.0);
        if(d2_req_d < 0) d2_req_d = 0;
        if(d2_req_s < 0) d2_req_s = 0;

        let alpha2 = (b.stories === 2) ? b.W2 / (b.W1 + b.W2) : 0;
        let Ai = 1 + (1/Math.sqrt(alpha2) - alpha2) * (2*Te / (1 + 3*Te));

        steps.push({
            n: (r>0)?Math.round(1/r):0, 
            R: r, R1: r, 
            R2: (b.stories===2 && b.H2>0) ? d2/b.H2 : 0, 
            Q1: Q1, Q2: Q2,
            K1: K1, K2: K2,
            dZ1: d1,      
            dZ2: d1 + d2, 
            sub: d2,      
            uRat: u2,     
            MU: Me, D: Delta, QA: QA, Ke: Ke, Te: Te, H: He,
            dW: dW, 
            WA: WA, 
            heq1: heq1, heq2: heq2,
            h: h, Fh: Fh_s, p: p, q: q,
            S0d: S0d, S0s: S0s, Gs: Gs_val,
            SAd: SAd, SDd: SDd, Qnd: Qnd,
            SAs: SAs, SDs: SDs, Qns: Qns,
            reqRd: req_R_d, 
            reqR1d: d1_req_d / b.H1, 
            reqR2d: (b.stories===2 && b.H2>0) ? d2_req_d / b.H2 : 0,
            reqRs: req_R_s, 
            reqR1s: d1_req_s / b.H1, 
            reqR2s: (b.stories===2 && b.H2>0) ? d2_req_s / b.H2 : 0,
            Ai: Ai, alpha2: alpha2
        });
    }
    
    // å„éšã®æœ€å¤§è€åŠ›ã¨ãã®æ™‚ã®å¤‰å½¢è§’ã‚’ç®—å‡º
    let maxQ1Step = steps.reduce((prev, curr) => (curr.Q1 > prev.Q1) ? curr : prev, steps[0]);
    let maxQ2Step = steps.reduce((prev, curr) => (curr.Q2 > prev.Q2) ? curr : prev, steps[0]);
    let Q1max = maxQ1Step.Q1;
    let Q2max = maxQ2Step.Q2;
    let R1_atQ1max = maxQ1Step.R1;  // 1éšæœ€å¤§è€åŠ›æ™‚ã®å¤‰å½¢è§’
    let R2_atQ2max = maxQ2Step.R2;  // 2éšæœ€å¤§è€åŠ›æ™‚ã®å¤‰å½¢è§’
    
    return { steps, T0, K10, K20, Q1max, Q2max, R1_atQ1max, R2_atQ2max };
}

function findIntersection(steps, type) {
    for(let i=0; i<steps.length-1; i++) {
        let s1 = steps[i], s2 = steps[i+1];
        let req1 = (type==='d') ? s1.Qnd : s1.Qns;
        let req2 = (type==='d') ? s2.Qnd : s2.Qns;
        let v1 = s1.QA - req1, v2 = s2.QA - req2;
        
        if(v1 * v2 <= 0 && s1.QA > 0) {
            let r = Math.abs(v1) / (Math.abs(v1) + Math.abs(v2));
            let res = {};
            for(let k in s1) if(typeof s1[k] === 'number') res[k] = s1[k] + r * (s2[k] - s1[k]);
            return res;
        }
    }
    return null;
}

function getRating(ratio) {
    if(ratio >= 1.5) return { text: "å€’å£Šã—ãªã„", cls: "badge-ok" };
    if(ratio >= 1.0) return { text: "ä¸€å¿œå€’å£Šã—ãªã„", cls: "badge-warn" };
    if(ratio >= 0.7) return { text: "å€’å£Šã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹", cls: "badge-ng" };
    return { text: "å€’å£Šã™ã‚‹å¯èƒ½æ€§ãŒé«˜ã„", cls: "badge-ng" };
}

function executeCalculation() {
    const b = getBldg();
    if(b.tcMode==='custom' && b.gsPts.length === 0) { alert('Gsã‚¹ãƒšã‚¯ãƒˆãƒ«ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚'); return; }
    
    const skipY = document.getElementById('chk-skip-y').checked;
    
    let fx1 = getForce('x1'), fy1 = skipY ? [] : getForce('y1');
    let fx2 = (b.stories===2) ? getForce('x2') : [];
    let fy2 = (b.stories===2 && !skipY) ? getForce('y2') : [];
    
    if(fx1.length < 2) { alert('Xæ–¹å‘ã®å¾©å…ƒåŠ›ç‰¹æ€§ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚'); return; }
    if(!skipY && fy1.length < 2) { alert('Yæ–¹å‘ã®å¾©å…ƒåŠ›ç‰¹æ€§ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚'); return; }
    
    const limitD = parseFloat(document.getElementById('inp_limit_d').value);
    const limitS = parseFloat(document.getElementById('inp_limit_s').value);

    let checkX = checkDiscriminant(b, fx1, fx2, limitD);
    let msg = "";
    if(!checkX.isSafe && b.stories===2) msg += "Xæ–¹å‘: 1éšå…ˆè¡Œé™ä¼ã®æ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“ã€‚\n";
    
    if(!skipY) {
        let checkY = checkDiscriminant(b, fy1, fy2, limitD);
        if(!checkY.isSafe && b.stories===2) msg += "Yæ–¹å‘: 1éšå…ˆè¡Œé™ä¼ã®æ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“ã€‚\n";
    }
    if(msg) alert(msg + "â€»2éšã®å¤‰å½¢ãŒéå¤§ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");

    let resX = calc(b, fx1, fx2);
    let resY = skipY ? null : calc(b, fy1, fy2);
    
    if(!resX) return;
    if(!skipY && !resY) return;

    let ptXd = findIntersection(resX.steps, 'd'), ptXs = findIntersection(resX.steps, 's');
    let ptYd = skipY ? null : findIntersection(resY.steps, 'd');
    let ptYs = skipY ? null : findIntersection(resY.steps, 's');
    
    calcRes = { b, resX, resY, ptXd, ptXs, ptYd, ptYs, skipY };
    updateView('x', resX, ptXd, ptXs, limitD, limitS);
    renderLog('x', resX.steps);
    
    // Yæ–¹å‘ã®è¡¨ç¤º/éè¡¨ç¤º
    document.getElementById('result-panel-y').style.display = skipY ? 'none' : 'block';
    document.getElementById('btn-log-y').style.display = skipY ? 'none' : 'inline-block';
    
    if(!skipY) {
        updateView('y', resY, ptYd, ptYs, limitD, limitS);
        renderLog('y', resY.steps);
    }
    
    document.getElementById('result-summary').style.display = 'block';
    
    document.getElementById('rep-Z').innerText = b.Z.toFixed(2);
    let tcName = (b.tcMode==='1') ? 'ç¬¬1ç¨®(å²©ç›¤ç­‰)' : (b.tcMode==='3') ? 'ç¬¬3ç¨®(è»Ÿå¼±)' : (b.tcMode==='2') ? 'ç¬¬2ç¨®(æ™®é€š)' : 'è‡ªç”±è¨­å®š';
    document.getElementById('rep-Tc').innerText = tcName;
    document.getElementById('rep-PQ').innerText = (b.pqMode==='yes') ? 'è€ƒæ…®ã™ã‚‹' : 'è€ƒæ…®ã—ãªã„';
    document.getElementById('rep-lim-d').innerText = `1/${limitD}`;
    document.getElementById('rep-lim-s').innerText = `1/${limitS}`;
    document.getElementById('rep-building-name').innerText = b.name;
    
    let htmlBldg = `<tr><td>1F</td><td>${b.H1.toFixed(2)}</td><td>${b.W1.toFixed(1)}</td><td>${b.W1.toFixed(1)}</td><td>${skipY ? 'X:'+resX.K10.toFixed(0) : 'X:'+resX.K10.toFixed(0)+' / Y:'+resY.K10.toFixed(0)}</td></tr>`;
    if(b.stories === 2) {
        htmlBldg = `<tr><td>2F</td><td>${b.H2.toFixed(2)}</td><td>${b.W2.toFixed(1)}</td><td>${b.W2.toFixed(1)}</td><td>${skipY ? 'X:'+resX.K20.toFixed(0) : 'X:'+resX.K20.toFixed(0)+' / Y:'+resY.K20.toFixed(0)}</td></tr>` +
                   `<tr><td>1F</td><td>${b.H1.toFixed(2)}</td><td>${b.W1.toFixed(1)}</td><td>${(b.W1+b.W2).toFixed(1)}</td><td>${skipY ? 'X:'+resX.K10.toFixed(0) : 'X:'+resX.K10.toFixed(0)+' / Y:'+resY.K10.toFixed(0)}</td></tr>`;
    }
    document.getElementById('rep-bldg-tbody').innerHTML = htmlBldg;
    
    // äº¤ç‚¹è©³ç´°ã‚’æ›´æ–°
    renderIntersectionDetail('x', b, resX, ptXd, ptXs);
    if(!skipY) {
        renderIntersectionDetail('y', b, resY, ptYd, ptYs);
    }
    document.getElementById('detail-content').style.display = 'block';
    document.getElementById('detail-placeholder').style.display = 'none';
    document.getElementById('btn-detail-y').style.display = skipY ? 'none' : 'inline-block';
    
    // --- è¿½åŠ : å±¤ã›ã‚“æ–­åŠ›æ¯”è¼ƒã®æ›´æ–° ---
    if(document.getElementById('chk_calc_shear_force').checked) {
        updateShearTab(b, resX, resY, ptXd, ptXs, ptYd, ptYs);
    }
    // --------------------------------
}

// äº¤ç‚¹è©³ç´°ã®æ–¹å‘åˆ‡ã‚Šæ›¿ãˆ
function showDetailDir(dir) {
    document.getElementById('detail-x').style.display = (dir === 'x') ? 'block' : 'none';
    document.getElementById('detail-y').style.display = (dir === 'y') ? 'block' : 'none';
    document.getElementById('btn-detail-x').style.background = (dir === 'x') ? '#005a9c' : '#ccc';
    document.getElementById('btn-detail-x').style.color = (dir === 'x') ? '#fff' : '#333';
    document.getElementById('btn-detail-y').style.background = (dir === 'y') ? '#005a9c' : '#ccc';
    document.getElementById('btn-detail-y').style.color = (dir === 'y') ? '#fff' : '#333';
}

// HTMLæ–‡å­—åˆ—ã‚’ã€Œ4. æ¸›è¡°å®šæ•°ãƒ»ä½æ¸›ä¿‚æ•°ã€ã®å‰ã§åˆ†å‰²ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
function splitAtDampingSection(html) {
    // ã€Œ4. æ¸›è¡°å®šæ•°ãƒ»ä½æ¸›ä¿‚æ•°ã€ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ¤œç´¢
    const splitMarker = '>4. æ¸›è¡°å®šæ•°ãƒ»ä½æ¸›ä¿‚æ•°</h5>';
    const idx = html.indexOf(splitMarker);
    if (idx === -1) {
        return { part1: html, part2: '' };
    }
    // ã‚»ã‚¯ã‚·ãƒ§ãƒ³4ã®é–‹å§‹ä½ç½®ï¼ˆ<!-- 4. æ¸›è¡°å®šæ•°ãƒ»ä½æ¸›ä¿‚æ•° -->ã®ç›´å‰ã®</div>ï¼‰ã‚’æ¢ã™
    const beforeMarker = html.substring(0, idx);
    // </table>ã®å¾Œã®</div>ã‚’æ¢ã™
    const lastTableClose = beforeMarker.lastIndexOf('</table>');
    if (lastTableClose !== -1) {
        const afterTable = beforeMarker.substring(lastTableClose);
        const divCloseAfterTable = afterTable.indexOf('</div>');
        if (divCloseAfterTable !== -1) {
            const splitPoint = lastTableClose + divCloseAfterTable + 6;
            return {
                part1: html.substring(0, splitPoint),
                part2: html.substring(splitPoint)
            };
        }
    }
    return { part1: html, part2: '' };
}

// äº¤ç‚¹è©³ç´°ã‚’ç”Ÿæˆãƒ»è¡¨ç¤ºï¼ˆç”»é¢ç”¨ã¨å°åˆ·ç”¨ã®ä¸¡æ–¹ã‚’æ›´æ–°ï¼‰
function renderIntersectionDetail(dir, b, res, ptD, ptS) {
    const dirName = (dir === 'x') ? 'Xæ–¹å‘' : 'Yæ–¹å‘';
    const is1F = (b.stories === 1);
    
    let html = `<h3 style="color:#005a9c; border-bottom:2px solid #005a9c; padding-bottom:5px;">${dirName} äº¤ç‚¹è¨ˆç®—è©³ç´°</h3>`;
    
    // æå‚·é™ç•Œã®è©³ç´°
    const htmlD = renderPointDetail(b, res, ptD, 'æå‚·é™ç•Œ', '#28a745', is1F);
    
    // å®‰å…¨é™ç•Œã®è©³ç´°
    const htmlS = renderPointDetail(b, res, ptS, 'å®‰å…¨é™ç•Œ', '#dc3545', is1F);
    
    html += htmlD + htmlS;
    
    // 1. ç”»é¢è¡¨ç¤ºç”¨ã‚³ãƒ³ãƒ†ãƒŠã¸ã®åæ˜ 
    const screenContainer = document.getElementById('detail-' + dir);
    if(screenContainer) {
        screenContainer.innerHTML = html;
        if(window.MathJax) MathJax.Hub.Queue(["Typeset", MathJax.Hub, screenContainer]);
    }

    // 2. è¨ˆç®—æ›¸(å°åˆ·)ç”¨ã‚³ãƒ³ãƒ†ãƒŠã¸ã®åæ˜  - 4ãƒšãƒ¼ã‚¸ã«åˆ†å‰²
    const repContainer1 = document.getElementById('rep-detail-' + dir + '1');
    const repContainer2 = document.getElementById('rep-detail-' + dir + '2');
    const repContainer3 = document.getElementById('rep-detail-' + dir + '3');
    const repContainer4 = document.getElementById('rep-detail-' + dir + '4');
    if(repContainer1 && repContainer2 && repContainer3 && repContainer4) {
        // æå‚·é™ç•Œã‚’ã€Œ4. æ¸›è¡°å®šæ•°ãƒ»ä½æ¸›ä¿‚æ•°ã€ã®å‰ã§åˆ†å‰²
        const htmlDParts = splitAtDampingSection(htmlD);
        // å®‰å…¨é™ç•Œã‚’ã€Œ4. æ¸›è¡°å®šæ•°ãƒ»ä½æ¸›ä¿‚æ•°ã€ã®å‰ã§åˆ†å‰²
        const htmlSParts = splitAtDampingSection(htmlS);
        
        // 1ãƒšãƒ¼ã‚¸ç›®: ã‚¿ã‚¤ãƒˆãƒ« + æå‚·é™ç•Œã®å‰åŠï¼ˆ1-3ã¾ã§ï¼‰
        repContainer1.innerHTML = `<h3 style="color:#005a9c; border-bottom:2px solid #005a9c; padding-bottom:5px;">${dirName} äº¤ç‚¹è¨ˆç®—è©³ç´°</h3>` + htmlDParts.part1;
        // 2ãƒšãƒ¼ã‚¸ç›®: æå‚·é™ç•Œã®å¾ŒåŠï¼ˆ4-5ï¼‰
        repContainer2.innerHTML = htmlDParts.part2;
        // 3ãƒšãƒ¼ã‚¸ç›®: å®‰å…¨é™ç•Œã®å‰åŠï¼ˆ1-3ã¾ã§ï¼‰
        repContainer3.innerHTML = htmlSParts.part1;
        // 4ãƒšãƒ¼ã‚¸ç›®: å®‰å…¨é™ç•Œã®å¾ŒåŠï¼ˆ4-5ï¼‰
        repContainer4.innerHTML = htmlSParts.part2;
        
        if(window.MathJax) {
            MathJax.Hub.Queue(["Typeset", MathJax.Hub, repContainer1]);
            MathJax.Hub.Queue(["Typeset", MathJax.Hub, repContainer2]);
            MathJax.Hub.Queue(["Typeset", MathJax.Hub, repContainer3]);
            MathJax.Hub.Queue(["Typeset", MathJax.Hub, repContainer4]);
        }
    }
}

// å„äº¤ç‚¹ã®è©³ç´°ã‚’ç”Ÿæˆ
function renderPointDetail(b, res, pt, limitName, color, is1F) {
    if(!pt) {
        return `
        <div style="background:#fff5f5; border:2px solid ${color}; border-radius:8px; padding:15px; margin-bottom:20px;">
            <h4 style="color:${color}; margin-top:0;">ã€${limitName}ã€‘äº¤ç‚¹ãªã—</h4>
            <p style="color:#dc3545; font-weight:bold;">å¾©å…ƒåŠ›ç‰¹æ€§æ›²ç·šã¨å¿…è¦è€åŠ›æ›²ç·šã®äº¤ç‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
            <p>å»ºç‰©ã®è€åŠ›ãŒä¸è¶³ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</p>
        </div>`;
    }
    
    const f = (v, d=4) => (typeof v === 'number') ? v.toFixed(d) : '-';
    const f2 = (v) => f(v, 2);
    const f3 = (v) => f(v, 3);
    const f4 = (v) => f(v, 4);
    const f6 = (v) => f(v, 6);
    const fInt = (v) => (typeof v === 'number') ? Math.round(v) : '-';
    
    // å„ç¨®è¨ˆç®—å€¤
    const R1 = pt.R1;
    const R2 = pt.R2 || 0;
    const d1 = pt.dZ1;
    const d2 = pt.sub || 0;
    const Q1 = pt.Q1;
    const Q2 = pt.Q2 || 0;
    const K1 = pt.K1;
    const K2 = pt.K2 || 0;
    const u2 = pt.uRat || 0;
    
    const m1 = b.W1 / 9.80665;
    const m2 = b.W2 / 9.80665;
    
    const Me = pt.MU;
    const Delta = pt.D;
    const He = pt.H;
    const QA = pt.QA;
    const Ke = pt.Ke;
    const Te = pt.Te;
    
    const heq1 = pt.heq1;
    const heq2 = pt.heq2 || 0;
    const wa1 = 0.5 * Q1 * d1;
    const wa2 = is1F ? 0 : 0.5 * Q2 * d2;
    const WA = pt.WA;
    const dW = pt.dW;
    const h = pt.h;
    const Fh = pt.Fh;
    
    const Sao = (limitName === 'æå‚·é™ç•Œ') ? pt.S0d / b.Z : pt.S0s / b.Z;
    const S0 = (limitName === 'æå‚·é™ç•Œ') ? pt.S0d : pt.S0s;
    const Gs = pt.Gs;
    const p = pt.p;
    const q = pt.q;
    const SA = (limitName === 'æå‚·é™ç•Œ') ? pt.SAd : pt.SAs;
    const SD = (limitName === 'æå‚·é™ç•Œ') ? pt.SDd : pt.SDs;
    const Qn = (limitName === 'æå‚·é™ç•Œ') ? pt.Qnd : pt.Qns;
    
    const Fh_d = 1.0;
    
    let html = `
    <div style="background:#fafafa; border:2px solid ${color}; border-radius:8px; padding:15px; margin-bottom:20px;">
        <h4 style="color:${color}; margin-top:0; font-size:1.2em;">ã€${limitName}ã€‘äº¤ç‚¹è¨ˆç®—è©³ç´°</h4>
        
        <!-- 1. å¤‰å½¢çŠ¶æ…‹ -->
        <div style="background:#fff; border:1px solid #ddd; padding:10px; margin-bottom:10px; border-radius:5px;">
            <h5 style="color:#005a9c; margin:0 0 10px 0;">1. å¤‰å½¢çŠ¶æ…‹</h5>
            <table style="width:100%; border-collapse:collapse; font-size:0.9em;">
                <tr style="background:#f0f0f0;">
                    <th style="border:1px solid #ccc; padding:5px;">é …ç›®</th>
                    <th style="border:1px solid #ccc; padding:5px;">è¨ˆç®—å¼</th>
                    <th style="border:1px solid #ccc; padding:5px;">è¨ˆç®—å€¤</th>
                </tr>
                <tr>
                    <td style="border:1px solid #ccc; padding:5px;">1éšå±¤é–“å¤‰å½¢è§’ Râ‚</td>
                    <td style="border:1px solid #ccc; padding:5px;">ï¼ˆå…¥åŠ›å€¤ï¼‰</td>
                    <td style="border:1px solid #ccc; padding:5px; text-align:right;"><strong>1/${fInt(1/R1)}</strong> = ${f6(R1)} rad</td>
                </tr>
                <tr>
                    <td style="border:1px solid #ccc; padding:5px;">1éšå±¤é–“å¤‰ä½ Î´â‚</td>
                    <td style="border:1px solid #ccc; padding:5px;">Î´â‚ = Râ‚ Ã— Hâ‚ = ${f6(R1)} Ã— ${f2(b.H1)}</td>
                    <td style="border:1px solid #ccc; padding:5px; text-align:right;"><strong>${f4(d1)}</strong> m</td>
                </tr>`;
    
    if(!is1F) {
        html += `
                <tr>
                    <td style="border:1px solid #ccc; padding:5px;">ãƒ¢ãƒ¼ãƒ‰å½¢æ¯” uâ‚‚/uâ‚</td>
                    <td style="border:1px solid #ccc; padding:5px;">å›ºæœ‰å€¤è§£æã‚ˆã‚Š</td>
                    <td style="border:1px solid #ccc; padding:5px; text-align:right;"><strong>${f4(u2)}</strong></td>
                </tr>
                <tr>
                    <td style="border:1px solid #ccc; padding:5px;">2éšå±¤é–“å¤‰ä½ Î´â‚‚</td>
                    <td style="border:1px solid #ccc; padding:5px;">Î´â‚‚ = Î´â‚ Ã— (uâ‚‚ - 1) = ${f4(d1)} Ã— (${f4(u2)} - 1)</td>
                    <td style="border:1px solid #ccc; padding:5px; text-align:right;"><strong>${f4(d2)}</strong> m</td>
                </tr>
                <tr>
                    <td style="border:1px solid #ccc; padding:5px;">2éšå±¤é–“å¤‰å½¢è§’ Râ‚‚</td>
                    <td style="border:1px solid #ccc; padding:5px;">Râ‚‚ = Î´â‚‚ / Hâ‚‚ = ${f4(d2)} / ${f2(b.H2)}</td>
                    <td style="border:1px solid #ccc; padding:5px; text-align:right;"><strong>1/${fInt(1/R2)}</strong> = ${f6(R2)} rad</td>
                </tr>`;
    }
    
    html += `
            </table>
        </div>
        
        <!-- 2. å¾©å…ƒåŠ›ç‰¹æ€§ -->
        <div style="background:#fff; border:1px solid #ddd; padding:10px; margin-bottom:10px; border-radius:5px;">
            <h5 style="color:#005a9c; margin:0 0 10px 0;">2. å¾©å…ƒåŠ›ç‰¹æ€§ï¼ˆã›ã‚“æ–­åŠ›ãƒ»å‰›æ€§ï¼‰</h5>
            <table style="width:100%; border-collapse:collapse; font-size:0.9em;">
                <tr style="background:#f0f0f0;">
                    <th style="border:1px solid #ccc; padding:5px;">é …ç›®</th>
                    <th style="border:1px solid #ccc; padding:5px;">è¨ˆç®—å¼</th>
                    <th style="border:1px solid #ccc; padding:5px;">è¨ˆç®—å€¤</th>
                </tr>
                <tr>
                    <td style="border:1px solid #ccc; padding:5px;">1éšã›ã‚“æ–­åŠ› Qâ‚</td>
                    <td style="border:1px solid #ccc; padding:5px;">å¾©å…ƒåŠ›ç‰¹æ€§ã‚ˆã‚Šè£œé–“</td>
                    <td style="border:1px solid #ccc; padding:5px; text-align:right;"><strong>${f2(Q1)}</strong> kN</td>
                </tr>
                <tr>
                    <td style="border:1px solid #ccc; padding:5px;">1éšå‰²ç·šå‰›æ€§ Kâ‚</td>
                    <td style="border:1px solid #ccc; padding:5px;">Kâ‚ = Qâ‚ / Î´â‚ = ${f2(Q1)} / ${f4(d1)}</td>
                    <td style="border:1px solid #ccc; padding:5px; text-align:right;"><strong>${f2(K1)}</strong> kN/m</td>
                </tr>`;
    
    if(!is1F) {
        html += `
                <tr>
                    <td style="border:1px solid #ccc; padding:5px;">2éšã›ã‚“æ–­åŠ› Qâ‚‚</td>
                    <td style="border:1px solid #ccc; padding:5px;">å¾©å…ƒåŠ›ç‰¹æ€§ã‚ˆã‚Šè£œé–“</td>
                    <td style="border:1px solid #ccc; padding:5px; text-align:right;"><strong>${f2(Q2)}</strong> kN</td>
                </tr>
                <tr>
                    <td style="border:1px solid #ccc; padding:5px;">2éšå‰²ç·šå‰›æ€§ Kâ‚‚</td>
                    <td style="border:1px solid #ccc; padding:5px;">Kâ‚‚ = Qâ‚‚ / Î´â‚‚ = ${f2(Q2)} / ${f4(d2)}</td>
                    <td style="border:1px solid #ccc; padding:5px; text-align:right;"><strong>${f2(K2)}</strong> kN/m</td>
                </tr>`;
    }
    
    html += `
            </table>
        </div>
        
        <!-- 3. ç­‰ä¾¡1è‡ªç”±åº¦ç³»ã¸ã®ç½®æ› -->
        <div style="background:#fff; border:1px solid #ddd; padding:10px; margin-bottom:10px; border-radius:5px;">
            <h5 style="color:#005a9c; margin:0 0 10px 0;">3. ç­‰ä¾¡1è‡ªç”±åº¦ç³»ã¸ã®ç½®æ›</h5>
            <table style="width:100%; border-collapse:collapse; font-size:0.9em;">
                <tr style="background:#f0f0f0;">
                    <th style="border:1px solid #ccc; padding:5px;">é …ç›®</th>
                    <th style="border:1px solid #ccc; padding:5px;">è¨ˆç®—å¼</th>
                    <th style="border:1px solid #ccc; padding:5px;">è¨ˆç®—å€¤</th>
                </tr>
                <tr>
                    <td style="border:1px solid #ccc; padding:5px;">1éšè³ªé‡ mâ‚</td>
                    <td style="border:1px solid #ccc; padding:5px;">mâ‚ = Wâ‚ / g = ${f2(b.W1)} / 9.807</td>
                    <td style="border:1px solid #ccc; padding:5px; text-align:right;"><strong>${f3(m1)}</strong> t</td>
                </tr>`;
    
    if(!is1F) {
        html += `
                <tr>
                    <td style="border:1px solid #ccc; padding:5px;">2éšè³ªé‡ mâ‚‚</td>
                    <td style="border:1px solid #ccc; padding:5px;">mâ‚‚ = Wâ‚‚ / g = ${f2(b.W2)} / 9.807</td>
                    <td style="border:1px solid #ccc; padding:5px; text-align:right;"><strong>${f3(m2)}</strong> t</td>
                </tr>
                <tr>
                    <td style="border:1px solid #ccc; padding:5px;">ç­‰ä¾¡è³ªé‡ Mâ‚‘</td>
                    <td style="border:1px solid #ccc; padding:5px;">Mâ‚‘ = (Î£máµ¢uáµ¢)Â² / Î£máµ¢uáµ¢Â²</td>
                    <td style="border:1px solid #ccc; padding:5px; text-align:right;"><strong>${f3(Me)}</strong> t</td>
                </tr>`;
    } else {
        html += `
                <tr>
                    <td style="border:1px solid #ccc; padding:5px;">ç­‰ä¾¡è³ªé‡ Mâ‚‘</td>
                    <td style="border:1px solid #ccc; padding:5px;">Mâ‚‘ = mâ‚ï¼ˆ1éšå»ºã¦ï¼‰</td>
                    <td style="border:1px solid #ccc; padding:5px; text-align:right;"><strong>${f3(Me)}</strong> t</td>
                </tr>`;
    }
    
    html += `
                <tr>
                    <td style="border:1px solid #ccc; padding:5px;">ç­‰ä¾¡å¤‰ä½ Î”</td>
                    <td style="border:1px solid #ccc; padding:5px;">Î” = Î£máµ¢uáµ¢Â² / Î£máµ¢uáµ¢ Ã— Î´â‚</td>
                    <td style="border:1px solid #ccc; padding:5px; text-align:right;"><strong>${f4(Delta)}</strong> m</td>
                </tr>
                <tr>
                    <td style="border:1px solid #ccc; padding:5px;">ç­‰ä¾¡é«˜ã• Hâ‚‘</td>
                    <td style="border:1px solid #ccc; padding:5px;">Hâ‚‘ = Î£máµ¢uáµ¢háµ¢ / Î£máµ¢uáµ¢</td>
                    <td style="border:1px solid #ccc; padding:5px; text-align:right;"><strong>${f3(He)}</strong> m</td>
                </tr>
                <tr>
                    <td style="border:1px solid #ccc; padding:5px;">ç­‰ä¾¡ã›ã‚“æ–­åŠ› Qâ‚</td>
                    <td style="border:1px solid #ccc; padding:5px;">Qâ‚ = 2 Ã— Wâ‚ / Î” = 2 Ã— ${f2(WA)} / ${f4(Delta)}</td>
                    <td style="border:1px solid #ccc; padding:5px; text-align:right;"><strong>${f2(QA)}</strong> kN</td>
                </tr>
                <tr>
                    <td style="border:1px solid #ccc; padding:5px;">ç­‰ä¾¡å‰›æ€§ Kâ‚‘</td>
                    <td style="border:1px solid #ccc; padding:5px;">Kâ‚‘ = Qâ‚ / Î” = ${f2(QA)} / ${f4(Delta)}</td>
                    <td style="border:1px solid #ccc; padding:5px; text-align:right;"><strong>${f2(Ke)}</strong> kN/m</td>
                </tr>
                <tr>
                    <td style="border:1px solid #ccc; padding:5px;">ç­‰ä¾¡å‘¨æœŸ Tâ‚‘</td>
                    <td style="border:1px solid #ccc; padding:5px;">Tâ‚‘ = 2Ï€âˆš(Mâ‚‘/Kâ‚‘)</td>
                    <td style="border:1px solid #ccc; padding:5px; text-align:right;"><strong>${f4(Te)}</strong> s</td>
                </tr>
            </table>
        </div>
        
        <!-- 4. æ¸›è¡°å®šæ•°ãƒ»ä½æ¸›ä¿‚æ•° -->
        <div style="background:#fff; border:2px solid ${color}; padding:10px; margin-bottom:10px; border-radius:5px;">
            <h5 style="color:${color}; margin:0 0 10px 0;">4. æ¸›è¡°å®šæ•°ãƒ»ä½æ¸›ä¿‚æ•°</h5>
            <table style="width:100%; border-collapse:collapse; font-size:0.9em;">
                <tr style="background:#f0f0f0;">
                    <th style="border:1px solid #ccc; padding:5px;">é …ç›®</th>
                    <th style="border:1px solid #ccc; padding:5px;">è¨ˆç®—å¼</th>
                    <th style="border:1px solid #ccc; padding:5px;">è¨ˆç®—å€¤</th>
                </tr>
                <tr>
                    <td style="border:1px solid #ccc; padding:5px;">1éšãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã‚¨ãƒãƒ«ã‚®ãƒ¼ Wâ‚</td>
                    <td style="border:1px solid #ccc; padding:5px;">Wâ‚ = 0.5 Ã— Qâ‚ Ã— Î´â‚ = 0.5 Ã— ${f2(Q1)} Ã— ${f4(d1)}</td>
                    <td style="border:1px solid #ccc; padding:5px; text-align:right;"><strong>${f3(wa1)}</strong> kNÂ·m</td>
                </tr>`;
    
    if(!is1F) {
        html += `
                <tr>
                    <td style="border:1px solid #ccc; padding:5px;">2éšãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã‚¨ãƒãƒ«ã‚®ãƒ¼ Wâ‚‚</td>
                    <td style="border:1px solid #ccc; padding:5px;">Wâ‚‚ = 0.5 Ã— Qâ‚‚ Ã— Î´â‚‚ = 0.5 Ã— ${f2(Q2)} Ã— ${f4(d2)}</td>
                    <td style="border:1px solid #ccc; padding:5px; text-align:right;"><strong>${f3(wa2)}</strong> kNÂ·m</td>
                </tr>`;
    }
    
    html += `
                <tr>
                    <td style="border:1px solid #ccc; padding:5px;">å…¨ä½“ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã‚¨ãƒãƒ«ã‚®ãƒ¼ Wâ‚</td>
                    <td style="border:1px solid #ccc; padding:5px;">Wâ‚ = Wâ‚ + Wâ‚‚</td>
                    <td style="border:1px solid #ccc; padding:5px; text-align:right;"><strong>${f3(WA)}</strong> kNÂ·m</td>
                </tr>
                <tr>
                    <td style="border:1px solid #ccc; padding:5px;">1éšç­‰ä¾¡æ¸›è¡°å®šæ•° heqâ‚</td>
                    <td style="border:1px solid #ccc; padding:5px;">heqâ‚ = (Î´â‚ - Qâ‚/Kâ‚â‚€) / Î´â‚ Ã— 2/(4Ï€)</td>
                    <td style="border:1px solid #ccc; padding:5px; text-align:right;"><strong>${f4(heq1)}</strong></td>
                </tr>`;
    
    if(!is1F) {
        html += `
                <tr>
                    <td style="border:1px solid #ccc; padding:5px;">2éšç­‰ä¾¡æ¸›è¡°å®šæ•° heqâ‚‚</td>
                    <td style="border:1px solid #ccc; padding:5px;">heqâ‚‚ = (Î´â‚‚ - Qâ‚‚/Kâ‚‚â‚€) / Î´â‚‚ Ã— 2/(4Ï€)</td>
                    <td style="border:1px solid #ccc; padding:5px; text-align:right;"><strong>${f4(heq2)}</strong></td>
                </tr>`;
    }
    
    html += `
                <tr>
                    <td style="border:1px solid #ccc; padding:5px;">å±¥æ­´æ¸›è¡°ã‚¨ãƒãƒ«ã‚®ãƒ¼ Î”W</td>
                    <td style="border:1px solid #ccc; padding:5px;">Î”W = 4Ï€(heqâ‚Â·Wâ‚ + heqâ‚‚Â·Wâ‚‚)</td>
                    <td style="border:1px solid #ccc; padding:5px; text-align:right;"><strong>${f3(dW)}</strong> kNÂ·m</td>
                </tr>
                <tr>
                    <td style="border:1px solid #ccc; padding:5px;">ç·åˆæ¸›è¡°å®šæ•° h</td>
                    <td style="border:1px solid #ccc; padding:5px;">${b.saMode === 'custom' ? 'h = max(0.05, Î”W/(4Ï€Wâ‚))' : 'h = 0.05 + Î”W/(4Ï€Wâ‚)'}</td>
                    <td style="border:1px solid #ccc; padding:5px; text-align:right;"><strong>${f4(h)}</strong></td>
                </tr>
                <tr>
                    <td style="border:1px solid #ccc; padding:5px;">æ¸›è¡°ä½æ¸›ä¿‚æ•° Fh</td>
                    <td style="border:1px solid #ccc; padding:5px;">Fh = 1.5 / (1 + 10h) = 1.5 / (1 + 10Ã—${f4(h)})</td>
                    <td style="border:1px solid #ccc; padding:5px; text-align:right;"><strong>${f4(Fh)}</strong></td>
                </tr>
            </table>
        </div>
        
        <!-- 5. å¿œç­”ã‚¹ãƒšã‚¯ãƒˆãƒ«ãƒ»å¿…è¦è€åŠ› -->
        <div style="background:#fff; border:2px solid ${color}; padding:10px; margin-bottom:10px; border-radius:5px;">
            <h5 style="color:${color}; margin:0 0 10px 0;">5. å¿œç­”ã‚¹ãƒšã‚¯ãƒˆãƒ«ãƒ»å¿…è¦è€åŠ›</h5>
            <table style="width:100%; border-collapse:collapse; font-size:0.9em;">
                <tr style="background:#f0f0f0;">
                    <th style="border:1px solid #ccc; padding:5px;">é …ç›®</th>
                    <th style="border:1px solid #ccc; padding:5px;">è¨ˆç®—å¼</th>
                    <th style="border:1px solid #ccc; padding:5px;">è¨ˆç®—å€¤</th>
                </tr>
                <tr>
                    <td style="border:1px solid #ccc; padding:5px;">åŸºç›¤åŠ é€Ÿåº¦ Saâ‚€(Tâ‚‘)</td>
                    <td style="border:1px solid #ccc; padding:5px;">${limitName}ç”¨ã‚¹ãƒšã‚¯ãƒˆãƒ« (Tâ‚‘=${f4(Te)}s)</td>
                    <td style="border:1px solid #ccc; padding:5px; text-align:right;"><strong>${f3(Sao)}</strong> m/sÂ²</td>
                </tr>
                <tr>
                    <td style="border:1px solid #ccc; padding:5px;">åœ°åŸŸè£œæ­£ Sâ‚€</td>
                    <td style="border:1px solid #ccc; padding:5px;">Sâ‚€ = Saâ‚€ Ã— Z = ${f3(Sao)} Ã— ${f2(b.Z)}</td>
                    <td style="border:1px solid #ccc; padding:5px; text-align:right;"><strong>${f3(S0)}</strong> m/sÂ²</td>
                </tr>
                <tr>
                    <td style="border:1px solid #ccc; padding:5px;">åœ°ç›¤å¢—å¹…ç‡ Gs</td>
                    <td style="border:1px solid #ccc; padding:5px;">${b.tcMode === 'custom' ? 'è‡ªç”±å…¥åŠ›ã‚¹ãƒšã‚¯ãƒˆãƒ«' : 'å‘Šç¤ºå¼'} (Tâ‚‘=${f4(Te)}s)</td>
                    <td style="border:1px solid #ccc; padding:5px; text-align:right;"><strong>${f3(Gs)}</strong></td>
                </tr>
                <tr>
                    <td style="border:1px solid #ccc; padding:5px;">èª¿æ•´ä¿‚æ•° p</td>
                    <td style="border:1px solid #ccc; padding:5px;">${b.pqMode === 'yes' ? 'è€ƒæ…®' : 'è€ƒæ…®ã—ãªã„ (=1.0)'}</td>
                    <td style="border:1px solid #ccc; padding:5px; text-align:right;"><strong>${f4(p)}</strong></td>
                </tr>
                <tr>
                    <td style="border:1px solid #ccc; padding:5px;">èª¿æ•´ä¿‚æ•° q</td>
                    <td style="border:1px solid #ccc; padding:5px;">${b.pqMode === 'yes' ? 'è€ƒæ…®' : 'è€ƒæ…®ã—ãªã„ (=1.0)'}</td>
                    <td style="border:1px solid #ccc; padding:5px; text-align:right;"><strong>${f4(q)}</strong></td>
                </tr>
                <tr style="background:#fffacd;">
                    <td style="border:1px solid #ccc; padding:5px;"><strong>è¨­è¨ˆåŠ é€Ÿåº¦ Sâ‚</strong></td>
                    <td style="border:1px solid #ccc; padding:5px;">Sâ‚ = Sâ‚€ Ã— Gs Ã— ${limitName === 'æå‚·é™ç•Œ' ? 'Fh_d' : 'Fh'} Ã— p Ã— q<br>= ${f3(S0)} Ã— ${f3(Gs)} Ã— ${limitName === 'æå‚·é™ç•Œ' ? f4(Fh_d) : f4(Fh)} Ã— ${f4(p)} Ã— ${f4(q)}</td>
                    <td style="border:1px solid #ccc; padding:5px; text-align:right;"><strong>${f3(SA)}</strong> m/sÂ²</td>
                </tr>
                <tr>
                    <td style="border:1px solid #ccc; padding:5px;">å¿œç­”å¤‰ä½ Sd</td>
                    <td style="border:1px solid #ccc; padding:5px;">Sd = Sâ‚ Ã— (Tâ‚‘/2Ï€)Â² = ${f3(SA)} Ã— (${f4(Te)}/2Ï€)Â²</td>
                    <td style="border:1px solid #ccc; padding:5px; text-align:right;"><strong>${f4(SD)}</strong> m</td>
                </tr>
                <tr style="background:#fffacd;">
                    <td style="border:1px solid #ccc; padding:5px;"><strong>å¿…è¦è€åŠ› Qn</strong></td>
                    <td style="border:1px solid #ccc; padding:5px;">Qn = Sâ‚ Ã— Mâ‚‘ = ${f3(SA)} Ã— ${f3(Me)}</td>
                    <td style="border:1px solid #ccc; padding:5px; text-align:right;"><strong>${f2(Qn)}</strong> kN</td>
                </tr>
            </table>
        </div>
        
        </div>
    </div>`;
    
    return html;
}

// å¤‰å½¢ãƒ¢ãƒ¼ãƒ‰ï¼ˆä¸²å›£å­ï¼‰ã‚°ãƒ©ãƒ•æç”»
// 2. å¤‰å½¢ãƒ¢ãƒ¼ãƒ‰å›³æç”»é–¢æ•°ï¼ˆé‡ã­åˆã‚ã›å¯¾å¿œãƒ»ãƒ©ãƒ™ãƒ«ä½ç½®èª¿æ•´ï¼‰
// 2. å¤‰å½¢ãƒ¢ãƒ¼ãƒ‰å›³æç”»é–¢æ•°ï¼ˆé«˜è§£åƒåº¦å¯¾å¿œãƒ»é‡ã­åˆã‚ã›ç‰ˆï¼‰
// 2. å¤‰å½¢ãƒ¢ãƒ¼ãƒ‰å›³æç”»é–¢æ•°ï¼ˆé«˜è§£åƒåº¦å¯¾å¿œãƒ»å‡¡ä¾‹ä½ç½®èª¿æ•´ç‰ˆï¼‰
// 2. å¤‰å½¢ãƒ¢ãƒ¼ãƒ‰å›³æç”»é–¢æ•°ï¼ˆæ•°å€¤åˆ‡ã‚Œå¯¾ç­–ãƒ»å¹…ä¸€æ¯æ‹¡å¤§ç‰ˆï¼‰
function drawStickModel(canvasId, b, ptD, ptS) {
    const canvas = document.getElementById(canvasId);
    if(!canvas) return;
    
    // 1. ãƒ‡ãƒã‚¤ã‚¹ãƒ”ã‚¯ã‚»ãƒ«æ¯”ã‚’å–å¾—
    const dpr = window.devicePixelRatio || 1;

    // 2. è¡¨ç¤ºã‚µã‚¤ã‚ºï¼ˆCSSã‚µã‚¤ã‚ºï¼‰ã®æ±ºå®š
    let rect = canvas.parentElement.getBoundingClientRect();
    let cssW = rect.width;
    if (!cssW || cssW === 0) cssW = 400; 
    const cssH = 350; // å›ºå®šé«˜ã•

    // 3. Canvasã®å†…éƒ¨è§£åƒåº¦ã‚’è¨­å®š
    canvas.width = cssW * dpr;
    canvas.height = cssH * dpr;

    // 4. ã‚¹ã‚¿ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’è¨­å®š
    canvas.style.width = cssW + "px";
    canvas.style.height = cssH + "px";

    const ctx = canvas.getContext('2d');
    
    // 5. æç”»åº§æ¨™ç³»ã®ã‚¹ã‚±ãƒ¼ãƒ«
    ctx.scale(dpr, dpr);

    const W = cssW;
    const H = cssH;
    
    ctx.clearRect(0, 0, W, H);
    
    if(!ptD && !ptS) {
        ctx.fillStyle = "#999";
        ctx.textAlign = "center";
        ctx.fillText("è¨ˆç®—çµæœãªã—", W/2, H/2);
        return;
    }

    // ã€ä¿®æ­£1ã€‘å·¦å³ãƒãƒ¼ã‚¸ãƒ³ã‚’åºƒã’ã¦æ•°å€¤åˆ‡ã‚Œã‚’é˜²æ­¢ï¼ˆ50 -> 80ï¼‰
    const margin = { top: 40, bottom: 60, left: 80, right: 80 };
    const chartH = H - margin.top - margin.bottom;
    const centerX = W / 2;
    
    const totalH = b.H1 + b.H2;
    
    // æœ€å¤§å¤‰ä½ã‚’å–å¾—ã—ã¦ã‚¹ã‚±ãƒ¼ãƒ«æ±ºå®š
    let maxDisp = 0;
    if (ptD) maxDisp = Math.max(maxDisp, Math.abs(ptD.dZ1 || 0), (b.stories === 2 ? Math.abs(ptD.dZ2 || 0) : 0));
    if (ptS) maxDisp = Math.max(maxDisp, Math.abs(ptS.dZ1 || 0), (b.stories === 2 ? Math.abs(ptS.dZ2 || 0) : 0));
    
    // å¤‰ä½ãŒæ¥µç«¯ã«å°ã•ã„å ´åˆã®ã‚¼ãƒ­é™¤ç®—é˜²æ­¢ï¼ˆæœ€å°å€¤ã‚’è¨­å®šï¼‰
    const dispLimit = Math.max(maxDisp, totalH * 1/1000); 
    
    // ã€ä¿®æ­£2ã€‘æç”»ã‚¨ãƒªã‚¢ä¸€æ¯ã¾ã§ã‚°ãƒ©ãƒ•ã‚’æ‹¡å¤§ã™ã‚‹è¨ˆç®—å¼ã«å¤‰æ›´
    // (W/2 - margin.right) ã¯ä¸­å¿ƒã‹ã‚‰å³ç«¯ã¾ã§ã®æç”»å¯èƒ½å¹…
    const scaleX = (W / 2 - margin.right) / dispLimit;
    const scaleY = chartH / totalH;
    
    const toY = (h) => H - margin.bottom - (h * scaleY);
    const toX = (d) => centerX + (d * scaleX);

    // --- åŸºæº–ç·šã®æç”» ---
    
    // ä¸­å¿ƒè»¸
    ctx.strokeStyle = "#e0e0e0";
    ctx.lineWidth = 1;
    ctx.setLineDash([4, 4]);
    ctx.beginPath();
    ctx.moveTo(centerX, margin.top); 
    ctx.lineTo(centerX, H - margin.bottom);
    ctx.stroke();
    
    // ãƒ•ãƒ­ã‚¢ãƒ©ã‚¤ãƒ³
    ctx.setLineDash([]);
    const drawFloorLine = (h, name) => {
        const y = toY(h);
        ctx.beginPath();
        // ãƒãƒ¼ã‚¸ãƒ³é ˜åŸŸã‚‚å«ã‚ã¦ç·šã‚’å¼•ãã€ç«¯ã¾ã§ã—ã£ã‹ã‚Šè¦‹ã›ã‚‹
        ctx.moveTo(10, y); ctx.lineTo(W-10, y);
        ctx.stroke();
        ctx.fillStyle = "#999";
        ctx.textAlign = "left";
        ctx.font = "11px sans-serif";
        ctx.fillText(name, 5, y - 4);
    };
    
    drawFloorLine(0, "GL");
    drawFloorLine(b.H1, (b.stories===2 ? "2F" : "R"));
    if(b.stories === 2) drawFloorLine(b.H1 + b.H2, "R");

    // å›ºå®šç«¯
    ctx.fillStyle = "#333";
    ctx.fillRect(centerX - 15, toY(0), 30, 4);

    // --- ãƒ¢ãƒ‡ãƒ«æç”»å‡¦ç† ---
    const drawModel = (pt, color, labelAlign) => {
        if(!pt) return;
        
        const dZ1 = pt.dZ1 || 0;
        const dZ2 = pt.dZ2 || 0;
        
        const n0 = { x: centerX, y: toY(0) };
        const n1 = { x: toX(dZ1), y: toY(b.H1) };
        const n2 = (b.stories === 2) ? { x: toX(dZ2), y: toY(b.H1 + b.H2) } : null;

        // ä¸²
        ctx.strokeStyle = color;
        ctx.lineWidth = 3;
        ctx.lineJoin = "round";
        ctx.beginPath();
        ctx.moveTo(n0.x, n0.y);
        ctx.lineTo(n1.x, n1.y);
        if(n2) ctx.lineTo(n2.x, n2.y);
        ctx.stroke();

        // å›£å­
        const drawNode = (n, disp, drift) => {
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(n.x, n.y, 5, 0, Math.PI*2);
            ctx.fill();
            ctx.strokeStyle = "#fff";
            ctx.lineWidth = 1;
            ctx.stroke();
            
            // ãƒ©ãƒ™ãƒ«
            ctx.fillStyle = color;
            ctx.font = "bold 11px sans-serif";
            
            const isLeft = (labelAlign === 'left');
            ctx.textAlign = isLeft ? "right" : "left";
            const xOffset = isLeft ? -12 : 12;
            
            ctx.fillText((disp*1000).toFixed(1) + "mm", n.x + xOffset, n.y + 4);
            
            if(drift > 0) {
                 ctx.font = "10px sans-serif";
                 const invN = Math.round(1/drift);
                 ctx.fillText(`1/${invN}`, n.x + xOffset, n.y + 16);
            }
        };

        drawNode(n1, dZ1, pt.R1);
        if(n2) drawNode(n2, dZ2, pt.R2);
    };

    // é‡ã­åˆã‚ã›æç”»
    drawModel(ptD, '#28a745', 'left');
    drawModel(ptS, '#dc3545', 'right');
    
    // --- å‡¡ä¾‹ã®æç”» ---
    ctx.textAlign = "center";
    ctx.font = "bold 12px sans-serif";
    const legendY = H - 20; 
    
    ctx.fillStyle = "#28a745"; 
    ctx.fillText("â— æå‚·é™ç•Œ", centerX - 60, legendY);
    
    ctx.fillStyle = "#dc3545"; 
    ctx.fillText("â— å®‰å…¨é™ç•Œ", centerX + 60, legendY);
}// 1. è¡¨ç¤ºæ›´æ–°ç”¨é–¢æ•°ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«å‰Šé™¤ãƒ»ã‚­ãƒ£ãƒ³ãƒã‚¹çµ±åˆï¼‰
function updateView(dir, resObj, ptD, ptS, limitD, limitS) {
    let ratingHtml = "";
    let maxQaStep = resObj.steps.reduce((prev, current) => (prev.QA > current.QA) ? prev : current, resObj.steps[0]);
    let Qsi = maxQaStep.QA;
    let Qsni = maxQaStep.Qns;
    let ratio = (Qsni > 0) ? Qsi / Qsni : 0;
    let rate = getRating(ratio);
    ratingHtml = `<div class="rating-box">è©•ç‚¹: ${ratio.toFixed(2)} <span class="badge ${rate.cls}">${rate.text}</span></div>`;

    const is1F = (calcRes.b.stories === 1);
    const sumW1 = calcRes.b.W1 + calcRes.b.W2;
    const sumW2 = calcRes.b.W2;

    // --- åˆ¤å®šçµæœã‚µãƒãƒªãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ« ---
    const head = is1F 
        ? `<tr><th>æ¤œè¨ã‚±ãƒ¼ã‚¹</th><th>1Få¤‰å½¢</th><th>1Fè€åŠ›(kN)</th><th>1Fä¿‚æ•°</th><th>åˆ¤å®š</th></tr>` 
        : `<tr><th>æ¤œè¨ã‚±ãƒ¼ã‚¹</th><th>1Få¤‰å½¢</th><th>1Fè€åŠ›(kN)</th><th>1Fä¿‚æ•°</th><th>åˆ¤å®š</th><th>2Få¤‰å½¢</th><th>2Fè€åŠ›(kN)</th><th>2Fä¿‚æ•°</th><th>åˆ¤å®š</th></tr>`;

    const fmt = (p, label, limInv) => {
        if(!p) return `<tr><td>${label}</td><td colspan="${is1F?4:8}" style="color:red; font-weight:bold;">äº¤ç‚¹ãªã— (NG or å´©å£Š)</td></tr>`;
        
        let r1 = p.R1, inv1 = (r1>0)?Math.round(1/r1):'-';
        let j1 = (r1 <= 1/limInv) ? '<span class="badge badge-ok">OK</span>' : '<span class="badge badge-ng">NG</span>';
        if(r1 > 1/15) j1='<span class="badge badge-ng">å€’å£Š</span>';
        
        let dispQ1 = (r1 > resObj.R1_atQ1max) ? resObj.Q1max : p.Q1;
        let c1 = (dispQ1 / sumW1).toFixed(2);
        let cell1 = `<td>1/${inv1}<br>(${Math.round(p.dZ1*1000)}mm)</td><td>${dispQ1.toFixed(1)}</td><td>${c1}</td><td>${j1}</td>`;
        
        if(is1F) return `<tr><td>${label}</td>${cell1}</tr>`;
        
        let r2 = p.R2, inv2 = (r2>0)?Math.round(1/r2):'-';
        let j2 = (r2 <= 1/limInv) ? '<span class="badge badge-ok">OK</span>' : '<span class="badge badge-ng">NG</span>';
        if(r2 > 1/15) j2='<span class="badge badge-ng">å€’å£Š</span>';
        
        let dispQ2 = (r2 > resObj.R2_atQ2max) ? resObj.Q2max : p.Q2;
        let c2 = (sumW2 > 0) ? (dispQ2 / sumW2).toFixed(2) : '-';
        return `<tr><td>${label}</td>${cell1}<td>1/${inv2}<br>(${Math.round(p.sub*1000)}mm)</td><td>${dispQ2.toFixed(1)}</td><td>${c2}</td><td>${j2}</td></tr>`;
    };
    
    const summaryTableHtml = `<table class="data-table"><thead>${head}</thead><tbody>${fmt(ptD, `æå‚·é™ç•Œ(1/${limitD})`, limitD)}${fmt(ptS, `å®‰å…¨é™ç•Œ(1/${limitS})`, limitS)}</tbody></table>`;
    
    // --- å¤‰å½¢ãƒ¢ãƒ¼ãƒ‰è©³ç´°ï¼ˆã‚°ãƒ©ãƒ•ã®ã¿ãƒ»é‡ã­åˆã‚ã›ï¼‰ ---
    
    // ã‚­ãƒ£ãƒ³ãƒã‚¹æ ã®ã¿ã‚’ç”Ÿæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆå‡¦ç†ã‚’å‰Šé™¤ï¼‰
    const createCanvasOnlyBlock = (title, canvasId) => {
        // é«˜ã•æŒ‡å®šï¼šãƒ†ãƒ¼ãƒ–ãƒ«ãŒãªããªã£ãŸåˆ†ã€ã‚°ãƒ©ãƒ•ãŒè¦‹ã‚„ã™ã„ã‚ˆã†ã«å°‘ã—é«˜ã•ã‚’ç¢ºä¿
        let cvs = `<div style="width:100%; height:350px; border:1px solid #eee; background:#fff;"><canvas id="${canvasId}" style="width:100%; height:100%;"></canvas></div>`;
        
        return `<div style="flex:1; min-width:280px; border:1px solid #ddd; padding:10px; border-radius:5px; background:#fafafa;">
            <div style="font-weight:bold; color:#005a9c; margin-bottom:10px; border-bottom:1px solid #ccc;">${title}</div>
            ${cvs}
        </div>`;
    };

    const idScreen = `canvas-mode-${dir}-screen`;
    const idPrint = `canvas-mode-${dir}-print`;
    
    // ç”»é¢ç”¨HTML
    const modeHtmlScreen = `<div style="display:flex; flex-wrap:wrap; gap:15px; margin-top:15px;">
        ${createCanvasOnlyBlock("å¤‰å½¢ãƒ¢ãƒ¼ãƒ‰å›³ï¼ˆæå‚·ãƒ»å®‰å…¨ é‡ã­åˆã‚ã›ï¼‰", idScreen)}
    </div>`;

    // å°åˆ·ç”¨HTML
    const modeHtmlPrint = `<div style="display:flex; flex-wrap:wrap; gap:15px; margin-top:15px;">
        ${createCanvasOnlyBlock("å¤‰å½¢ãƒ¢ãƒ¼ãƒ‰å›³ï¼ˆæå‚·ãƒ»å®‰å…¨ é‡ã­åˆã‚ã›ï¼‰", idPrint)}
    </div>`;
    
    // HTMLåæ˜ 
    document.getElementById(`summary-${dir}-table`).innerHTML = summaryTableHtml + ratingHtml + modeHtmlScreen;
    document.getElementById(`rep-res-${dir}-table`).innerHTML = summaryTableHtml + ratingHtml + modeHtmlPrint;
    
    // ã‚°ãƒ©ãƒ•æç”»
    drawChart(`chart-${dir}`, resObj.steps, ptD, ptS);
    
    // â–¼â–¼â–¼ ä¿®æ­£: DOMç”Ÿæˆç›´å¾Œã¯è¦ªè¦ç´ ã®ã‚µã‚¤ã‚ºå–å¾—ãŒæ­£ã—ãè¡Œãˆãªã„å ´åˆãŒã‚ã‚‹ãŸã‚ã€æç”»ã‚’å°‘ã—é…å»¶ã•ã›ã‚‹ â–¼â–¼â–¼
    setTimeout(() => {
        // é‡ã­åˆã‚ã›æç”»ã‚’å®Ÿè¡Œ
        drawStickModel(idScreen, calcRes.b, ptD, ptS);
        drawStickModel(idPrint, calcRes.b, ptD, ptS);
    }, 100); 
    // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²
}

function renderLog(dir, steps) {
    const fmtR = (v) => { if(v<=0) return '-'; return `1/${Math.round(1/v)}<br>(${v.toFixed(5)})`; };
    const is1F = (calcRes.b.stories === 1);
    let h = `<table class="log-table"><thead><tr class="log-header-group">`;
    h += `<th colspan="${is1F?3:5}">å¤‰ä½ãƒ»å‰›æ€§ãƒ»å±¤ã›ã‚“æ–­åŠ›</th>`;
    h += is1F ? `<th colspan="2">æŒ¯å‹•ãƒ¢ãƒ¼ãƒ‰</th>` : `<th colspan="4">æŒ¯å‹•ãƒ¢ãƒ¼ãƒ‰</th>`;
    h += `<th colspan="6">ç­‰ä¾¡1è‡ªç”±åº¦ç³»</th><th colspan="8">æ¸›è¡°ãƒ»èª¿æ•´ä¿‚æ•°</th><th colspan="6">æå‚·é™ç•Œ</th><th colspan="6">å®‰å…¨é™ç•Œ</th></tr><tr>`;
    h += `<th>å±¤é–“å¤‰å½¢è§’R<br>(rad)</th>`;
    if(!is1F) h += `<th>Q2<br>(kN)</th>`;
    h += `<th>Q1<br>(kN)</th>`;
    if(!is1F) h += `<th>K2<br>(kN/m)</th>`;
    h += `<th>K1<br>(kN/m)</th>`;
    if(!is1F) h += `<th>u2/u1</th><th>Î´Z2<br>(m)</th>`;
    h += `<th>Î´Z1<br>(m)</th>`;
    if(!is1F) h += `<th>Î´2<br>(m)</th>`;
    h += `<th>Me<br>(t)</th><th>Î”<br>(m)</th><th>Qa<br>(kN)</th><th>Ke<br>(kN/m)</th><th>Te<br>(s)</th><th>He<br>(m)</th>
          <th>Î”W<br>(kNãƒ»m)</th><th>Wa<br>(kNãƒ»m)</th><th>heq1</th><th>heq2</th><th>h</th><th>Fh</th><th>p</th><th>q</th>
          <th>S0d</th><th>Gs</th><th>SAd</th><th>SDd</th><th>Qnd</th><th>reqR</th>
          <th>S0s</th><th>Gs</th><th>SAs</th><th>SDs</th><th>Qns</th><th>reqR</th></tr></thead><tbody>`;

    steps.forEach((s, i) => {
        h += `<tr><td style="background:#eef;">${fmtR(s.R)}</td>`;
        if(!is1F) h += `<td>${s.Q2.toFixed(1)}</td>`;
        h += `<td>${s.Q1.toFixed(1)}</td>`;
        if(!is1F) h += `<td>${s.K2.toFixed(0)}</td>`;
        h += `<td>${s.K1.toFixed(0)}</td>`;
        if(!is1F) h += `<td>${s.uRat.toFixed(3)}</td><td>${s.dZ2.toFixed(4)}</td>`;
        h += `<td>${s.dZ1.toFixed(4)}</td>`;
        if(!is1F) h += `<td>${s.sub.toFixed(4)}</td>`;
        h += `<td>${s.MU.toFixed(2)}</td><td>${s.D.toFixed(4)}</td><td style="background:#eef;">${s.QA.toFixed(1)}</td><td>${s.Ke.toFixed(0)}</td><td>${s.Te.toFixed(3)}</td><td>${s.H.toFixed(2)}</td>
            <td>${s.dW.toFixed(1)}</td><td>${s.WA.toFixed(1)}</td><td>${s.heq1.toFixed(4)}</td><td>${s.heq2.toFixed(4)}</td><td>${s.h.toFixed(3)}</td>
            <td>${s.Fh.toFixed(2)}</td><td>${s.p.toFixed(2)}</td><td>${s.q.toFixed(2)}</td>
            <td>${s.S0d.toFixed(2)}</td><td>${s.Gs.toFixed(2)}</td>
            <td>${s.SAd.toFixed(2)}</td><td>${s.SDd.toFixed(4)}</td><td style="font-weight:bold; color:${s.QA>=s.Qnd?'blue':'red'}">${s.Qnd.toFixed(1)}</td>
            <td>${fmtR(s.reqRd)}</td>
            <td>${s.S0s.toFixed(2)}</td><td>${s.Gs.toFixed(2)}</td>
            <td>${s.SAs.toFixed(2)}</td><td>${s.SDs.toFixed(4)}</td><td style="font-weight:bold; color:${s.QA>=s.Qns?'blue':'red'}">${s.Qns.toFixed(1)}</td>
            <td>${fmtR(s.reqRs)}</td></tr>`;
    });
    h += '</tbody></table>';
    document.getElementById(`log-container-${dir}`).innerHTML = h;
    // è¨ˆç®—æ›¸ç”¨ã®ãƒ­ã‚°ã¯ printReport æ™‚ã« renderLogSplit ã§å‡ºåŠ›ã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯å‡ºåŠ›ã—ãªã„
}

// ä¿æœ‰è€åŠ› vs å¿…è¦è€åŠ› ã‚°ãƒ©ãƒ•æç”»é–¢æ•°ï¼ˆå¤ªç·šåŒ–ãƒ»å…¨ç¯„å›²æç”»ç‰ˆï¼‰
function drawChart(id, steps, ptD, ptS) {
    const ctx = document.getElementById(id);
    if(!ctx) return; 
    const ctx2d = ctx.getContext('2d');
    if(chartObjs[id]) chartObjs[id].destroy();

    // --- ä¿®æ­£: æç”»ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆ ---
    // ä»¥å‰ã¯äº¤ç‚¹ä»˜è¿‘ã§ãƒ‡ãƒ¼ã‚¿ã‚’åˆ‡ã‚Šå–ã£ã¦ã„ã¾ã—ãŸãŒ(slice)ã€
    // ãƒ©ã‚¤ãƒ³ãŒé€”åˆ‡ã‚Œã‚‹åŸå› ã¨ãªã‚‹ãŸã‚ã€å…¨ã‚¹ãƒ†ãƒƒãƒ—ã‚’æç”»ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä½¿ç”¨ã—ã¾ã™ã€‚
    
    // ä¿æœ‰è€åŠ›ï¼ˆCapacityï¼‰
    const cap = steps.filter(s => s.QA >= 0).map(s => ({ x: (s.H > 0 ? s.D / s.H : 0), y: s.QA }));
    
    // å¿…è¦è€åŠ›ï¼ˆDemandï¼‰ - å…¨ç¯„å›²ã‚’ä½¿ç”¨
    const demD = steps.map(s => ({ x: (s.H > 0 ? s.SDd / s.H : 0), y: s.Qnd }));
    const demS = steps.map(s => ({ x: (s.H > 0 ? s.SDs / s.H : 0), y: s.Qns }));

    // è»¸ã®æœ€å¤§å€¤ã‚’æ±ºå®šï¼ˆä¿æœ‰è€åŠ›æ›²ç·šã‚’åŸºæº–ã«ã™ã‚‹ï¼‰
    let maxX = 0, maxY = 0;
    cap.forEach(p => { if(p.x > maxX) maxX = p.x; if(p.y > maxY) maxY = p.y; });
    const xMax = maxX * 1.1; 
    const yMax = maxY * 1.1;

    // äº¤ç‚¹ãƒã‚¤ãƒ³ãƒˆã®ä½œæˆ
    const points = [];
    if(ptD) points.push({ x: (ptD.H > 0 ? ptD.D / ptD.H : 0), y: ptD.QA, label: 'æå‚·é™ç•Œ', bg: '#28a745', style: 'rectRot' });
    if(ptS) points.push({ x: (ptS.H > 0 ? ptS.D / ptS.H : 0), y: ptS.QA, label: 'å®‰å…¨é™ç•Œ', bg: '#dc3545', style: 'circle' });
    
    chartObjs[id] = new Chart(ctx2d, {
        type: 'scatter',
        data: { datasets: [
            { 
                label: 'ä¿æœ‰è€åŠ›(QA)', 
                data: cap, 
                borderColor: '#005a9c', 
                borderWidth: 2, // å®Ÿç·šã¯æ¨™æº–ã®å¤ªã•
                showLine: true, 
                pointRadius: 0 
            },
            { 
                label: 'å¿…è¦è€åŠ›(æå‚·)', 
                data: demD, 
                borderColor: '#28a745', 
                borderWidth: 3, // ã€ä¿®æ­£ã€‘å¤ªã•ã‚’ 1.5 -> 3 ã«å¤‰æ›´
                borderDash: [5,5], 
                showLine: true, 
                pointRadius: 0 
            },
            { 
                label: 'å¿…è¦è€åŠ›(å®‰å…¨)', 
                data: demS, 
                borderColor: '#dc3545', 
                borderWidth: 3, // ã€ä¿®æ­£ã€‘å¤ªã•ã‚’ 1.5 -> 3 ã«å¤‰æ›´
                borderDash: [2,2], 
                showLine: true, 
                pointRadius: 0 
            },
            ...points.map(p => ({ 
                label: p.label, 
                data: [{x: p.x, y: p.y}], 
                backgroundColor: p.bg, 
                pointRadius: 6, 
                pointStyle: p.style 
            }))
        ]},
        options: { 
            animation: false,
            responsive: true, 
            maintainAspectRatio: false, 
            scales: { 
                x: { 
                    type: 'linear', 
                    position: 'bottom', 
                    title: { display: true, text: 'å¤‰å½¢è§’ Î”/He (rad)' }, 
                    max: xMax // ä¿æœ‰è€åŠ›ã®ç¯„å›²ã§è¡¨ç¤ºã‚’ã‚¯ãƒªãƒƒãƒ—
                }, 
                y: { 
                    title: { display: true, text: 'ã›ã‚“æ–­åŠ› Q (kN)' }, 
                    max: yMax // ä¿æœ‰è€åŠ›ã®ç¯„å›²ã§è¡¨ç¤ºã‚’ã‚¯ãƒªãƒƒãƒ—
                } 
            }, 
            plugins: { 
                tooltip: { 
                    callbacks: { 
                        label: c => `(${c.parsed.x.toFixed(4)}rad, ${c.parsed.y.toFixed(1)}kN)` 
                    } 
                } 
            } 
        }
    });
}

// PDFç”Ÿæˆé–¢æ•°ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ã‚’ç½®ãæ›ãˆï¼‰
function generatePDF() {
    if(!calcRes.b) { alert('è¨ˆç®—ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„'); return; }
    
    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’å–å¾—
    const showCover = document.getElementById('chk-rep-cover').checked;
    const showOverview = document.getElementById('chk-rep-overview').checked;
    const showForce = document.getElementById('chk-rep-force').checked;
    const showResult = document.getElementById('chk-rep-result').checked;
    const showLogic = document.getElementById('chk-rep-logic').checked;
    const showLog = document.getElementById('chk-rep-log').checked;
    const showDetail = document.getElementById('chk-rep-detail').checked;
    const showShear = document.getElementById('chk-rep-shear').checked;
    const skipY = calcRes.skipY || false;
    
    // report-viewã‚’ä¸€æ™‚çš„ã«è¡¨ç¤º
    const reportView = document.getElementById('report-view');
    reportView.style.display = 'block';
    reportView.style.position = 'absolute';
    reportView.style.left = '-9999px';
    
    // è¡¨ç´™ã®å‡¦ç†
    const coverPage = document.getElementById('rep-page-cover');
    const tocPage = document.getElementById('rep-page-toc');
    
    if (showCover) {
        coverPage.style.display = 'block';
        tocPage.style.display = 'block';
        
        // å…¥åŠ›å€¤ã‚’åæ˜ 
        const projectName = document.getElementById('inp_cover_project_name').value;
        document.getElementById('rep-cover-project-name').innerText = projectName;
        document.getElementById('rep-cover-date').innerText = document.getElementById('inp_cover_date').value;
        document.getElementById('rep-cover-company').innerText = document.getElementById('inp_cover_company').value;
        
        const offReg = document.getElementById('inp_cover_office_reg').value;
        document.getElementById('rep-cover-office-reg').innerText = offReg ? "äº‹å‹™æ‰€ç™»éŒ²: " + offReg : "";
        
        const archReg = document.getElementById('inp_cover_arch_reg').value;
        document.getElementById('rep-cover-arch-reg').innerText = archReg ? "å»ºç¯‰å£«ç™»éŒ²: " + archReg : "";
        
        const mgrName = document.getElementById('inp_cover_manager_name').value;
        document.getElementById('rep-cover-manager-name').innerText = mgrName ? "ç®¡ç†å»ºç¯‰å£«: " + mgrName : "";
        
        // ç›®æ¬¡ã«å»ºç‰©åã‚’è¡¨ç¤º
        document.getElementById('rep-toc-building-name').innerText = projectName;
        
        // overview-2ãƒšãƒ¼ã‚¸ã®å»ºç‰©åã‚‚è¨­å®š
        document.getElementById('rep-building-name-2').innerText = projectName;
        
        // ç›®æ¬¡ã‚’ç”Ÿæˆ
        generateTableOfContents(showOverview, showForce, showResult, showLogic, showLog, showDetail, showShear, skipY);
    } else {
        coverPage.style.display = 'none';
        tocPage.style.display = 'none';
    }

    // ãƒšãƒ¼ã‚¸ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’è¨­å®š
    document.getElementById('rep-page-overview').style.display = showOverview ? 'block' : 'none';
    document.getElementById('rep-page-overview-2').style.display = showOverview ? 'block' : 'none';
    document.getElementById('rep-page-force-x').style.display = showForce ? 'block' : 'none';
    document.getElementById('rep-page-force-y').style.display = (showForce && !skipY) ? 'block' : 'none';
    document.getElementById('rep-page-result-x').style.display = showResult ? 'block' : 'none';
    document.getElementById('rep-page-result-y').style.display = (showResult && !skipY) ? 'block' : 'none';
    document.getElementById('rep-page-logic').style.display = showLogic ? 'block' : 'none';
    document.getElementById('rep-page-logic-2').style.display = showLogic ? 'block' : 'none';
    document.getElementById('rep-page-log-x1').style.display = showLog ? 'block' : 'none';
    document.getElementById('rep-page-log-x2').style.display = showLog ? 'block' : 'none';
    document.getElementById('rep-page-log-x3').style.display = showLog ? 'block' : 'none';
    document.getElementById('rep-page-log-y1').style.display = (showLog && !skipY) ? 'block' : 'none';
    document.getElementById('rep-page-log-y2').style.display = (showLog && !skipY) ? 'block' : 'none';
    document.getElementById('rep-page-log-y3').style.display = (showLog && !skipY) ? 'block' : 'none';
    document.getElementById('rep-page-detail-x1').style.display = showDetail ? 'block' : 'none';
    document.getElementById('rep-page-detail-x2').style.display = showDetail ? 'block' : 'none';
    document.getElementById('rep-page-detail-x3').style.display = showDetail ? 'block' : 'none';
    document.getElementById('rep-page-detail-x4').style.display = showDetail ? 'block' : 'none';
    document.getElementById('rep-page-detail-y1').style.display = (showDetail && !skipY) ? 'block' : 'none';
    document.getElementById('rep-page-detail-y2').style.display = (showDetail && !skipY) ? 'block' : 'none';
    document.getElementById('rep-page-detail-y3').style.display = (showDetail && !skipY) ? 'block' : 'none';
    document.getElementById('rep-page-detail-y4').style.display = (showDetail && !skipY) ? 'block' : 'none';
    document.getElementById('rep-page-shear1').style.display = (showShear && document.getElementById('chk_calc_shear_force').checked) ? 'block' : 'none';
    document.getElementById('rep-page-shear2').style.display = (showShear && document.getElementById('chk_calc_shear_force').checked) ? 'block' : 'none';
    
    const charts = skipY ? ['chart-x'] : ['chart-x', 'chart-y']; 
    charts.forEach(id => {
        const canvas = document.getElementById(id);
        const imgId = (id === 'chart-x') ? 'rep-img-x' : 'rep-img-y';
        if(canvas) {
            const imgData = canvas.toDataURL('image/png');
            document.getElementById(imgId).src = imgData;
        }
    });
    
    // å„ç¨®ãƒ¬ãƒãƒ¼ãƒˆè¦ç´ ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    if(showForce) renderForceDetails();
    if(showOverview) {
        renderGsSpectrumReport();
        renderSa0Report();
        renderPqReport();
    }
    if(showLogic) renderLogicSection();
    if(showLog) {
        renderLogSplit('x', calcRes.resX.steps);
        if(!skipY) renderLogSplit('y', calcRes.resY.steps);
    }
    
    // å¾©å…ƒåŠ›ç‰¹æ€§ã‚°ãƒ©ãƒ•ã‚’æç”»
    setTimeout(() => {
        if(showForce) {
            drawForceChart('rep-chart-force-x', 'x');
            if(!skipY) drawForceChart('rep-chart-force-y', 'y');
        }
        
        // PDFç”Ÿæˆã‚’å®Ÿè¡Œ
        executePDFGeneration(reportView);
    }, 300);
}

// PDFç”Ÿæˆå®Ÿè¡Œé–¢æ•°ï¼ˆjsPDF + html2canvasä½¿ç”¨ï¼‰
async function executePDFGeneration(reportView) {
    try {
        const { jsPDF } = window.jspdf;
        
        // é€²æ—ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        const modal = document.getElementById('progressModal');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        modal.style.display = 'flex';
        
        function updateProgress(percent, text) {
            progressFill.style.width = percent + '%';
            progressText.textContent = text;
        }
        
        updateProgress(5, 'æº–å‚™ä¸­...');
        
        // MathJaxå‡¦ç†å¾…ã¡
        if (window.MathJax && window.MathJax.Hub) {
            updateProgress(10, 'æ•°å¼ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸­...');
            await new Promise(resolve => {
                MathJax.Hub.Queue(['Typeset', MathJax.Hub, reportView]);
                MathJax.Hub.Queue(resolve);
            });
        }
        await new Promise(r => setTimeout(r, 300));
        
        // ãƒ¬ãƒãƒ¼ãƒˆãƒ“ãƒ¥ãƒ¼ã‚’å¯è¦–åŒ–ï¼ˆopacity:0ã§éè¡¨ç¤ºã ãŒæç”»ã•ã‚Œã‚‹ï¼‰
        reportView.style.position = 'fixed';
        reportView.style.left = '0';
        reportView.style.top = '0';
        reportView.style.opacity = '0';
        reportView.style.pointerEvents = 'none';
        reportView.style.zIndex = '-1';
        reportView.style.width = '210mm';
        
        // ã™ã¹ã¦ã®ãƒšãƒ¼ã‚¸è¦ç´ ã‚’å–å¾—
        const pages = reportView.querySelectorAll('.report-page');
        if (pages.length === 0) {
            throw new Error('ãƒšãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
        
        updateProgress(15, `${pages.length}ãƒšãƒ¼ã‚¸ã‚’å‡¦ç†ä¸­...`);
        
        // PDFåˆæœŸåŒ–ï¼ˆA4ã‚µã‚¤ã‚ºï¼‰
        const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a4'
        });
        
        const pageWidth = 210;  // A4å¹…(mm)
        const pageHeight = 297; // A4é«˜ã•(mm)
        
        let firstPage = true;
        
        // å„ãƒšãƒ¼ã‚¸ã‚’å‡¦ç†
        for (let i = 0; i < pages.length; i++) {
            const page = pages[i];
            
            // éè¡¨ç¤ºãƒšãƒ¼ã‚¸ã¯ã‚¹ã‚­ãƒƒãƒ—
            if (page.style.display === 'none') continue;
            
            const pageNum = i + 1;
            const progress = 15 + Math.floor((i / pages.length) * 75);
            updateProgress(progress, `ãƒšãƒ¼ã‚¸ ${pageNum}/${pages.length} ã‚’å‡¦ç†ä¸­...`);
            
            // ãƒšãƒ¼ã‚¸ã‚µã‚¤ã‚ºã‚’å›ºå®š
            page.style.width = '210mm';
            page.style.minHeight = '297mm';
            page.style.maxHeight = '297mm';
            
            // å°‘ã—å¾…æ©Ÿã—ã¦ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å®Œäº†ã‚’ç¢ºä¿
            await new Promise(r => setTimeout(r, 100));
            
            // html2canvasã§ã‚­ãƒ£ãƒ—ãƒãƒ£ï¼ˆA4ã‚µã‚¤ã‚ºã«åˆã‚ã›ãŸè¨­å®šï¼‰
            const canvas = await html2canvas(page, {
                scale: 2,
                useCORS: true,
                logging: false,
                backgroundColor: '#ffffff',
                width: page.offsetWidth,
                height: Math.max(page.offsetHeight, 1122), // 297mm = ç´„1122px (at 96dpi)
                windowWidth: page.offsetWidth,
                windowHeight: Math.max(page.offsetHeight, 1122)
            });
            
            // Canvasç”»åƒã‚’PDFã«è¿½åŠ 
            const imgData = canvas.toDataURL('image/jpeg', 0.95);
            
            // æ–°ã—ã„ãƒšãƒ¼ã‚¸ã‚’è¿½åŠ ï¼ˆåˆãƒšãƒ¼ã‚¸ä»¥å¤–ï¼‰
            if (!firstPage) {
                pdf.addPage();
            }
            firstPage = false;
            
            // A4ã‚µã‚¤ã‚ºã´ã£ãŸã‚Šã«é…ç½®
            pdf.addImage(imgData, 'JPEG', 0, 0, pageWidth, pageHeight);
        }
        
        // ãƒ¬ãƒãƒ¼ãƒˆãƒ“ãƒ¥ãƒ¼ã‚’éè¡¨ç¤ºã«æˆ»ã™
        reportView.style.position = 'absolute';
        reportView.style.left = '-9999px';
        reportView.style.opacity = '1';
        reportView.style.display = 'none';
        
        // PDFä¿å­˜
        updateProgress(90, 'PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ä¸­...');
        await new Promise(r => setTimeout(r, 200));
        
        const filename = 'æ§‹é€ è¨ˆç®—æ›¸_é™ç•Œè€åŠ›è¨ˆç®—.pdf';
        pdf.save(filename);
        
        updateProgress(100, 'å®Œäº†ã—ã¾ã—ãŸï¼');
        await new Promise(r => setTimeout(r, 500));
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        modal.style.display = 'none';
        
        alert('PDFãŒæ­£å¸¸ã«ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚');
        
    } catch (error) {
        console.error('PDFç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('progressModal').style.display = 'none';
        
        // ãƒ¬ãƒãƒ¼ãƒˆãƒ“ãƒ¥ãƒ¼ã‚’éè¡¨ç¤ºã«æˆ»ã™
        reportView.style.position = '';
        reportView.style.left = '';
        reportView.style.display = 'none';
        
        alert('PDFç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
    }
}

// ç›®æ¬¡ç”Ÿæˆé–¢æ•°
function generateTableOfContents(showOverview, showForce, showResult, showLogic, showLog, showDetail, showShear, skipY) {
    const tocContent = document.getElementById('toc-content');
    let html = '<div style="line-height:2.2;">';
    let pageNum = 1; // è¡¨ç´™ã¨ç›®æ¬¡è‡ªä½“ã‚’é™¤ã
    
    if (showOverview) {
        html += `<div style="display:flex; justify-content:space-between; padding:5px 10px; border-bottom:1px dotted #ccc;"><span>ç¬¬1ç« ã€€å»ºç‰©æ¦‚è¦ãƒ»è«¸å…ƒ</span><span>${pageNum}-${pageNum+1}</span></div>`;
        pageNum += 2;
    }
    
    if (showForce) {
        html += `<div style="display:flex; justify-content:space-between; padding:5px 10px; border-bottom:1px dotted #ccc;"><span>ç¬¬2ç« ã€€å¾©å…ƒåŠ›ç‰¹æ€§</span></div>`;
        html += `<div style="display:flex; justify-content:space-between; padding:5px 10px 5px 30px; border-bottom:1px dotted #ccc;"><span>2.1ã€€Xæ–¹å‘ã®å¾©å…ƒåŠ›ç‰¹æ€§</span><span>${pageNum}</span></div>`;
        pageNum++;
        if (!skipY) {
            html += `<div style="display:flex; justify-content:space-between; padding:5px 10px 5px 30px; border-bottom:1px dotted #ccc;"><span>2.2ã€€Yæ–¹å‘ã®å¾©å…ƒåŠ›ç‰¹æ€§</span><span>${pageNum}</span></div>`;
            pageNum++;
        }
    }
    
    if (showResult) {
        html += `<div style="display:flex; justify-content:space-between; padding:5px 10px; border-bottom:1px dotted #ccc;"><span>ç¬¬3ç« ã€€åˆ¤å®šçµæœã‚µãƒãƒªãƒ¼</span></div>`;
        html += `<div style="display:flex; justify-content:space-between; padding:5px 10px 5px 30px; border-bottom:1px dotted #ccc;"><span>3.1ã€€Xæ–¹å‘ã®åˆ¤å®šçµæœ</span><span>${pageNum}</span></div>`;
        pageNum++;
        if (!skipY) {
            html += `<div style="display:flex; justify-content:space-between; padding:5px 10px 5px 30px; border-bottom:1px dotted #ccc;"><span>3.2ã€€Yæ–¹å‘ã®åˆ¤å®šçµæœ</span><span>${pageNum}</span></div>`;
            pageNum++;
        }
    }
    
    if (showLogic) {
        html += `<div style="display:flex; justify-content:space-between; padding:5px 10px; border-bottom:1px dotted #ccc;"><span>ç¬¬4ç« ã€€è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ãƒ»è©³ç´°é …ç›®ã®è§£èª¬</span><span>${pageNum}-${pageNum+1}</span></div>`;
        pageNum += 2;
    }
    
    if (showLog) {
        html += `<div style="display:flex; justify-content:space-between; padding:5px 10px; border-bottom:1px dotted #ccc;"><span>ç¬¬5ç« ã€€è©³ç´°è¨ˆç®—ãƒ­ã‚°</span></div>`;
        html += `<div style="display:flex; justify-content:space-between; padding:5px 10px 5px 30px; border-bottom:1px dotted #ccc;"><span>5.1ã€€Xæ–¹å‘ã®è©³ç´°è¨ˆç®—ãƒ­ã‚°</span><span>${pageNum}-${pageNum+2}</span></div>`;
        pageNum += 3;
        if (!skipY) {
            html += `<div style="display:flex; justify-content:space-between; padding:5px 10px 5px 30px; border-bottom:1px dotted #ccc;"><span>5.2ã€€Yæ–¹å‘ã®è©³ç´°è¨ˆç®—ãƒ­ã‚°</span><span>${pageNum}-${pageNum+2}</span></div>`;
            pageNum += 3;
        }
    }
    
    if (showDetail) {
        html += `<div style="display:flex; justify-content:space-between; padding:5px 10px; border-bottom:1px dotted #ccc;"><span>ç¬¬6ç« ã€€äº¤ç‚¹è©³ç´°è¨ˆç®—</span></div>`;
        html += `<div style="display:flex; justify-content:space-between; padding:5px 10px 5px 30px; border-bottom:1px dotted #ccc;"><span>6.1ã€€Xæ–¹å‘ã®äº¤ç‚¹è©³ç´°è¨ˆç®—</span><span>${pageNum}-${pageNum+3}</span></div>`;
        pageNum += 4;
        if (!skipY) {
            html += `<div style="display:flex; justify-content:space-between; padding:5px 10px 5px 30px; border-bottom:1px dotted #ccc;"><span>6.2ã€€Yæ–¹å‘ã®äº¤ç‚¹è©³ç´°è¨ˆç®—</span><span>${pageNum}-${pageNum+3}</span></div>`;
            pageNum += 4;
        }
    }
    
    if (showShear && document.getElementById('chk_calc_shear_force').checked) {
        html += `<div style="display:flex; justify-content:space-between; padding:5px 10px; border-bottom:1px dotted #ccc;"><span>ç¬¬7ç« ã€€å±¤ã›ã‚“æ–­åŠ›ã®æ¯”è¼ƒãƒ»æ¤œè¨¼</span><span>${pageNum}-${pageNum+1}</span></div>`;
    }
    
    html += '</div>';
    tocContent.innerHTML = html;
}

// Gsã‚¹ãƒšã‚¯ãƒˆãƒ«æƒ…å ±ã‚’è¨ˆç®—æ›¸ã«å‡ºåŠ›
function renderGsSpectrumReport() {
    const tcMode = document.getElementById('inp_Tc_mode').value;
    const typeNames = { '1': 'ç¬¬1ç¨® (å²©ç›¤ãƒ»ç¡¬è³ªç ‚ç¤«ç­‰)', '2': 'ç¬¬2ç¨® (é€šå¸¸ã®åœ°ç›¤)', '3': 'ç¬¬3ç¨® (è»Ÿå¼±åœ°ç›¤)', 'custom': 'è‡ªç”±å…¥åŠ›' };
    const tcDesc = { 
        '1': 'Tc=0.4s, å²©ç›¤ãƒ»ç¡¬è³ªç ‚ç¤«å±¤ãã®ä»–ã“ã‚Œã«é¡ã™ã‚‹åœ°ç›¤',
        '2': 'Tc=0.6s, ç¬¬1ç¨®ãƒ»ç¬¬3ç¨®ä»¥å¤–ã®åœ°ç›¤',
        '3': 'Tc=0.8s, è…æ¤åœŸãƒ»æ³¥åœŸãã®ä»–ã“ã‚Œã«é¡ã™ã‚‹è»Ÿå¼±åœ°ç›¤',
        'custom': 'Gsã‚¹ãƒšã‚¯ãƒˆãƒ«ã‚’ç›´æ¥æŒ‡å®š'
    };
    
    document.getElementById('rep-Tc-detail').innerText = typeNames[tcMode] || 'ç¬¬2ç¨®';
    document.getElementById('rep-Tc-mode').innerText = tcDesc[tcMode] || '-';
    
    // è‡ªç”±å…¥åŠ›ã®å ´åˆã¯ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¡¨ç¤º
    const gsTableContainer = document.getElementById('rep-gs-data-table');
    if(tcMode === 'custom' && gsData.length > 0) {
        let html = '<table class="report-table" style="font-size:7pt;"><thead><tr><th>T (s)</th><th>Gs</th></tr></thead><tbody>';
        gsData.forEach(d => {
            html += `<tr><td>${d.t.toFixed(3)}</td><td>${d.g.toFixed(3)}</td></tr>`;
        });
        html += '</tbody></table>';
        gsTableContainer.innerHTML = html;
    } else {
        // æ¨™æº–ã‚¹ãƒšã‚¯ãƒˆãƒ«ã®å ´åˆã¯ä»£è¡¨çš„ãªå€¤ã‚’è¡¨ç¤º
        let html = '<div style="font-size:7pt; margin-top:3px;">æ¨™æº–Gsã‚¹ãƒšã‚¯ãƒˆãƒ«ï¼ˆå‘Šç¤ºå€¤ï¼‰</div>';
        html += '<table class="report-table" style="font-size:7pt;"><thead><tr><th>T (s)</th><th>Gs</th></tr></thead><tbody>';
        const sampleT = [0, 0.3, 0.576, 0.64, 0.864, 1.0, 1.5, 2.0];
        sampleT.forEach(t => {
            const gs = getGsForChart(tcMode, t);
            html += `<tr><td>${t.toFixed(2)}</td><td>${gs.toFixed(3)}</td></tr>`;
        });
        html += '</tbody></table>';
        gsTableContainer.innerHTML = html;
    }
    
    // Gsã‚¹ãƒšã‚¯ãƒˆãƒ«ã‚°ãƒ©ãƒ•ã‚’æç”»
    const canvas = document.getElementById('rep-chart-gs');
    if(!canvas) return;
    
    // â–¼â–¼â–¼ ä¿®æ­£: æ—¢å­˜ãƒãƒ£ãƒ¼ãƒˆã®ç ´æ£„å‡¦ç†ã‚’è¿½åŠ  â–¼â–¼â–¼
    if(repChartGs) {
        repChartGs.destroy();
        repChartGs = null;
    }
    // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²
    
    let data = [];
    let label = 'Gs';
    
    if(tcMode === 'custom' && gsData.length > 0) {
        data = gsData.map(d => ({ x: d.t, y: d.g }));
        label = 'Gs (è‡ªç”±å…¥åŠ›)';
    } else {
        label = 'Gs (' + typeNames[tcMode] + ')';
        const tValues = [0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.576, 0.6, 0.64, 0.7, 0.8, 0.864, 0.9, 1.0, 1.152, 1.2, 1.5, 2.0, 2.5, 3.0];
        tValues.forEach(t => {
            const gs = getGsForChart(tcMode, t);
            data.push({ x: t, y: gs });
        });
        data.sort((a, b) => a.x - b.x);
    }
    
    // â–¼â–¼â–¼ ä¿®æ­£: å¤‰æ•°åã‚’ repChartGs ã«å¤‰æ›´ â–¼â–¼â–¼
    repChartGs = new Chart(canvas.getContext('2d'), {
        type: 'scatter',
        data: {
            datasets: [{
                label: label,
                data: data,
                borderColor: '#005a9c',
                backgroundColor: '#005a9c',
                borderWidth: 1.5,
                showLine: true,
                pointRadius: 1,
                fill: false
            }]
        },
        options: {
            animation: false,
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { type: 'linear', position: 'bottom', title: { display: true, text: 'T (s)', font: { size: 8 } }, min: 0, max: 3 },
                y: { title: { display: true, text: 'Gs', font: { size: 8 } }, min: 0, max: 3 }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });
}

// å¿œç­”ã‚¹ãƒšã‚¯ãƒˆãƒ«Sa0æƒ…å ±ã‚’è¨ˆç®—æ›¸ã«å‡ºåŠ›
function renderSa0Report() {
    const saMode = document.getElementById('inp_Sa_mode')?.value || 'standard';
    const tbody = document.getElementById('rep-sa0-tbody');
    const canvas = document.getElementById('rep-chart-sa0');
    const modeEl = document.getElementById('rep-sa-mode');
    const descEl = document.getElementById('rep-sa-desc');
    
    const hasCustomD = saDataD.length > 0;
    const hasCustomS = saDataS.length > 0;
    
    if(saMode === 'custom' && (hasCustomD || hasCustomS)) {
        // è‡ªç”±å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰
        let modeDesc = 'è‡ªç”±å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰';
        if(hasCustomD && hasCustomS) {
            modeDesc += 'ï¼ˆæå‚·é™ç•Œãƒ»å®‰å…¨é™ç•Œ ä¸¡æ–¹ï¼‰';
        } else if(hasCustomD) {
            modeDesc += 'ï¼ˆæå‚·é™ç•Œã®ã¿ã€å®‰å…¨é™ç•Œã¯å‘Šç¤ºå€¤ï¼‰';
        } else {
            modeDesc += 'ï¼ˆå®‰å…¨é™ç•Œã®ã¿ã€æå‚·é™ç•Œã¯å‘Šç¤ºå€¤ï¼‰';
        }
        if(modeEl) modeEl.innerText = modeDesc;
        
        // èª¬æ˜æ–‡ã‚’è‡ªç”±å…¥åŠ›ç”¨ã«æ›´æ–°
        if(descEl) {
            descEl.innerHTML = `
                <p><strong>åŠ é€Ÿåº¦å¿œç­”ã‚¹ãƒšã‚¯ãƒˆãƒ« Sa(T)</strong></p>
                <p>æå‚·é™ç•Œç”¨ãƒ»å®‰å…¨é™ç•Œç”¨ã‚’å€‹åˆ¥ã«å…¥åŠ›å¯èƒ½ã€‚</p>
                <p>æœªå…¥åŠ›å´ã¯å‘Šç¤ºå€¤ã‚’ä½¿ç”¨ã€‚</p>
                <p><strong>ã€æ¸›è¡°ä½æ¸›ä¿‚æ•°Fhã€‘</strong></p>
                <p style="margin-left:10px;">Î”W/(4Ï€WA) &lt; 0.05 â†’ h = 0.05</p>
                <p style="margin-left:10px;">Î”W/(4Ï€WA) â‰§ 0.05 â†’ h = Î”W/(4Ï€WA)</p>
                <p style="margin-left:10px;">Fh = 1.5 / (1 + 10h)</p>
            `;
        }
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«å‡ºåŠ›ï¼ˆæå‚·é™ç•Œã¨å®‰å…¨é™ç•Œã‚’ä¸¡æ–¹è¡¨ç¤ºï¼‰
        const sampleT = [0, 0.1, 0.16, 0.3, 0.5, 0.64, 0.8, 1.0, 1.5, 2.0, 2.5, 3.0];
        let html = '';
        sampleT.forEach(T => {
            const saD = hasCustomD ? (getSaCustom(saDataD, T) || getSao(T, 'd')) : getSao(T, 'd');
            const saS = hasCustomS ? (getSaCustom(saDataS, T) || getSao(T, 's')) : getSao(T, 's');
            const markD = hasCustomD ? '' : '*';
            const markS = hasCustomS ? '' : '*';
            html += `<tr><td>${T.toFixed(2)}</td><td>${saD.toFixed(3)}${markD}</td><td>${saS.toFixed(3)}${markS}</td></tr>`;
        });
        tbody.innerHTML = html;
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å¤‰æ›´
        const thead = tbody.parentElement.querySelector('thead');
        if(thead) {
            thead.innerHTML = '<tr><th>T(s)</th><th>Sa(æå‚·)</th><th>Sa(å®‰å…¨)</th></tr>';
        }
        
        if(canvas) {
            // â–¼â–¼â–¼ ä¿®æ­£: æ—¢å­˜ãƒãƒ£ãƒ¼ãƒˆã®ç ´æ£„å‡¦ç†ã‚’è¿½åŠ  â–¼â–¼â–¼
            if(repChartSa0) {
                repChartSa0.destroy();
                repChartSa0 = null;
            }
            // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

            let datasets = [];
            
            // å®‰å…¨é™ç•Œ
            if(hasCustomS) {
                const dataS = saDataS.map(d => ({ x: d.t, y: d.sa }));
                datasets.push({
                    label: 'Sa (å®‰å…¨ãƒ»è‡ªç”±å…¥åŠ›)',
                    data: dataS,
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220,53,69,0.1)',
                    borderWidth: 1.5,
                    showLine: true,
                    pointRadius: 2,
                    fill: true
                });
            } else {
                let dataSafety = [];
                for(let T = 0; T <= 3.0; T += 0.05) {
                    dataSafety.push({ x: T, y: getSao(T, 's') });
                }
                datasets.push({
                    label: 'Sa0 (å®‰å…¨ãƒ»å‘Šç¤ºå€¤)',
                    data: dataSafety,
                    borderColor: '#dc3545',
                    borderDash: [5, 3],
                    backgroundColor: 'rgba(220,53,69,0.05)',
                    borderWidth: 1.5,
                    showLine: true,
                    pointRadius: 0,
                    fill: true
                });
            }
            
            // æå‚·é™ç•Œ
            if(hasCustomD) {
                const dataD = saDataD.map(d => ({ x: d.t, y: d.sa }));
                datasets.push({
                    label: 'Sa (æå‚·ãƒ»è‡ªç”±å…¥åŠ›)',
                    data: dataD,
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40,167,69,0.1)',
                    borderWidth: 1.5,
                    showLine: true,
                    pointRadius: 2,
                    fill: true
                });
            } else {
                let dataDamage = [];
                for(let T = 0; T <= 3.0; T += 0.05) {
                    dataDamage.push({ x: T, y: getSao(T, 'd') });
                }
                datasets.push({
                    label: 'Sa0 (æå‚·ãƒ»å‘Šç¤ºå€¤)',
                    data: dataDamage,
                    borderColor: '#28a745',
                    borderDash: [5, 3],
                    backgroundColor: 'rgba(40,167,69,0.05)',
                    borderWidth: 1.5,
                    showLine: true,
                    pointRadius: 0,
                    fill: true
                });
            }
            
            // â–¼â–¼â–¼ ä¿®æ­£: å¤‰æ•°åã‚’ repChartSa0 ã«å¤‰æ›´ â–¼â–¼â–¼
            repChartSa0 = new Chart(canvas.getContext('2d'), {
                type: 'scatter',
                data: { datasets: datasets },
                options: {
                    animation: false,
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { type: 'linear', position: 'bottom', title: { display: true, text: 'T (s)', font: { size: 8 } }, min: 0, max: 3 },
                        y: { title: { display: true, text: 'Sa (m/sÂ²)', font: { size: 8 } }, min: 0 }
                    },
                    plugins: {
                        legend: { display: true, position: 'top', labels: { font: { size: 7 } } }
                    }
                }
            });
        }
    } else {
        // æ¨™æº–ãƒ¢ãƒ¼ãƒ‰ï¼ˆå‘Šç¤ºæº–æ‹ ï¼‰
        if(modeEl) modeEl.innerText = 'æ¨™æº–ã‚¹ãƒšã‚¯ãƒˆãƒ«ï¼ˆå‘Šç¤ºæº–æ‹ ï¼‰';
        
        // èª¬æ˜æ–‡ã‚’æ¨™æº–ç”¨ã«è¨­å®š
        if(descEl) {
            descEl.innerHTML = `
                <p><strong>åŠ é€Ÿåº¦å¿œç­”ã‚¹ãƒšã‚¯ãƒˆãƒ« Sa0(T)</strong></p>
                <p>å²©ç›¤ä¸Šã®åŠ é€Ÿåº¦å¿œç­”ã‚¹ãƒšã‚¯ãƒˆãƒ«ã‚’è¡¨ã—ã¾ã™ã€‚</p>
                <p>â— æå‚·é™ç•Œ: ç¨€ã«ç™ºç”Ÿã™ã‚‹åœ°éœ‡å‹• (50å¹´ã«1å›ç¨‹åº¦)</p>
                <p>â— å®‰å…¨é™ç•Œ: æ¥µã‚ã¦ç¨€ã«ç™ºç”Ÿã™ã‚‹åœ°éœ‡å‹• (500å¹´ã«1å›ç¨‹åº¦)</p>
                <p>â€»å®‰å…¨é™ç•Œã¯æå‚·é™ç•Œã®5å€</p>
            `;
        }
        
        const sampleT = [0, 0.1, 0.16, 0.3, 0.5, 0.64, 0.8, 1.0, 1.5, 2.0, 2.5, 3.0];
        let html = '';
        sampleT.forEach(T => {
            const sa0d = getSao(T, 'd');
            const sa0s = getSao(T, 's');
            html += `<tr><td>${T.toFixed(2)}</td><td>${sa0d.toFixed(3)}</td><td>${sa0s.toFixed(3)}</td></tr>`;
        });
        tbody.innerHTML = html;
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ¨™æº–ã«æˆ»ã™
        const thead = tbody.parentElement.querySelector('thead');
        if(thead) {
            thead.innerHTML = '<tr><th>T(s)</th><th>Sa0(æå‚·)</th><th>Sa0(å®‰å…¨)</th></tr>';
        }
        
        if(canvas) {
            // â–¼â–¼â–¼ ä¿®æ­£1: æ—¢å­˜ãƒãƒ£ãƒ¼ãƒˆã®ç ´æ£„å‡¦ç†ã‚’è¿½åŠ  â–¼â–¼â–¼
            if(repChartSa0) {
                repChartSa0.destroy();
                repChartSa0 = null;
            }
            // â–²â–²â–² ä¿®æ­£1 ã“ã“ã¾ã§ â–²â–²â–²

            let dataDamage = [];
            let dataSafety = [];
            
            for(let T = 0; T <= 3.0; T += 0.05) {
                const sa0d = getSao(T, 'd');
                const sa0s = getSao(T, 's');
                dataDamage.push({ x: T, y: sa0d });
                dataSafety.push({ x: T, y: sa0s });
            }
            
            // â–¼â–¼â–¼ ä¿®æ­£2: ä½œæˆã—ãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å¤‰æ•° repChartSa0 ã«ä»£å…¥ã™ã‚‹ã‚ˆã†å¤‰æ›´ â–¼â–¼â–¼
            repChartSa0 = new Chart(canvas.getContext('2d'), {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: 'Sa0 (å®‰å…¨)',
                            data: dataSafety,
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220,53,69,0.1)',
                            borderWidth: 1.5,
                            showLine: true,
                            pointRadius: 0,
                            fill: true
                        },
                        {
                            label: 'Sa0 (æå‚·)',
                            data: dataDamage,
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40,167,69,0.1)',
                            borderWidth: 1.5,
                            showLine: true,
                            pointRadius: 0,
                            fill: true
                        }
                    ]
                },
                options: {
                    animation: false,
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { type: 'linear', position: 'bottom', title: { display: true, text: 'T (s)', font: { size: 8 } }, min: 0, max: 3 },
                        y: { title: { display: true, text: 'Sa0 (m/sÂ²)', font: { size: 8 } }, min: 0 }
                    },
                    plugins: {
                        legend: { display: true, position: 'top', labels: { font: { size: 7 } } }
                    }
                }
            });
            // â–²â–²â–² ä¿®æ­£2 ã“ã“ã¾ã§ â–²â–²â–²
        }
    }
}

// p,qèª¿æ•´ä¿‚æ•°æƒ…å ±ã‚’è¨ˆç®—æ›¸ã«å‡ºåŠ›
function renderPqReport() {
    const pqMode = document.getElementById('inp_pq').value;
    const stories = parseInt(document.getElementById('inp_Stories').value);
    
    document.getElementById('rep-pq-mode').innerText = (pqMode === 'yes') ? 'è€ƒæ…®ã™ã‚‹ï¼ˆå‘Šç¤ºæº–æ‹ ï¼‰' : 'è€ƒæ…®ã—ãªã„ï¼ˆp=1.0, q=1.0ï¼‰';
    
    // p,qä¿‚æ•°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤º
    const pqSection = document.getElementById('rep-pq-section');
    
    if(pqMode !== 'yes') {
        pqSection.style.display = 'none';
        return;
    }
    pqSection.style.display = 'block';
    
    // èª¬æ˜æ–‡ã‚’è¨­å®š
    const descContainer = document.getElementById('rep-pq-desc');
    let html = '<div style="font-size:7pt; line-height:1.4;">';
    html += '<p><strong>pä¿‚æ•°ï¼ˆç­‰ä¾¡å‘¨æœŸã«ã‚ˆã‚‹èª¿æ•´ï¼‰</strong></p>';
    html += '<p>ãƒ»åœ°éœ‡å¿œç­”ã®ä½ç›¸å·®ã‚’è€ƒæ…®ã—ãŸèª¿æ•´ä¿‚æ•°</p>';
    if(stories === 2) {
        html += '<p>ãƒ»2éšå»ºã¦: Teâ‰¤0.16s â†’ p=1.0-(0.15/0.16)Te, Te>0.16s â†’ p=0.85 (ä¸‹é™0.7)</p>';
    } else {
        html += '<p>ãƒ»å¹³å±‹: Teâ‰¤0.16s â†’ p=1.0-(0.20/0.16)Te, Te>0.16s â†’ p=0.80 (ä¸‹é™0.7)</p>';
    }
    html += '<p style="margin-top:5px;"><strong>qä¿‚æ•°ï¼ˆç­‰ä¾¡è³ªé‡æ¯”ã«ã‚ˆã‚‹èª¿æ•´ï¼‰</strong></p>';
    html += '<p>ãƒ»é«˜æ¬¡ãƒ¢ãƒ¼ãƒ‰å½±éŸ¿ã‚’è€ƒæ…®ã—ãŸèª¿æ•´ä¿‚æ•°</p>';
    html += '<p>ãƒ»Me/(m1+m2)<0.75 â†’ q=0.75/(Me/(m1+m2)), ãã‚Œä»¥å¤– â†’ q=1.0</p>';
    html += '</div>';
    
    // pä¿‚æ•°ã®ä»£è¡¨å€¤ãƒ†ãƒ¼ãƒ–ãƒ«
    html += '<table class="report-table" style="font-size:7pt; margin-top:5px;"><thead><tr><th>Te(s)</th><th>p</th></tr></thead><tbody>';
    const sampleTe = [0, 0.05, 0.10, 0.16, 0.20, 0.30, 0.40];
    sampleTe.forEach(Te => {
        let p;
        if(stories === 2) {
            if(Te <= 0.16) p = 1.0 - (0.15/0.16) * Te;
            else p = 0.85;
        } else {
            if(Te <= 0.16) p = 1.0 - (0.20/0.16) * Te;
            else p = 0.80;
        }
        if(p < 0.7) p = 0.7;
        html += `<tr><td>${Te.toFixed(2)}</td><td>${p.toFixed(3)}</td></tr>`;
    });
    html += '</tbody></table>';
    descContainer.innerHTML = html;
    
    // pä¿‚æ•°ã‚°ãƒ©ãƒ•ã‚’æç”»
    const canvas = document.getElementById('rep-chart-p');
    if(!canvas) return;
    
    // â–¼â–¼â–¼ ä¿®æ­£: æ—¢å­˜ãƒãƒ£ãƒ¼ãƒˆã®ç ´æ£„å‡¦ç†ã‚’è¿½åŠ  â–¼â–¼â–¼
    if(repChartP) {
        repChartP.destroy();
        repChartP = null;
    }
    // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²
    
    // pä¿‚æ•°ã®ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
    let data = [];
    for(let Te = 0; Te <= 0.5; Te += 0.01) {
        let p;
        if(stories === 2) {
            if(Te <= 0.16) p = 1.0 - (0.15/0.16) * Te;
            else p = 0.85;
        } else {
            if(Te <= 0.16) p = 1.0 - (0.20/0.16) * Te;
            else p = 0.80;
        }
        if(p < 0.7) p = 0.7;
        data.push({ x: Te, y: p });
    }
    
    // â–¼â–¼â–¼ ä¿®æ­£: å¤‰æ•°åã‚’ repChartP ã«å¤‰æ›´ â–¼â–¼â–¼
    repChartP = new Chart(canvas.getContext('2d'), {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'p (' + (stories === 2 ? '2éšå»ºã¦' : 'å¹³å±‹') + ')',
                data: data,
                borderColor: '#005a9c',
                backgroundColor: '#005a9c',
                borderWidth: 1.5,
                showLine: true,
                pointRadius: 0,
                fill: false
            }]
        },
        options: {
            animation: false,
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { type: 'linear', position: 'bottom', title: { display: true, text: 'Te (s)', font: { size: 8 } }, min: 0, max: 0.5 },
                y: { title: { display: true, text: 'p', font: { size: 8 } }, min: 0.6, max: 1.05 }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });
}

// å¾©å…ƒåŠ›ç‰¹æ€§ã®è©³ç´°ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«åŒ–ï¼ˆå„å¤‰å½¢è§’ã§ã®Q, heqä»˜ãï¼‰
function renderForceDetails() {
    const skipY = calcRes.skipY || false;
    const dirs = skipY ? ['x'] : ['x', 'y'];
    dirs.forEach(dir => {
        const id1 = `${dir}1`;
        const id2 = `${dir}2`;
        const is1F = (calcRes.b.stories === 1);
        
        // è¦ç´ ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ«
        let html = `<h4 style="margin:5px 0; background:#f0f0f0; padding:3px;">è€åŠ›è¦ç´ ä¸€è¦§</h4>`;
        html += `<table class="report-table" style="font-size:7pt;"><thead><tr><th>éš</th><th>è¦ç´ å</th><th>æ•°é‡</th><th>K0(kN/m)</th><th>æœ€å¤§Q(kN)</th><th>heqå…¥åŠ›</th></tr></thead><tbody>`;
        
        // 1éšã®å£è¦ç´ 
        addedWalls[id1].forEach(w => {
            let data = WALL_DATA[w.name];
            if(data) {
                let K0 = WALL_K0[w.name] || 0;
                let maxQ = Math.max(...data.map(d => d.q)) * w.qty;
                html += `<tr><td>1F</td><td>${w.name}</td><td>${w.qty.toFixed(2)}</td><td>${K0.toFixed(0)}</td><td>${maxQ.toFixed(1)}</td><td>è‡ªå‹•</td></tr>`;
            }
        });
        
        // 1éšã®è‡ªç”±å…¥åŠ›
        freeInputData[id1].forEach(item => {
            if(item.data.length > 0) {
                let K0 = (item.data[0].r > 0) ? item.data[0].q / item.data[0].r : 0;
                let maxQ = Math.max(...item.data.map(d => d.q)) * (item.qty || 1);
                let hasInputHeq = item.data.some(p => p.heq !== undefined && p.heq !== null);
                html += `<tr><td>1F</td><td>${item.name}</td><td>${(item.qty||1).toFixed(2)}</td><td>${K0.toFixed(0)}</td><td>${maxQ.toFixed(1)}</td><td>${hasInputHeq ? 'ç›´æ¥' : 'è‡ªå‹•'}</td></tr>`;
            }
        });
        
        if(!is1F) {
            addedWalls[id2].forEach(w => {
                let data = WALL_DATA[w.name];
                if(data) {
                    let K0 = WALL_K0[w.name] || 0;
                    let maxQ = Math.max(...data.map(d => d.q)) * w.qty;
                    html += `<tr><td>2F</td><td>${w.name}</td><td>${w.qty.toFixed(2)}</td><td>${K0.toFixed(0)}</td><td>${maxQ.toFixed(1)}</td><td>è‡ªå‹•</td></tr>`;
                }
            });
            freeInputData[id2].forEach(item => {
                if(item.data.length > 0) {
                    let K0 = (item.data[0].r > 0) ? item.data[0].q / item.data[0].r : 0;
                    let maxQ = Math.max(...item.data.map(d => d.q)) * (item.qty || 1);
                    let hasInputHeq = item.data.some(p => p.heq !== undefined && p.heq !== null);
                    html += `<tr><td>2F</td><td>${item.name}</td><td>${(item.qty||1).toFixed(2)}</td><td>${K0.toFixed(0)}</td><td>${maxQ.toFixed(1)}</td><td>${hasInputHeq ? 'ç›´æ¥' : 'è‡ªå‹•'}</td></tr>`;
                }
            });
        }
        html += `</tbody></table>`;
        
        // å„å¤‰å½¢è§’ã§ã®è€åŠ›ãƒ»heqè©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ«
        html += `<h4 style="margin:10px 0 5px; background:#f0f0f0; padding:3px;">å„å¤‰å½¢è§’ã§ã®è€åŠ›ãƒ»heq</h4>`;
        let composite1 = getCompositeForce(id1);
        let composite2 = is1F ? [] : getCompositeForce(id2);
        
        // ä¸»è¦å¤‰å½¢è§’ã®ã¿æŠ½å‡º
        let keyRads = [1/480, 1/240, 1/120, 1/60, 1/45, 1/30, 1/20, 1/15];
        
        html += `<table class="report-table" style="font-size:7pt;"><thead><tr><th>å¤‰å½¢è§’</th>`;
        if(!is1F) html += `<th>2F Q(kN)</th><th>2F heq</th>`;
        html += `<th>1F Q(kN)</th><th>1F heq</th></tr></thead><tbody>`;
        
        keyRads.forEach(r => {
            let c1 = composite1.find(c => Math.abs(c.r - r) < 0.0001) || interpComposite(composite1, r);
            let c2 = is1F ? null : (composite2.find(c => Math.abs(c.r - r) < 0.0001) || interpComposite(composite2, r));
            let radStr = `1/${Math.round(1/r)}`;
            html += `<tr><td>${radStr}</td>`;
            if(!is1F) html += `<td>${c2 ? c2.q.toFixed(1) : '-'}</td><td>${c2 ? c2.heq.toFixed(4) : '-'}</td>`;
            html += `<td>${c1.q.toFixed(1)}</td><td>${c1.heq.toFixed(4)}</td></tr>`;
        });
        html += `</tbody></table>`;
        
        document.getElementById(`rep-force-${dir}-detail`).innerHTML = html;
    });
}

// compositeé…åˆ—ã‹ã‚‰æŒ‡å®šå¤‰å½¢è§’ã®ãƒ‡ãƒ¼ã‚¿ã‚’è£œé–“
function interpComposite(composite, r) {
    if(composite.length === 0) return { r: r, q: 0, heq: 0 };
    if(r <= composite[0].r) return composite[0];
    if(r >= composite[composite.length-1].r) return composite[composite.length-1];
    for(let i = 0; i < composite.length - 1; i++) {
        if(r >= composite[i].r && r <= composite[i+1].r) {
            let ratio = (r - composite[i].r) / (composite[i+1].r - composite[i].r);
            return {
                r: r,
                q: composite[i].q + ratio * (composite[i+1].q - composite[i].q),
                heq: composite[i].heq + ratio * (composite[i+1].heq - composite[i].heq)
            };
        }
    }
    return { r: r, q: 0, heq: 0 };
}

// å¾©å…ƒåŠ›ç‰¹æ€§ã‚°ãƒ©ãƒ•ã‚’è¨ˆç®—æ›¸ç”¨ã«æç”»
let repForceCharts = {};
function drawForceChart(canvasId, dir) {
    const canvas = document.getElementById(canvasId);
    if(!canvas) return;
    
    // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
    if(repForceCharts[canvasId]) {
        repForceCharts[canvasId].destroy();
    }
    
    const is1F = (calcRes.b.stories === 1);
    let composite1 = getCompositeForce(`${dir}1`);
    let composite2 = is1F ? [] : getCompositeForce(`${dir}2`);
    
    let datasets = [{
        label: '1éš å¾©å…ƒåŠ›',
        data: composite1.map(c => ({ x: c.r, y: c.q })),
        borderColor: '#005a9c',
        borderWidth: 2,
        showLine: true,
        pointRadius: 1,
        fill: false
    }];
    
    if(!is1F) {
        datasets.push({
            label: '2éš å¾©å…ƒåŠ›',
            data: composite2.map(c => ({ x: c.r, y: c.q })),
            borderColor: '#28a745',
            borderWidth: 2,
            showLine: true,
            pointRadius: 1,
            fill: false
        });
    }
    
    let maxX = Math.max(...composite1.map(c => c.r), ...(is1F ? [0] : composite2.map(c => c.r))) * 1.1;
    let maxY = Math.max(...composite1.map(c => c.q), ...(is1F ? [0] : composite2.map(c => c.q))) * 1.1;
    
    repForceCharts[canvasId] = new Chart(canvas.getContext('2d'), {
        type: 'scatter',
        data: { datasets: datasets },
        options: {
            animation: false,
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { type: 'linear', position: 'bottom', title: { display: true, text: 'å¤‰å½¢è§’ R (rad)' }, max: maxX },
                y: { title: { display: true, text: 'ã›ã‚“æ–­åŠ› Q (kN)' }, max: maxY, beginAtZero: true }
            },
            plugins: {
                legend: { display: !is1F, position: 'top' }
            }
        }
    });
}

// è©³ç´°è¨ˆç®—ãƒ­ã‚°ã‚’3åˆ†å‰²å‡ºåŠ›ï¼ˆè¡Œæ•°ã‚’å¤§å¹…å‰Šæ¸›ï¼‰
function renderLogSplit(dir, steps) {
    const fmtR = (v) => { if(v<=0) return '-'; return `1/${Math.round(1/v)}`; };
    const is1F = (calcRes.b.stories === 1);
    
    // ã‚¹ãƒ†ãƒƒãƒ—ã‚’å¤§å¹…ã«é–“å¼•ã„ã¦è¡¨ç¤ºï¼ˆ20è¡ŒãŠãã«è¡¨ç¤º + æœ€çµ‚è¡Œï¼‰
    const filteredSteps = steps.filter((s, idx) => idx % 20 === 0 || idx === steps.length - 1);
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«1: å¤‰ä½ãƒ»å‰›æ€§ï¼ˆåŸºæœ¬æƒ…å ±ï¼‰
    let h1 = `<table class="log-table"><thead><tr class="log-header-group">`;
    h1 += `<th rowspan="2">å±¤é–“<br>å¤‰å½¢è§’R</th>`;
    h1 += is1F ? `<th colspan="2">å±¤ã›ã‚“æ–­åŠ›ãƒ»å‰›æ€§</th>` : `<th colspan="4">å±¤ã›ã‚“æ–­åŠ›ãƒ»å‰›æ€§</th>`;
    h1 += `<th colspan="4">ç­‰ä¾¡1è‡ªç”±åº¦ç³»</th></tr><tr>`;
    if(!is1F) h1 += `<th>Q2</th><th>K2</th>`;
    h1 += `<th>Q1</th><th>K1</th>`;
    h1 += `<th>Me</th><th>Î”</th><th>Qa</th><th>Ke</th>`;
    h1 += `</tr></thead><tbody>`;

    filteredSteps.forEach(s => {
        h1 += `<tr><td style="background:#eef;">${fmtR(s.R)}</td>`;
        if(!is1F) h1 += `<td>${s.Q2.toFixed(1)}</td><td>${s.K2.toFixed(0)}</td>`;
        h1 += `<td>${s.Q1.toFixed(1)}</td><td>${s.K1.toFixed(0)}</td>`;
        h1 += `<td>${s.MU.toFixed(2)}</td><td>${s.D.toFixed(4)}</td><td style="background:#eef;">${s.QA.toFixed(1)}</td>`;
        h1 += `<td>${s.Ke.toFixed(0)}</td></tr>`;
    });
    h1 += '</tbody></table>';
    document.getElementById(`report-log-${dir}1`).innerHTML = h1;

    // ãƒ†ãƒ¼ãƒ–ãƒ«2: å‘¨æœŸãƒ»æ¸›è¡°
    let h2 = `<table class="log-table"><thead><tr class="log-header-group">`;
    h2 += `<th rowspan="2">å±¤é–“<br>å¤‰å½¢è§’R</th>`;
    h2 += `<th colspan="2">ç­‰ä¾¡ç³»</th>`;
    h2 += `<th colspan="6">æ¸›è¡°</th></tr><tr>`;
    h2 += `<th>Te</th><th>He</th>`;
    h2 += `<th>heq1</th><th>heq2</th><th>Î”W</th><th>Wa</th><th>h</th><th>Fh</th>`;
    h2 += `</tr></thead><tbody>`;

    filteredSteps.forEach(s => {
        h2 += `<tr><td style="background:#eef;">${fmtR(s.R)}</td>`;
        h2 += `<td>${s.Te.toFixed(3)}</td><td>${s.H.toFixed(2)}</td>`;
        h2 += `<td>${s.heq1.toFixed(4)}</td><td>${s.heq2.toFixed(4)}</td><td>${s.dW.toFixed(1)}</td>`;
        h2 += `<td>${s.WA.toFixed(1)}</td><td>${s.h.toFixed(3)}</td><td>${s.Fh.toFixed(2)}</td></tr>`;
    });
    h2 += '</tbody></table>';
    document.getElementById(`report-log-${dir}2`).innerHTML = h2;
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«3: æå‚·é™ç•Œãƒ»å®‰å…¨é™ç•Œ
    let h3 = `<table class="log-table"><thead><tr class="log-header-group">`;
    h3 += `<th rowspan="2">å±¤é–“<br>å¤‰å½¢è§’R</th>`;
    h3 += `<th colspan="2">èª¿æ•´ä¿‚æ•°</th>`;
    h3 += `<th colspan="6">æå‚·é™ç•Œ</th>`;
    h3 += `<th colspan="6">å®‰å…¨é™ç•Œ</th></tr><tr>`;
    h3 += `<th>p</th><th>q</th>`;
    h3 += `<th>S0d</th><th>Gs</th><th>SAd</th><th>SDd</th><th>Qnd</th><th>reqR</th>`;
    h3 += `<th>S0s</th><th>Gs</th><th>SAs</th><th>SDs</th><th>Qns</th><th>reqR</th>`;
    h3 += `</tr></thead><tbody>`;

    filteredSteps.forEach(s => {
        h3 += `<tr><td style="background:#eef;">${fmtR(s.R)}</td>`;
        h3 += `<td>${s.p.toFixed(2)}</td><td>${s.q.toFixed(2)}</td>`;
        h3 += `<td>${s.S0d.toFixed(2)}</td><td>${s.Gs.toFixed(2)}</td><td>${s.SAd.toFixed(2)}</td><td>${s.SDd.toFixed(4)}</td>`;
        h3 += `<td style="font-weight:bold; color:${s.QA>=s.Qnd?'blue':'red'}">${s.Qnd.toFixed(1)}</td><td>${fmtR(s.reqRd)}</td>`;
        h3 += `<td>${s.S0s.toFixed(2)}</td><td>${s.Gs.toFixed(2)}</td><td>${s.SAs.toFixed(2)}</td><td>${s.SDs.toFixed(4)}</td>`;
        h3 += `<td style="font-weight:bold; color:${s.QA>=s.Qns?'blue':'red'}">${s.Qns.toFixed(1)}</td><td>${fmtR(s.reqRs)}</td></tr>`;
    });
    h3 += '</tbody></table>';
    document.getElementById(`report-log-${dir}3`).innerHTML = h3;
}

// è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã®è§£èª¬ã‚’å‡ºåŠ›ï¼ˆ1ãƒšãƒ¼ã‚¸ã«ã¾ã¨ã‚ã¦è¡¨ç¤ºï¼‰
// è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã®è§£èª¬ã‚’å‡ºåŠ›ï¼ˆçœç•¥ãªãå…¨ã¦è¨˜è¼‰ï¼‰
function renderLogicSection() {
    // ç¬¬1ãƒšãƒ¼ã‚¸ç›®ã®å†…å®¹ï¼ˆé …ç›®1-6ï¼‰
    const logicHtml1 = `
    <div style="font-size:7pt; line-height:1.4;">
        <!-- 1. æŒ¯å‹•ãƒ¢ãƒ‡ãƒ«ãƒ»è³ªé‡ -->
        <div style="border:1px solid #ddd; padding:6px; background:#fafafa; margin-bottom:6px;">
            <strong style="color:#005a9c;">1. æŒ¯å‹•ãƒ¢ãƒ‡ãƒ«ãƒ»è³ªé‡</strong><br>
            \\( m_i = W_i / g \\)ã€€ï¼ˆå„éšã®è³ªé‡ï¼šé‡é‡ã‚’é‡åŠ›åŠ é€Ÿåº¦ã§é™¤ã™ï¼‰<br>
            \\( g = 9.80665 \\, \\mathrm{m/s^2} \\)ã€€ï¼ˆé‡åŠ›åŠ é€Ÿåº¦ï¼‰<br>
            ç´¯ç©é‡é‡ï¼šä¸‹éšã»ã©ä¸Šéšã®é‡é‡ã‚’åŠ ç®—ã—ãŸå€¤ã‚’ä½¿ç”¨
        </div>
        
        <!-- 2. å›ºæœ‰å€¤è§£æ -->
        <div style="border:1px solid #ddd; padding:6px; background:#fafafa; margin-bottom:6px;">
            <strong style="color:#005a9c;">2. å›ºæœ‰å€¤è§£æãƒ»å›ºæœ‰å‘¨æœŸ</strong><br>
            å‰›æ€§è¡Œåˆ— \\( [K] \\) ã¨è³ªé‡è¡Œåˆ— \\( [M] \\) ã‹ã‚‰å›ºæœ‰å€¤æ–¹ç¨‹å¼ã‚’è§£ãï¼š<br>
            \\( ([K] - \\omega^2 [M]) \\{u\\} = 0 \\)<br>
            å›ºæœ‰å††æŒ¯å‹•æ•°ï¼š\\( \\omega = \\sqrt{\\lambda} \\)ã€å›ºæœ‰å‘¨æœŸï¼š\\( T_0 = 2\\pi / \\omega \\)<br>
            1æ¬¡ãƒ¢ãƒ¼ãƒ‰å½¢çŠ¶ \\( \\{u\\} \\) ã‚’æ­£è¦åŒ–ã—ã¦ä½¿ç”¨
        </div>
        
        <!-- 3. ç­‰ä¾¡1è‡ªç”±åº¦ç³»ã¸ã®ç¸®ç´„ -->
        <div style="border:1px solid #ddd; padding:6px; background:#fafafa; margin-bottom:6px;">
            <strong style="color:#005a9c;">3. ç­‰ä¾¡1è‡ªç”±åº¦ç³»ã¸ã®ç¸®ç´„</strong><br>
            ç­‰ä¾¡è³ªé‡ï¼š\\( M_e = \\frac{(\\sum m_i u_i)^2}{\\sum m_i u_i^2} \\)<br>
            ç­‰ä¾¡é«˜ã•ï¼š\\( H_e = \\frac{\\sum m_i u_i h_i}{\\sum m_i u_i} \\)<br>
            ä»£è¡¨å¤‰ä½ï¼š\\( \\Delta = R \\times H_e \\)ã€€ï¼ˆå±¤é–“å¤‰å½¢è§’ Ã— ç­‰ä¾¡é«˜ã•ï¼‰<br>
            ç­‰ä¾¡ã›ã‚“æ–­åŠ›ï¼š\\( Q_A = M_e \\times \\ddot{u}_e \\)ã€€ï¼ˆè³ªç‚¹ç³»ã‹ã‚‰ç¸®ç´„ï¼‰<br>
            ç­‰ä¾¡å‰›æ€§ï¼š\\( K_e = Q_A / \\Delta \\)<br>
            ç­‰ä¾¡å‘¨æœŸï¼š\\( T_e = 2\\pi \\sqrt{M_e / K_e} \\)
        </div>
        
        <!-- 4. å¾©å…ƒåŠ›ç‰¹æ€§ -->
        <div style="border:1px solid #ddd; padding:6px; background:#fafafa; margin-bottom:6px;">
            <strong style="color:#005a9c;">4. å¾©å…ƒåŠ›ç‰¹æ€§ãƒ»å£è¦ç´ ã®åˆæˆ</strong><br>
            å„å£è¦ç´ ã®å¾©å…ƒåŠ›ç‰¹æ€§ï¼ˆQ-Ré–¢ä¿‚ï¼‰ã‚’å¤‰å½¢è§’ã”ã¨ã«åˆæˆï¼š<br>
            \\( Q_{åˆæˆ}(R) = \\sum_i Q_i(R) \\times n_i \\)ã€€ï¼ˆå„å£ã®è€åŠ›Ã—å€ç‡ã®ç·å’Œï¼‰<br>
            åˆæœŸå‰›æ€§ï¼š\\( K_0 = Q(R_{min}) / R_{min} \\)ã€€ï¼ˆæœ€å°å¤‰å½¢è§’ã§ã®å‰²ç·šå‰›æ€§ï¼‰<br>
            å‰²ç·šå‰›æ€§ï¼š\\( K(R) = Q(R) / R \\)
        </div>
        
        <!-- 5. ç­‰ä¾¡ç²˜æ€§æ¸›è¡°å®šæ•° -->
        <div style="border:1px solid #ddd; padding:6px; background:#fafafa; margin-bottom:6px;">
            <strong style="color:#005a9c;">5. ç­‰ä¾¡ç²˜æ€§æ¸›è¡°å®šæ•° heq</strong><br>
            å„å£è¦ç´ ã®heqï¼š\\( h_{eq,i} = 0.2 \\times (1 - \\sqrt{K_i / K_{i0}}) \\)ã€€ï¼ˆå‰›æ€§ä½ä¸‹ç‡ã‹ã‚‰ç®—å®šï¼‰<br>
            ç›´æ¥å…¥åŠ›ãŒã‚ã‚‹å ´åˆã¯ãã®å€¤ã‚’ä½¿ç”¨<br>
            éšå…¨ä½“ã®åˆæˆheqï¼š\\( h_{eq,éš} = \\frac{\\sum (h_{eq,i} \\times Q_i)}{\\sum Q_i} \\)ã€€ï¼ˆè€åŠ›åŠ é‡å¹³å‡ï¼‰<br>
            å±¥æ­´æ¸›è¡°ã«ã‚ˆã‚‹ä»•äº‹é‡ï¼š\\( \\Delta W = 4 \\times h_{eq} \\times Q_A \\times \\Delta \\)<br>
            å¼¾æ€§æ­ªã‚¨ãƒãƒ«ã‚®ãƒ¼ï¼š\\( W_A = \\frac{1}{2} Q_A \\times \\Delta \\)<br>
            <br>
            <u>ã€å‘Šç¤ºæº–æ‹ ã‚¹ãƒšã‚¯ãƒˆãƒ«ä½¿ç”¨æ™‚ã€‘</u><br>
            ç·åˆæ¸›è¡°å®šæ•°ï¼š\\( h = 0.05 + \\frac{\\Delta W}{4\\pi W_A} \\)ã€€ï¼ˆåˆæœŸæ¸›è¡°5% + å±¥æ­´æ¸›è¡°ã€ä¸Šé™25%ï¼‰<br>
            <br>
            <u>ã€å¿œç­”ã‚¹ãƒšã‚¯ãƒˆãƒ«è‡ªç”±å…¥åŠ›æ™‚ã€‘</u><br>
            \\( \\frac{\\Delta W}{4\\pi W_A} < 0.05 \\) ã®å ´åˆï¼š\\( h = 0.05 \\)ï¼ˆä¸‹é™å€¤ï¼‰<br>
            \\( \\frac{\\Delta W}{4\\pi W_A} \\geq 0.05 \\) ã®å ´åˆï¼š\\( h = \\frac{\\Delta W}{4\\pi W_A} \\)ï¼ˆä¸Šé™25%ï¼‰<br>
            <br>
            ãã®å¾Œã€\\( F_h = \\frac{1.5}{1 + 10h} \\) ã§æ¸›è¡°ä½æ¸›ä¿‚æ•°ã‚’è¨ˆç®—
        </div>
        
        <!-- 6. æ¸›è¡°ã«ã‚ˆã‚‹å¿œç­”ä½æ¸›ä¿‚æ•° -->
        <div style="border:1px solid #ddd; padding:6px; background:#fafafa; margin-bottom:6px;">
            <strong style="color:#005a9c;">6. æ¸›è¡°ã«ã‚ˆã‚‹å¿œç­”ä½æ¸›ä¿‚æ•° Fh</strong><br>
            \\( F_h = \\frac{1.5}{1 + 10h} \\)ã€€ï¼ˆhï¼šç·åˆæ¸›è¡°å®šæ•°ï¼‰<br>
            æ¸›è¡°ãŒå¤§ãã„ã»ã©å¿œç­”ãŒä½æ¸›ã•ã‚Œã‚‹
        </div>
    </div>`;
    
    // ç¬¬2ãƒšãƒ¼ã‚¸ç›®ã®å†…å®¹ï¼ˆé …ç›®7-13ï¼‰
    const logicHtml2 = `
    <div style="font-size:7pt; line-height:1.4;">
        <!-- 7. åŠ é€Ÿåº¦å¿œç­”ã‚¹ãƒšã‚¯ãƒˆãƒ« -->
        <div style="border:1px solid #ddd; padding:6px; background:#fafafa; margin-bottom:6px;">
            <strong style="color:#005a9c;">7. åŠ é€Ÿåº¦å¿œç­”ã‚¹ãƒšã‚¯ãƒˆãƒ«</strong><br>
            åœ°ç›¤ç¨®åˆ¥ã«ã‚ˆã‚‹ç‰¹æ€§å‘¨æœŸ \\( T_c \\)ï¼šç¬¬1ç¨®=0.4sã€ç¬¬2ç¨®=0.6sã€ç¬¬3ç¨®=0.8s<br>
            ãƒ»æå‚·é™ç•Œã‚¹ãƒšã‚¯ãƒˆãƒ«ï¼š\\( S_{0d}(T) \\)ã€€ï¼ˆåœ°éœ‡å‹•ãƒ¬ãƒ™ãƒ«Iï¼‰<br>
            ãƒ»å®‰å…¨é™ç•Œã‚¹ãƒšã‚¯ãƒˆãƒ«ï¼š\\( S_{0s}(T) \\)ã€€ï¼ˆåœ°éœ‡å‹•ãƒ¬ãƒ™ãƒ«IIã€æå‚·é™ç•Œã®5å€ï¼‰<br>
            åœ°ç›¤å¢—å¹…ç‡ï¼š\\( G_s \\)ã€€ï¼ˆè¡¨å±¤åœ°ç›¤ã®å¢—å¹…ç‰¹æ€§ï¼‰<br>
            è¨­è¨ˆç”¨åŠ é€Ÿåº¦ï¼š\\( S_A = S_0 \\times G_s \\times F_h \\times Z \\times p \\times q \\)
        </div>
        
        <!-- 8. åœ°åŸŸä¿‚æ•°Z -->
        <div style="border:1px solid #ddd; padding:6px; background:#fafafa; margin-bottom:6px;">
            <strong style="color:#005a9c;">8. åœ°åŸŸä¿‚æ•° Z</strong><br>
            åœ°éœ‡åœ°åŸŸä¿‚æ•°ã€‚åœ°åŸŸã«ã‚ˆã‚‹åœ°éœ‡ã®å¼·ã•ã®é•ã„ã‚’è€ƒæ…®ã€‚<br>
            ãƒ»Z=1.0ï¼šå¤§éƒ¨åˆ†ã®åœ°åŸŸï¼ˆæ±äº¬ã€å¤§é˜ªã€åå¤å±‹ç­‰ï¼‰<br>
            ãƒ»Z=0.9ï¼šåŒ—æµ·é“ã®ä¸€éƒ¨ã€æ²–ç¸„ã®ä¸€éƒ¨ç­‰<br>
            ãƒ»Z=0.8ï¼šåŒ—æµ·é“ã®ä¸€éƒ¨ç­‰ã€Z=0.7ï¼šæ²–ç¸„ã®ä¸€éƒ¨ç­‰<br>
            å»ºç¯‰åŸºæº–æ³•æ–½è¡Œä»¤ç¬¬88æ¡ã«è¦å®š
        </div>
        
        <!-- 9. åœ°ç›¤ç¨®åˆ¥ã¨Gs -->
        <div style="border:1px solid #ddd; padding:6px; background:#fafafa; margin-bottom:6px;">
            <strong style="color:#005a9c;">9. åœ°ç›¤ç¨®åˆ¥ã¨åœ°ç›¤å¢—å¹…ç‡ Gs</strong><br>
            ãƒ»ç¬¬1ç¨®åœ°ç›¤(Tc=0.4s)ï¼šå²©ç›¤ã€ç¡¬è³ªç ‚ç¤«å±¤ã€ç¬¬ä¸‰ç´€å±¤ãªã©è‰¯å¥½ãªåœ°ç›¤<br>
            ãƒ»ç¬¬2ç¨®åœ°ç›¤(Tc=0.6s)ï¼šé€šå¸¸ã®åœ°ç›¤ï¼ˆç¬¬1ç¨®ãƒ»ç¬¬3ç¨®ä»¥å¤–ï¼‰<br>
            ãƒ»ç¬¬3ç¨®åœ°ç›¤(Tc=0.8s)ï¼šè»Ÿå¼±åœ°ç›¤ã€æ²¿å²¸åŸ‹ç«‹åœ°ã€æ¶¼æ²¢ä½åœ°ç­‰<br>
            Gsï¼šåœ°è¡¨é¢ã§ã®å¢—å¹…ç‡ã€‚ç¬¬1ç¨®ã§1.0ã€œ1.5ã€ç¬¬3ç¨®ã§1.5ã€œ2.5ç¨‹åº¦
        </div>
        
        <!-- 10. èª¿æ•´ä¿‚æ•° p, q -->
        <div style="border:1px solid #ddd; padding:6px; background:#fafafa; margin-bottom:6px;">
            <strong style="color:#005a9c;">10. èª¿æ•´ä¿‚æ•° p, qï¼ˆå¹³æˆ12å¹´å»ºå‘Š1457å·ï¼‰</strong><br>
            <strong>pï¼šåœ°éœ‡åœ°åŸŸä¿‚æ•°ç­‰ã«é–¢ã™ã‚‹èª¿æ•´ä¿‚æ•°</strong><br>
            ãƒ»T â‰¦ Tc ã®ã¨ãï¼šp = 1.0<br>
            ãƒ»T > Tc ã®ã¨ãï¼šp = Tc / Tï¼ˆé•·å‘¨æœŸå´ã§ä½æ¸›ï¼‰<br>
            <strong>qï¼šæ§‹é€ ç‰¹æ€§ç­‰ã«é–¢ã™ã‚‹èª¿æ•´ä¿‚æ•°</strong><br>
            ãƒ»T â‰¦ Tc ã®ã¨ãï¼šq = T / Tcï¼ˆçŸ­å‘¨æœŸå´ã§ä½æ¸›ï¼‰<br>
            ãƒ»T > Tc ã®ã¨ãï¼šq = 1.0<br>
            ã“ã‚Œã‚‰ã«ã‚ˆã‚ŠçŸ­å‘¨æœŸãƒ»é•·å‘¨æœŸã®å»ºç‰©ã§å¿œç­”ã‚’é©åˆ‡ã«è©•ä¾¡
        </div>
        
        <!-- 11. å¤‰ä½å¿œç­”ã‚¹ãƒšã‚¯ãƒˆãƒ« -->
        <div style="border:1px solid #ddd; padding:6px; background:#fafafa; margin-bottom:6px;">
            <strong style="color:#005a9c;">11. å¤‰ä½å¿œç­”ã‚¹ãƒšã‚¯ãƒˆãƒ«</strong><br>
            \\( S_D = S_A \\times \\left( \\frac{T_e}{2\\pi} \\right)^2 \\)ã€€ï¼ˆåŠ é€Ÿåº¦ã‹ã‚‰å¤‰ä½ã¸å¤‰æ›ï¼‰<br>
            ã“ã‚ŒãŒç­‰ä¾¡1è‡ªç”±åº¦ç³»ã®å¿œç­”å¤‰ä½ã¨ãªã‚‹
        </div>
        
        <!-- 12. å¿…è¦è€åŠ›ãƒ»åˆ¤å®š -->
        <div style="border:1px solid #ddd; padding:6px; background:#fafafa; margin-bottom:6px;">
            <strong style="color:#005a9c;">12. å¿…è¦è€åŠ›ã¨åˆ¤å®š</strong><br>
            å¿…è¦è€åŠ›ï¼š\\( Q_{req} = M_e \\times S_A \\)<br>
            ä¿æœ‰è€åŠ›ï¼š\\( Q_{si} \\)ã€€ï¼ˆå¾©å…ƒåŠ›ç‰¹æ€§ã‹ã‚‰æ±‚ã‚ãŸè€åŠ›ï¼‰<br>
            è©•ç‚¹ï¼š\\( I_s = Q_{si} / Q_{req} \\)<br>
            <br>
            <strong>åˆ¤å®šåŸºæº–ï¼ˆå®‰å…¨é™ç•Œï¼‰ï¼š</strong><br>
            ãƒ»1.5ä»¥ä¸Šï¼šå€’å£Šã—ãªã„<br>
            ãƒ»1.0ã€œ1.5ï¼šä¸€å¿œå€’å£Šã—ãªã„<br>
            ãƒ»0.7ã€œ1.0ï¼šå€’å£Šã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹<br>
            ãƒ»0.7æœªæº€ï¼šå€’å£Šã™ã‚‹å¯èƒ½æ€§ãŒé«˜ã„
        </div>
        
        <!-- 13. åæŸè¨ˆç®— -->
        <div style="border:1px solid #ddd; padding:6px; background:#fafafa;">
            <strong style="color:#005a9c;">13. åæŸè¨ˆç®—ã«ã‚ˆã‚‹äº¤ç‚¹æ¢ç´¢</strong><br>
            å±¤é–“å¤‰å½¢è§’Rã‚’å¤‰åŒ–ã•ã›ãªãŒã‚‰ã€å¾©å…ƒåŠ›ç‰¹æ€§æ›²ç·šã¨å¿…è¦è€åŠ›æ›²ç·šã®äº¤ç‚¹ã‚’æ¢ç´¢<br>
            äº¤ç‚¹ãŒè¦‹ã¤ã‹ã£ãŸå¤‰å½¢è§’ãŒã€æå‚·é™ç•Œãƒ»å®‰å…¨é™ç•Œãã‚Œãã‚Œã®å¿œç­”å¤‰å½¢è§’ã¨ãªã‚‹<br>
            ã“ã®å¿œç­”å¤‰å½¢è§’ã«ãŠã‘ã‚‹å±¤é–“å¤‰å½¢è§’ãŒé™ç•Œå€¤ã‚’è¶…ãˆãªã„ã“ã¨ã‚’ç¢ºèª
        </div>
    </div>`;
    
    document.getElementById('report-logic-1').innerHTML = logicHtml1;
    document.getElementById('report-logic-2').innerHTML = logicHtml2;
}

// --- åœ°éœ‡æ³¢ã‹ã‚‰ã®å¿œç­”ã‚¹ãƒšã‚¯ãƒˆãƒ«è¨ˆç®—æ©Ÿèƒ½ ---

let hotWave = null;
let currentWaveType = 'd'; // 'd' or 's'

function openWaveModal(type) {
    currentWaveType = type;
    document.getElementById('wave-modal').style.display = 'flex';
    document.getElementById('wave-modal-type').innerText = (type === 'd') ? 'ï¼ˆæå‚·é™ç•Œç”¨ï¼‰' : 'ï¼ˆå®‰å…¨é™ç•Œç”¨ï¼‰';
    
    // ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–ï¼ˆç©ºã®1000è¡Œï¼‰
    let data = [];
    for(let i=0; i<1000; i++) data.push([null, null]);
    
    if(hotWave) hotWave.destroy();
    
    // ã‚³ãƒ³ãƒ†ãƒŠãŒè¡¨ç¤ºã•ã‚Œã¦ã‹ã‚‰Handsontableã‚’åˆæœŸåŒ–ã™ã‚‹ãŸã‚ã«å¾®å°é…å»¶ã‚’å…¥ã‚Œã‚‹
    setTimeout(() => {
        const container = document.getElementById('wave-spreadsheet-container');
        hotWave = new Handsontable(container, {
            data: data,
            colHeaders: ['æ™‚é–“ t(s)', 'åŠ é€Ÿåº¦ acc(gal)'],
            columns: [{ type: 'numeric' }, { type: 'numeric' }],
            rowHeaders: true,
            contextMenu: true,
            width: '100%',
            height: '100%',
            licenseKey: 'non-commercial-and-evaluation',
            placeholder: 'Excelã‹ã‚‰è²¼ä»˜'
        });
    }, 100);
}

function closeWaveModal() {
    document.getElementById('wave-modal').style.display = 'none';
}

function executeWaveCalc() {
    if(!hotWave) return;
    
    const raw = hotWave.getData();
    let waveData = []; // {t: time, a: acc(m/s^2)}
    
    // ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã¨å˜ä½å¤‰æ› (gal -> m/s^2)
    let lastT = -1;
    let valid = true;
    
    for(let i=0; i<raw.length; i++) {
        const t = parseFloat(raw[i][0]);
        const gal = parseFloat(raw[i][1]);
        
        // ç©ºè¡Œã«ãªã£ãŸã‚‰çµ‚äº†
        if (raw[i][0] === null && raw[i][1] === null) break;
        
        if(!isNaN(t) && !isNaN(gal)) {
            // å˜ä½å¤‰æ›: 1 gal = 0.01 m/s^2
            waveData.push({ t: t, a: gal * 0.01 }); 
            if(lastT >= 0 && t <= lastT) {
                alert(`æ™‚é–“ã®ä¸¦ã³ãŒä¸æ­£ã§ã™ï¼ˆè¡Œ ${i+1}ï¼‰ã€‚æ™‚é–“ã¯æ˜‡é †ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚`);
                valid = false;
                break;
            }
            lastT = t;
        }
    }
    
    if(!valid || waveData.length < 10) {
        if(valid) alert('ãƒ‡ãƒ¼ã‚¿ãŒå°‘ãªã™ãã¾ã™ã€‚æœ‰åŠ¹ãªæ³¢å½¢ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
    }

    // è¨ˆç®—å®Ÿè¡Œ
    document.getElementById('wave-calc-status').style.display = 'block';
    
    // UIãƒ–ãƒ­ãƒƒã‚¯ã‚’é˜²ããŸã‚ã«setTimeoutã‚’ä½¿ç”¨
    setTimeout(() => {
        const spectrum = calcResponseSpectrum(waveData);
        
        // çµæœã®åæ˜ 
        if(currentWaveType === 'd') {
            saDataD = spectrum;
            renderSaDataList('d');
        } else {
            saDataS = spectrum;
            renderSaDataList('s');
        }
        updateSa0Chart();
        
        document.getElementById('wave-calc-status').style.display = 'none';
        closeWaveModal();
        alert('è¨ˆç®—ãŒå®Œäº†ã—ã€Saã‚¹ãƒšã‚¯ãƒˆãƒ«ã«åæ˜ ã—ã¾ã—ãŸã€‚');
    }, 50);
}

/**
 * ç·šå½¢åŠ é€Ÿåº¦æ³•ï¼ˆãƒ‹ãƒ¥ãƒ¼ãƒãƒ¼ã‚¯Î²æ³• Î²=1/4ï¼‰ã«ã‚ˆã‚‹å¿œç­”ã‚¹ãƒšã‚¯ãƒˆãƒ«è¨ˆç®—
 * h = 0.05 å›ºå®š
 * T = 0.02s ï½ 3.0s (0.02såˆ»ã¿)
 */
function calcResponseSpectrum(wave) {
    const h = 0.05;
    const beta = 0.25;
    const gamma = 0.5;
    
    // æ³¢å½¢ã®æ™‚é–“åˆ»ã¿ dt ã‚’æ¨å®š (å¹³å‡)
    let sumDt = 0;
    for(let i=1; i<wave.length; i++) {
        sumDt += (wave[i].t - wave[i-1].t);
    }
    const dt = sumDt / (wave.length - 1);
    
    const spectra = [];
    
    // è¨ˆç®—ã™ã‚‹å‘¨æœŸã®ãƒ«ãƒ¼ãƒ—
    for(let T = 0.02; T <= 3.01; T += 0.02) { // 3.0sã¾ã§
        // å›ºæœ‰å††æŒ¯å‹•æ•°
        const omega = 2 * Math.PI / T;
        
        // ãƒ‹ãƒ¥ãƒ¼ãƒãƒ¼ã‚¯Î²æ³•ã®ä¿‚æ•°
        // M=1ã¨ã™ã‚‹ (å˜ä½è³ªé‡ã‚ãŸã‚Š)
        // C = 2hÏ‰M = 2hÏ‰
        // K = Ï‰^2 M = Ï‰^2
        
        const M = 1.0;
        const C = 2 * h * omega;
        const K = Math.pow(omega, 2);
        
        const a0 = 1 / (beta * dt * dt);
        const a1 = gamma / (beta * dt);
        const a2 = 1 / (beta * dt);
        const a3 = 1 / (2 * beta) - 1;
        const a4 = gamma / beta - 1;
        const a5 = dt * (gamma / (2 * beta) - 1); // ã“ã“ã§ã¯ä½¿ã‚ãªã„ãŒå®šç¾©ä¸Šå­˜åœ¨
        
        // æœ‰åŠ¹å‰›æ€§
        const K_hat = K + a0 * M + a1 * C;
        
        let x = 0;      // å¤‰ä½
        let v = 0;      // é€Ÿåº¦
        let a = 0;      // åŠ é€Ÿåº¦ (ç›¸å¯¾)
        let maxAbsAcc = 0; // æœ€å¤§çµ¶å¯¾åŠ é€Ÿåº¦
        
        // æ™‚åˆ»æ­´å¿œç­”è¨ˆç®—
        // åˆæœŸåŠ é€Ÿåº¦ (é™æ­¢çŠ¶æ…‹ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆã¨ã™ã‚‹: wave[0].aãŒä½œç”¨ã—ãŸç¬é–“ã®å¿œç­”)
        // a = (p - c*v - k*x) / m => a = - wave[0].a (åœ°å‹•åŠ é€Ÿåº¦)
        // ä»Šå›ã¯å…¨ã¦0ã‚¹ã‚¿ãƒ¼ãƒˆã¨ã—ã€1ã‚¹ãƒ†ãƒƒãƒ—ç›®ã‹ã‚‰å…¥åŠ›ãŒå…¥ã‚‹ã‚‚ã®ã¨ã™ã‚‹
        
        for(let i = 0; i < wave.length - 1; i++) {
            const acc_g_next = wave[i+1].a; // æ¬¡ã‚¹ãƒ†ãƒƒãƒ—ã®åœ°å‹•åŠ é€Ÿåº¦
            
            // æœ‰åŠ¹è·é‡ dF_hat ã§ã¯ãªãã€å…¨é‡å½¢å¼ã§è¨ˆç®—
            // P_hat_next = -M * acc_g_next + M*(a0*x + a2*v + a3*a) + C*(a1*x + a4*v + a5*a)
            // â€» Newmarkã®æ¨™æº–çš„ãªå®Ÿè£…
            
            const P = -1.0 * M * acc_g_next; // å¤–åŠ›é … (-m * z_ddot)
            
            const load_terms = M * (a0 * x + a2 * v + a3 * a) + C * (a1 * x + a4 * v + a5 * a); // a5é …ã¯å¾®å°é …ã ãŒé€šå¸¸ãƒ‹ãƒ¥ãƒ¼ãƒãƒ¼ã‚¯æ³•ã®å®Ÿè£…ã«ã‚ˆã‚‹
            // æ­£ç¢ºã«ã¯:
            // v_pred = v + (1-gamma)*dt*a
            // x_next ã‚’æ±‚ã‚ã‚‹å½¢ã«ã™ã‚‹
            
            const P_hat = P + load_terms;
            
            const x_next = P_hat / K_hat;
            const v_next = a1 * (x_next - x) - a4 * v - a5 * a; // a5ã®é …å®šç¾©æ³¨æ„ã€‚é€šå¸¸ã¯ v_next = (gamma/beta/dt)*(x_next-x) + (1-gamma/beta)*v + dt*(1-gamma/2beta)*a
            
            // ã‚·ãƒ³ãƒ—ãƒ«ãªè¨˜è¿°:
            // a_next = a0 * (x_next - x) - a2 * v - a3 * a;
            const a_next = a0 * (x_next - x) - a2 * v - a3 * a;
            const v_next_simple = v + dt * ((1 - gamma) * a + gamma * a_next);
            
            // çµ¶å¯¾åŠ é€Ÿåº¦ = ç›¸å¯¾åŠ é€Ÿåº¦ + åœ°å‹•åŠ é€Ÿåº¦
            const abs_acc = a_next + acc_g_next;
            if(Math.abs(abs_acc) > maxAbsAcc) maxAbsAcc = Math.abs(abs_acc);
            
            x = x_next;
            v = v_next_simple;
            a = a_next;
        }
        
        spectra.push({ t: parseFloat(T.toFixed(3)), sa: maxAbsAcc });
    }
    
    return spectra;
}

// --- è¿½åŠ æ©Ÿèƒ½: åœ°éœ‡å±¤ã›ã‚“æ–­åŠ›æ¯”è¼ƒãƒ­ã‚¸ãƒƒã‚¯ ---

// å…¥åŠ›ã‚¨ãƒªã‚¢ã®è¡¨ç¤ºåˆ‡æ›¿
// å…¥åŠ›ã‚¨ãƒªã‚¢ã®è¡¨ç¤ºåˆ‡æ›¿ã¨è¨ˆç®—æ›¸ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®é€£å‹•
function toggleShearInput() {
    const chk = document.getElementById('chk_calc_shear_force').checked;
    
    // å…¥åŠ›ã‚¨ãƒªã‚¢ã®åˆ¶å¾¡
    document.getElementById('shear-input-area').style.display = chk ? 'block' : 'none';
    document.getElementById('tab-link-shear').style.display = chk ? 'block' : 'none';
    
    // è¨ˆç®—æ›¸å‡ºåŠ›ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®åˆ¶å¾¡
    const optSpan = document.getElementById('span-rep-shear');
    const optChk = document.getElementById('chk-rep-shear');
    
    if (chk) {
        optSpan.style.display = 'inline-block';
        optChk.checked = true; // è¡¨ç¤ºã•ã‚ŒãŸã‚‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒã‚§ãƒƒã‚¯
    } else {
        optSpan.style.display = 'none';
        optChk.checked = false; // éè¡¨ç¤ºãªã‚‰ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™
    }

    // è¨ˆç®—å®Ÿè¡Œæ¸ˆã¿ãªã‚‰ã‚¿ãƒ–ã‚’æˆ»ã™ç­‰ã®UX
    if(!chk) {
        // ã‚‚ã—ç¾åœ¨ã€Œå±¤ã›ã‚“æ–­åŠ›ã®æ¯”è¼ƒã€ã‚¿ãƒ–ã‚’é–‹ã„ã¦ã„ãŸã‚‰å…¥åŠ›ã‚¿ãƒ–ã«æˆ»ã™
        if(document.getElementById('tab-shear').classList.contains('active')) {
            switchTab('input');
        }
    }
}

// æ¨™æº–å±¤ã›ã‚“æ–­åŠ›ã®è¨ˆç®—
// æ¨™æº–å±¤ã›ã‚“æ–­åŠ›ã®è¨ˆç®— (ä¿®æ­£ç‰ˆ: Ds, Feså¯¾å¿œ)
function calcStandardShear(b) {
    const H_total = b.H1 + b.H2; // å»ºç‰©å…¨é«˜ (m)
    const k = parseFloat(document.getElementById('inp_T_factor').value) || 0.03;
    const T = k * H_total; // å›ºæœ‰å‘¨æœŸ T = 0.03 * H
    
    // Rt (æŒ¯å‹•ç‰¹æ€§ä¿‚æ•°) ã®è¨ˆç®—
    let Tc = 0.6; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¬¬2ç¨®
    if(b.tcMode === '1') Tc = 0.4;
    else if(b.tcMode === '3') Tc = 0.8;
    
    let Rt = 1.0;
    if(T < Tc) {
        Rt = 1.0;
    } else if(T < 2*Tc) {
        Rt = 1.0 - 0.2 * Math.pow((T/Tc - 1), 2);
    } else {
        Rt = 1.6 * Tc / T;
    }
    
    // Ai (åœ°éœ‡å±¤ã›ã‚“æ–­åŠ›åˆ†å¸ƒä¿‚æ•°) ã®è¨ˆç®—
    const W_total = b.W1 + b.W2;
    const alpha2 = (b.stories === 2) ? b.W2 / W_total : 0;
    
    const calcAi = (alpha) => {
        if(alpha <= 0) return 0;
        return 1 + (1/Math.sqrt(alpha) - alpha) * (2*T) / (1 + 3*T);
    };
    
    const Ai1 = 1.0; 
    const Ai2 = (b.stories === 2) ? calcAi(alpha2) : 0;
    
    // ä¿‚æ•°ã®å–å¾—
    const C0_D = parseFloat(document.getElementById('inp_C0_D').value) || 0.2;
    const C0_S = parseFloat(document.getElementById('inp_C0_S').value) || 1.0;
    const Ds = parseFloat(document.getElementById('inp_Ds').value) || 0.4;
    const Fes = parseFloat(document.getElementById('inp_Fes').value) || 1.0;
    
    const W_sum1 = b.W1 + b.W2;
    const W_sum2 = b.W2;
    
    // æå‚·é™ç•Œ (Damage) - å¾“æ¥é€šã‚Š
    // Ci = Z * Rt * Ai * C0
    const Qi_D_1 = b.Z * Rt * Ai1 * C0_D * W_sum1;
    const Qi_D_2 = (b.stories === 2) ? b.Z * Rt * Ai2 * C0_D * W_sum2 : 0;
    
    // å®‰å…¨é™ç•Œ (Safety) - Ds, Fesã‚’è¿½åŠ 
    // Ci = Ds * Fes * Z * Rt * Ai * C0
    const Qi_S_1 = Ds * Fes * b.Z * Rt * Ai1 * C0_S * W_sum1;
    const Qi_S_2 = (b.stories === 2) ? Ds * Fes * b.Z * Rt * Ai2 * C0_S * W_sum2 : 0;
    
    return {
        T, Tc, Rt, Ai1, Ai2, alpha2,
        C0_D, C0_S, Ds, Fes,
        Qd1: Qi_D_1, Qd2: Qi_D_2,
        Qs1: Qi_S_1, Qs2: Qi_S_2,
        W_total
    };
}

// çµæœè¡¨ç¤ºç”¨HTMLç”Ÿæˆ (ä¿®æ­£ç‰ˆ: å¤§å°é–¢ä¿‚è¨˜å·åˆ—ã®è¿½åŠ )
function renderShearComparison(b, stdShear, resX, resY, ptXd, ptXs, ptYd, ptYs) {
    const f2 = (v) => v.toFixed(2);
    const f3 = (v) => v.toFixed(3);
    const skipY = document.getElementById('chk-skip-y').checked;
    
    // åˆ¤å®šãƒãƒƒã‚¸é–¢æ•°ï¼ˆOK/NGè¡¨ç¤ºç”¨ï¼‰
    const judgeBadge = (limit, req) => {
        if(!limit) return '<span class="badge badge-ng">é™ç•Œæ™‚è€åŠ›å°</span>';
        const ratio = limit / req;
        const cls = ratio >= 1.0 ? 'badge-ng' : 'badge-ok';
        return `<span class="badge ${cls}">${ratio >= 1.0 ? 'é™ç•Œæ™‚è€åŠ›å¤§' : 'é™ç•Œæ™‚è€åŠ›å°'}</span>`;
    };
    
    // å¤§å°æ¯”è¼ƒè¨˜å·é–¢æ•°ï¼ˆåˆ—è¿½åŠ ç”¨ï¼‰
    const compareSym = (limit, req) => {
        if(!limit) return '-';
        // å®‰å…¨ï¼ˆLimit >= Reqï¼‰ãªã‚‰é’è‰²ã§ï¼ã€å±é™ºãªã‚‰èµ¤è‰²ã§ï¼œ
        if(limit >= req) return '<span style="color:#005a9c; font-weight:bold; font-size:1.2em;">ï¼</span>';
        return '<span style="color:#dc3545; font-weight:bold; font-size:1.2em;">ï¼œ</span>';
    };

    let html1 = '';
    let html2 = '';
    
    // 1ãƒšãƒ¼ã‚¸ç›®: æ¯”è¼ƒçµæœã‚µãƒãƒªãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«
    html1 += `<h3>7.1 å±¤ã›ã‚“æ–­åŠ› æ¯”è¼ƒåˆ¤å®šçµæœ</h3>`;
    
    const tableStyle = "width:100%; border-collapse:collapse; font-size:0.9em; border:1px solid #999;";
    const thStyle = "background:#e0e0e0; border:1px solid #666; padding:6px; text-align:center; font-weight:bold;";
    const tdStyle = "border:1px solid #666; padding:5px; text-align:center;";
    const tdLabelStyle = "border:1px solid #666; padding:5px; text-align:center; background:#f9f9f9; font-weight:bold;";

    html1 += `<table style="${tableStyle}">
        <thead>
            <tr>
                <th rowspan="2" style="${thStyle}">æ–¹å‘</th>
                <th rowspan="2" style="${thStyle}">éš</th>
                <th colspan="5" style="${thStyle} border-bottom:2px solid #666;">æå‚·é™ç•Œ (C0=${stdShear.C0_D})</th>
                <th colspan="5" style="${thStyle} border-bottom:2px solid #666;">å®‰å…¨é™ç•Œ (C0=${stdShear.C0_S}, Ds=${stdShear.Ds}, Fes=${stdShear.Fes})</th>
            </tr>
            <tr>
                <th style="${thStyle}">é™ç•Œæ™‚è€åŠ›<br>Qlim (kN)</th>
                <th style="${thStyle} width:40px;">å¤§å°</th> <th style="${thStyle}">å¿…è¦ã›ã‚“æ–­åŠ›<br>Qreq (kN)</th>
                <th style="${thStyle}">è€åŠ›æ¯”<br>Qlim/Qreq</th>
                <th style="${thStyle}">çµæœ</th>

                <th style="${thStyle}">é™ç•Œæ™‚è€åŠ›<br>Qlim (kN)</th>
                <th style="${thStyle} width:40px;">å¤§å°</th> <th style="${thStyle}">å¿…è¦ã›ã‚“æ–­åŠ›<br>Qreq (kN)</th>
                <th style="${thStyle}">è€åŠ›æ¯”<br>Qlim/Qreq</th>
                <th style="${thStyle}">çµæœ</th>
            </tr>
        </thead>
        <tbody>`;
        
    // å€¤ã®å–å¾—
    const QlimXd1 = ptXd ? ptXd.QA : 0;
    const QlimXs1 = ptXs ? ptXs.QA : 0;
    const QlimXd2 = (b.stories===2 && ptXd) ? ptXd.Q2 : 0;
    const QlimXs2 = (b.stories===2 && ptXs) ? ptXs.Q2 : 0;
    
    // --- è¡Œã®ç”Ÿæˆãƒ˜ãƒ«ãƒ‘ãƒ¼ ---
    const renderRow = (dirLabel, floorLabel, qLimD, qReqD, qLimS, qReqS, isFirstRow = false, rowSpan = 1) => {
        let tr = '<tr>';
        if(isFirstRow) {
            tr += `<td rowspan="${rowSpan}" style="${tdLabelStyle}">${dirLabel}</td>`;
        }
        tr += `<td style="${tdLabelStyle}">${floorLabel}</td>`;
        
        // æå‚·é™ç•Œãƒ‡ãƒ¼ã‚¿
        tr += `<td style="${tdStyle}">${f2(qLimD)}</td>`;
        tr += `<td style="${tdStyle}">${compareSym(qLimD, qReqD)}</td>`;
        tr += `<td style="${tdStyle}">${f2(qReqD)}</td>`;
        tr += `<td style="${tdStyle}">${qLimD ? (qLimD/qReqD).toFixed(2) : '-'}</td>`;
        tr += `<td style="${tdStyle}">${judgeBadge(qLimD, qReqD)}</td>`;
        
        // å®‰å…¨é™ç•Œãƒ‡ãƒ¼ã‚¿
        tr += `<td style="${tdStyle}">${f2(qLimS)}</td>`;
        tr += `<td style="${tdStyle}">${compareSym(qLimS, qReqS)}</td>`;
        tr += `<td style="${tdStyle}">${f2(qReqS)}</td>`;
        tr += `<td style="${tdStyle}">${qLimS ? (qLimS/qReqS).toFixed(2) : '-'}</td>`;
        tr += `<td style="${tdStyle}">${judgeBadge(qLimS, qReqS)}</td>`;
        
        tr += '</tr>';
        return tr;
    };

    // Xæ–¹å‘
    if(b.stories === 2) {
        html1 += renderRow('Xæ–¹å‘', '2F', QlimXd2, stdShear.Qd2, QlimXs2, stdShear.Qs2, true, 2);
        html1 += renderRow('Xæ–¹å‘', '1F', QlimXd1, stdShear.Qd1, QlimXs1, stdShear.Qs1);
    } else {
        html1 += renderRow('Xæ–¹å‘', '1F', QlimXd1, stdShear.Qd1, QlimXs1, stdShear.Qs1, true, 1);
    }
    
    // Yæ–¹å‘
    if(!skipY) {
        const QlimYd1 = ptYd ? ptYd.QA : 0;
        const QlimYs1 = ptYs ? ptYs.QA : 0;
        const QlimYd2 = (b.stories===2 && ptYd) ? ptYd.Q2 : 0;
        const QlimYs2 = (b.stories===2 && ptYs) ? ptYs.Q2 : 0;
        
        if(b.stories === 2) {
            html1 += renderRow('Yæ–¹å‘', '2F', QlimYd2, stdShear.Qd2, QlimYs2, stdShear.Qs2, true, 2);
            html1 += renderRow('Yæ–¹å‘', '1F', QlimYd1, stdShear.Qd1, QlimYs1, stdShear.Qs1);
        } else {
            html1 += renderRow('Yæ–¹å‘', '1F', QlimYd1, stdShear.Qd1, QlimYs1, stdShear.Qs1, true, 1);
        }
    }
    
    html1 += `</tbody></table>`;
    
    // 2ãƒšãƒ¼ã‚¸ç›®: è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã¨è©³ç´°
    html2 += `<h3>7.2 å±¤ã›ã‚“æ–­åŠ›ã®è¨ˆç®—éç¨‹è©³ç´°</h3>`;
    html2 += `<div style="padding:15px; border:1px solid #ddd; background:#fff; border-radius:5px;">`;
    
    // è«¸å…ƒ
    html2 += `<h4>7.2-1. æŒ¯å‹•ç‰¹æ€§ä¿‚æ•° \\( R_t \\) ã®ç®—å®š</h4>`;
    html2 += `<p>å»ºç‰©å…¨é«˜ \\( H = ${f2(b.H1+b.H2)} \\, \\text{m} \\)</p>`;
    html2 += `<p>è¨­è¨ˆç”¨ä¸€æ¬¡å›ºæœ‰å‘¨æœŸ \\( T = 0.03 H = 0.03 \\times ${f2(b.H1+b.H2)} = ${f3(stdShear.T)} \\, \\text{s} \\)</p>`;
    html2 += `<p>æŒ¯å‹•ç‰¹æ€§ä¿‚æ•° \\( R_t = ${f3(stdShear.Rt)} \\)</p>`;
    
    // Ai
    html2 += `<h4>7.2-2. åœ°éœ‡å±¤ã›ã‚“æ–­åŠ›åˆ†å¸ƒä¿‚æ•° \\( A_i \\) ã®ç®—å®š</h4>`;
    if(b.stories === 2) {
        html2 += `<p>2F: \\( A_2 = ${f3(stdShear.Ai2)} \\), 1F: \\( A_1 = 1.0 \\)</p>`;
    } else {
        html2 += `<p>1F: \\( A_1 = 1.0 \\)</p>`;
    }
    
    // Qè¨ˆç®—
    html2 += `<h4>7.2-3. å„éšã®å¿…è¦åœ°éœ‡å±¤ã›ã‚“æ–­åŠ› \\( Q_i \\)</h4>`;
    html2 += `<p>æå‚·é™ç•Œ: \\( C_i = Z \\cdot R_t \\cdot A_i \\cdot C_0 \\)<br>`;
    html2 += `å®‰å…¨é™ç•Œ: \\( C_i = D_s \\cdot F_{es} \\cdot Z \\cdot R_t \\cdot A_i \\cdot C_0 \\)</p>`;
    html2 += `<p>å…±é€šä¿‚æ•°: \\( Z = ${b.Z}, \\quad R_t = ${f3(stdShear.Rt)} \\)</p>`;
    html2 += `<p>å®‰å…¨é™ç•Œä¿‚æ•°: \\( D_s = ${f2(stdShear.Ds)}, \\quad F_{es} = ${f2(stdShear.Fes)} \\)</p>`;
    
    const W_sum1 = b.W1 + b.W2;
    const W_sum2 = b.W2;
    
    // è©³ç´°è¨ˆç®—å¼ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    const renderQCalcDamage = (floor, Ai, W, resQ) => {
        return `<p><strong>${floor} (æå‚·):</strong><br>
        \\( C_i = ${b.Z} \\times ${f3(stdShear.Rt)} \\times ${f3(Ai)} \\times ${stdShear.C0_D} = ${f3(b.Z * stdShear.Rt * Ai * stdShear.C0_D)} \\)<br>
        \\( Q_i = C_i \\times ${f2(W)} = \\mathbf{${f2(resQ)} \\, \\text{kN}} \\)</p>`;
    };

    const renderQCalcSafety = (floor, Ai, W, resQ) => {
        return `<p><strong>${floor} (å®‰å…¨):</strong><br>
        \\( C_i = ${f2(stdShear.Ds)} \\times ${f2(stdShear.Fes)} \\times ${b.Z} \\times ${f3(stdShear.Rt)} \\times ${f3(Ai)} \\times ${stdShear.C0_S} = ${f3(stdShear.Ds * stdShear.Fes * b.Z * stdShear.Rt * Ai * stdShear.C0_S)} \\)<br>
        \\( Q_i = C_i \\times ${f2(W)} = \\mathbf{${f2(resQ)} \\, \\text{kN}} \\)</p>`;
    };
    
    html2 += `<div style="display:flex; gap:20px; flex-wrap:wrap;">`;
    
    // æå‚·é™ç•Œ
    html2 += `<div style="flex:1; min-width:300px; background:#f9f9f9; padding:10px; border-radius:4px;"><h5>æå‚·é™ç•Œ (C0=${stdShear.C0_D})</h5>`;
    if(b.stories === 2) html2 += renderQCalcDamage('2éš', stdShear.Ai2, W_sum2, stdShear.Qd2);
    html2 += renderQCalcDamage('1éš', stdShear.Ai1, W_sum1, stdShear.Qd1);
    html2 += `</div>`;
    
    // å®‰å…¨é™ç•Œ
    html2 += `<div style="flex:1; min-width:300px; background:#fff5f5; padding:10px; border-radius:4px;"><h5>å®‰å…¨é™ç•Œ (C0=${stdShear.C0_S})</h5>`;
    if(b.stories === 2) html2 += renderQCalcSafety('2éš', stdShear.Ai2, W_sum2, stdShear.Qs2);
    html2 += renderQCalcSafety('1éš', stdShear.Ai1, W_sum1, stdShear.Qs1);
    html2 += `</div>`;
    
    html2 += `</div>`;
    html2 += `</div>`; // End logic
    
    return { html1, html2 };
}

function updateShearTab(b, resX, resY, ptXd, ptXs, ptYd, ptYs) {
    if(!document.getElementById('chk_calc_shear_force').checked) return;
    
    const stdShear = calcStandardShear(b);
    const { html1, html2 } = renderShearComparison(b, stdShear, resX, resY, ptXd, ptXs, ptYd, ptYs);
    
    // ç”»é¢è¡¨ç¤ºç”¨(çµ±åˆè¡¨ç¤º)
    const container = document.getElementById('shear-result-container');
    container.innerHTML = html1 + html2;
    if(window.MathJax) MathJax.Hub.Queue(["Typeset", MathJax.Hub, container]);
    
    // ãƒ¬ãƒãƒ¼ãƒˆç”¨(2ãƒšãƒ¼ã‚¸ã«åˆ†å‰²)
    const repContainer1 = document.getElementById('rep-shear-content1');
    const repContainer2 = document.getElementById('rep-shear-content2');
    if(repContainer1) {
        repContainer1.innerHTML = html1;
        if(window.MathJax) MathJax.Hub.Queue(["Typeset", MathJax.Hub, repContainer1]);
    }
    if(repContainer2) {
        repContainer2.innerHTML = html2;
        if(window.MathJax) MathJax.Hub.Queue(["Typeset", MathJax.Hub, repContainer2]);
    }
}

// ========================================
// CSVä¿å­˜ãƒ»èª­è¾¼æ©Ÿèƒ½
// ========================================

// å…¨å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
function collectAllInputData() {
    return {
        version: "1.0",
        timestamp: new Date().toISOString(),
        
        // è¡¨ç´™ãƒ‡ãƒ¼ã‚¿ (è¿½åŠ )
        cover_checked: document.getElementById('chk-rep-cover').checked,
        cover_date: document.getElementById('inp_cover_date').value,
        cover_company: document.getElementById('inp_cover_company').value,
        cover_office_reg: document.getElementById('inp_cover_office_reg').value,
        cover_arch_reg: document.getElementById('inp_cover_arch_reg').value,
        cover_manager_name: document.getElementById('inp_cover_manager_name').value,
        
        // åŸºæœ¬è¨­å®š
        buildingName: document.getElementById('inp_BuildingName').value,
        stories: document.getElementById('inp_Stories').value,
        Z: document.getElementById('inp_Z').value,
        // å¿œç­”ã‚¹ãƒšã‚¯ãƒˆãƒ«
        saMode: document.getElementById('inp_Sa_mode').value,
        saDataD: saDataD,
        saDataS: saDataS,
        // åœ°ç›¤ç¨®åˆ¥
        tcMode: document.getElementById('inp_Tc_mode').value,
        gsData: gsData,
        // p,qä¿‚æ•°
        pqMode: document.getElementById('inp_pq').value,
        // åœ°éœ‡å±¤ã›ã‚“æ–­åŠ›æ¯”è¼ƒ
        calcShearForce: document.getElementById('chk_calc_shear_force').checked,
        C0_D: document.getElementById('inp_C0_D').value,
        C0_S: document.getElementById('inp_C0_S').value,
        Ds: document.getElementById('inp_Ds').value,
        Fes: document.getElementById('inp_Fes').value,
        T_factor: document.getElementById('inp_T_factor').value,
        // éšãƒ‡ãƒ¼ã‚¿
        W1: document.getElementById('inp_W1').value,
        W2: document.getElementById('inp_W2').value,
        H1: document.getElementById('inp_H1').value,
        H2: document.getElementById('inp_H2').value,
        // åˆ¤å®šåŸºæº–
        limit_d: document.getElementById('inp_limit_d').value,
        limit_s: document.getElementById('inp_limit_s').value,
        // Yæ–¹å‘ã‚¹ã‚­ãƒƒãƒ—
        skipY: document.getElementById('chk-skip-y').checked,
        // è€åŠ›å£ãƒ‡ãƒ¼ã‚¿
        addedWalls: addedWalls,
        // è‡ªç”±å…¥åŠ›ãƒ‡ãƒ¼ã‚¿
        freeInputData: freeInputData
    };
}

// å…¨å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
function restoreAllInputData(data) {
    try {
        // åŸºæœ¬è¨­å®š
        if(data.buildingName !== undefined) document.getElementById('inp_BuildingName').value = data.buildingName;
        if(data.stories !== undefined) {
            document.getElementById('inp_Stories').value = data.stories;
            toggleStories();
        }
        if(data.Z !== undefined) document.getElementById('inp_Z').value = data.Z;
        
        // å¿œç­”ã‚¹ãƒšã‚¯ãƒˆãƒ«
        if(data.saMode !== undefined) {
            document.getElementById('inp_Sa_mode').value = data.saMode;
            toggleSaInput();
        }
        if(data.saDataD !== undefined) saDataD = data.saDataD;
        if(data.saDataS !== undefined) saDataS = data.saDataS;
        renderSaDataList('d');
        renderSaDataList('s');
        updateSa0Chart();
        
        // åœ°ç›¤ç¨®åˆ¥
        if(data.tcMode !== undefined) {
            document.getElementById('inp_Tc_mode').value = data.tcMode;
            toggleTcInput();
        }
        if(data.gsData !== undefined) gsData = data.gsData;
        renderGsDataList();
        updateGsChart();
        
        // p,qä¿‚æ•°
        if(data.pqMode !== undefined) {
            document.getElementById('inp_pq').value = data.pqMode;
            togglePqInput();
        }
        
        // åœ°éœ‡å±¤ã›ã‚“æ–­åŠ›æ¯”è¼ƒ
        if(data.calcShearForce !== undefined) {
            document.getElementById('chk_calc_shear_force').checked = data.calcShearForce;
            toggleShearInput();
        }
        if(data.C0_D !== undefined) document.getElementById('inp_C0_D').value = data.C0_D;
        if(data.C0_S !== undefined) document.getElementById('inp_C0_S').value = data.C0_S;
        if(data.Ds !== undefined) document.getElementById('inp_Ds').value = data.Ds;
        if(data.Fes !== undefined) document.getElementById('inp_Fes').value = data.Fes;
        if(data.T_factor !== undefined) document.getElementById('inp_T_factor').value = data.T_factor;
        
        // éšãƒ‡ãƒ¼ã‚¿
        if(data.W1 !== undefined) document.getElementById('inp_W1').value = data.W1;
        if(data.W2 !== undefined) document.getElementById('inp_W2').value = data.W2;
        if(data.H1 !== undefined) document.getElementById('inp_H1').value = data.H1;
        if(data.H2 !== undefined) document.getElementById('inp_H2').value = data.H2;
        
        // åˆ¤å®šåŸºæº–
        if(data.limit_d !== undefined) document.getElementById('inp_limit_d').value = data.limit_d;
        if(data.limit_s !== undefined) document.getElementById('inp_limit_s').value = data.limit_s;
        
        // Yæ–¹å‘ã‚¹ã‚­ãƒƒãƒ—
        if(data.skipY !== undefined) {
            document.getElementById('chk-skip-y').checked = data.skipY;
            toggleSkipY();
        }
        
        // è€åŠ›å£ãƒ‡ãƒ¼ã‚¿
        if(data.addedWalls !== undefined) {
            addedWalls = data.addedWalls;
            ['x1', 'x2', 'y1', 'y2'].forEach(id => {
                renderWallList(id);
            });
        }
        
        // è‡ªç”±å…¥åŠ›ãƒ‡ãƒ¼ã‚¿
        if(data.freeInputData !== undefined) {
            freeInputData = data.freeInputData;
            ['x1', 'x2', 'y1', 'y2'].forEach(id => {
                renderFreeInputList(id);
                updateInputGraph(id);
            });
        }
        
        // è¡¨ç´™ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒ
        if(data.cover_checked !== undefined) {
            document.getElementById('chk-rep-cover').checked = data.cover_checked;
            toggleCoverInput();
        }
        if(data.cover_date !== undefined) document.getElementById('inp_cover_date').value = data.cover_date;
        if(data.cover_company !== undefined) document.getElementById('inp_cover_company').value = data.cover_company;
        if(data.cover_office_reg !== undefined) document.getElementById('inp_cover_office_reg').value = data.cover_office_reg;
        if(data.cover_arch_reg !== undefined) document.getElementById('inp_cover_arch_reg').value = data.cover_arch_reg;
        if(data.cover_manager_name !== undefined) document.getElementById('inp_cover_manager_name').value = data.cover_manager_name;
        
        // ç‰©ä»¶åã¯æ—¢å­˜ã®restoreå‡¦ç†ã§å¾©å…ƒã•ã‚Œã‚‹ãŸã‚ã€syncã‚’å‘¼ã³å‡ºã—ã¦è¡¨ç´™å´ã«åæ˜ 
        syncProjectName('main');
        
        return true;
    } catch(e) {
        console.error('ãƒ‡ãƒ¼ã‚¿å¾©å…ƒã‚¨ãƒ©ãƒ¼:', e);
        return false;
    }
}

// CSVä¿å­˜
function saveToCSV() {
    const data = collectAllInputData();
    
    // CSVãƒ˜ãƒƒãƒ€ãƒ¼ã¨ãƒ‡ãƒ¼ã‚¿è¡Œã‚’æ§‹ç¯‰
    let csvContent = "";
    
    // ãƒ¡ã‚¿æƒ…å ±è¡Œ
    csvContent += "#é™ç•Œè€åŠ›è¨ˆç®—ãƒ‡ãƒ¼ã‚¿,version," + data.version + ",timestamp," + data.timestamp + "\n";
    
    // åŸºæœ¬è¨­å®š
    csvContent += "#åŸºæœ¬è¨­å®š\n";
    csvContent += "buildingName," + escapeCSV(data.buildingName) + "\n";
    csvContent += "stories," + data.stories + "\n";
    csvContent += "Z," + data.Z + "\n";
    csvContent += "saMode," + data.saMode + "\n";
    csvContent += "tcMode," + data.tcMode + "\n";
    csvContent += "pqMode," + data.pqMode + "\n";
    csvContent += "calcShearForce," + data.calcShearForce + "\n";
    csvContent += "C0_D," + data.C0_D + "\n";
    csvContent += "C0_S," + data.C0_S + "\n";
    csvContent += "Ds," + data.Ds + "\n";
    csvContent += "Fes," + data.Fes + "\n";
    csvContent += "T_factor," + data.T_factor + "\n";
    
    // è¡¨ç´™ãƒ‡ãƒ¼ã‚¿ (è¿½åŠ )
    csvContent += "#è¡¨ç´™ãƒ‡ãƒ¼ã‚¿\n";
    csvContent += "cover_checked," + data.cover_checked + "\n";
    csvContent += "cover_date," + escapeCSV(data.cover_date) + "\n";
    csvContent += "cover_company," + escapeCSV(data.cover_company) + "\n";
    csvContent += "cover_office_reg," + escapeCSV(data.cover_office_reg) + "\n";
    csvContent += "cover_arch_reg," + escapeCSV(data.cover_arch_reg) + "\n";
    csvContent += "cover_manager_name," + escapeCSV(data.cover_manager_name) + "\n";
    
    // éšãƒ‡ãƒ¼ã‚¿
    csvContent += "#éšãƒ‡ãƒ¼ã‚¿\n";
    csvContent += "W1," + data.W1 + "\n";
    csvContent += "W2," + data.W2 + "\n";
    csvContent += "H1," + data.H1 + "\n";
    csvContent += "H2," + data.H2 + "\n";
    
    // åˆ¤å®šåŸºæº–
    csvContent += "#åˆ¤å®šåŸºæº–\n";
    csvContent += "limit_d," + data.limit_d + "\n";
    csvContent += "limit_s," + data.limit_s + "\n";
    csvContent += "skipY," + data.skipY + "\n";
    
    // Saãƒ‡ãƒ¼ã‚¿ï¼ˆæå‚·é™ç•Œï¼‰
    csvContent += "#SaDataD,count," + data.saDataD.length + "\n";
    if(data.saDataD.length > 0) {
        csvContent += "SaDataD_T," + data.saDataD.map(d => d.t).join(",") + "\n";
        csvContent += "SaDataD_Sa," + data.saDataD.map(d => d.sa).join(",") + "\n";
    }
    
    // Saãƒ‡ãƒ¼ã‚¿ï¼ˆå®‰å…¨é™ç•Œï¼‰
    csvContent += "#SaDataS,count," + data.saDataS.length + "\n";
    if(data.saDataS.length > 0) {
        csvContent += "SaDataS_T," + data.saDataS.map(d => d.t).join(",") + "\n";
        csvContent += "SaDataS_Sa," + data.saDataS.map(d => d.sa).join(",") + "\n";
    }
    
    // Gsãƒ‡ãƒ¼ã‚¿
    csvContent += "#GsData,count," + data.gsData.length + "\n";
    if(data.gsData.length > 0) {
        csvContent += "GsData_T," + data.gsData.map(d => d.t).join(",") + "\n";
        csvContent += "GsData_Gs," + data.gsData.map(d => d.g).join(",") + "\n";
    }
    
    // è€åŠ›å£ãƒ‡ãƒ¼ã‚¿
    ['x1', 'x2', 'y1', 'y2'].forEach(id => {
        csvContent += "#Walls_" + id + ",count," + data.addedWalls[id].length + "\n";
        data.addedWalls[id].forEach((w, i) => {
            csvContent += "Wall_" + id + "_" + i + "," + escapeCSV(w.name) + "," + w.qty + "\n";
        });
    });
    
    // è‡ªç”±å…¥åŠ›ãƒ‡ãƒ¼ã‚¿
    ['x1', 'x2', 'y1', 'y2'].forEach(id => {
        csvContent += "#FreeInput_" + id + ",count," + data.freeInputData[id].length + "\n";
        data.freeInputData[id].forEach((item, i) => {
            csvContent += "FreeItem_" + id + "_" + i + "_name," + escapeCSV(item.name) + "\n";
            csvContent += "FreeItem_" + id + "_" + i + "_qty," + item.qty + "\n";
            csvContent += "FreeItem_" + id + "_" + i + "_count," + item.data.length + "\n";
            if(item.data.length > 0) {
                csvContent += "FreeItem_" + id + "_" + i + "_r," + item.data.map(d => d.r).join(",") + "\n";
                csvContent += "FreeItem_" + id + "_" + i + "_q," + item.data.map(d => d.q).join(",") + "\n";
                // heqãŒã‚ã‚‹å ´åˆ
                const hasHeq = item.data.some(d => d.heq !== undefined && d.heq !== null);
                if(hasHeq) {
                    csvContent += "FreeItem_" + id + "_" + i + "_heq," + item.data.map(d => d.heq !== undefined ? d.heq : "").join(",") + "\n";
                }
            }
        });
    });
    
    // BOMä»˜ãUTF-8ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
    const blob = new Blob([bom, csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    
    // ãƒ•ã‚¡ã‚¤ãƒ«åã«ç‰©ä»¶åã¨æ—¥ä»˜ã‚’å«ã‚ã‚‹
    const buildingName = data.buildingName || 'é™ç•Œè€åŠ›è¨ˆç®—';
    const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');
    link.download = buildingName.replace(/[\\/:*?"<>|]/g, '_') + '_' + dateStr + '.csv';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
}

// CSVæ–‡å­—åˆ—ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
function escapeCSV(str) {
    if(str === null || str === undefined) return '';
    str = String(str);
    if(str.includes(',') || str.includes('"') || str.includes('\n')) {
        return '"' + str.replace(/"/g, '""') + '"';
    }
    return str;
}

// CSVãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼
function loadFromCSV(event) {
    const file = event.target.files[0];
    if(!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const content = e.target.result;
            const data = parseCSVToData(content);
            
            if(data) {
                if(restoreAllInputData(data)) {
                    alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚');
                } else {
                    alert('ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                }
            } else {
                alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚');
            }
        } catch(err) {
            console.error('CSVèª­è¾¼ã‚¨ãƒ©ãƒ¼:', err);
            alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n' + err.message);
        }
    };
    reader.readAsText(file, 'UTF-8');
    
    // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆåŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†åº¦é¸æŠå¯èƒ½ã«ã™ã‚‹ï¼‰
    event.target.value = '';
}

// CSVã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
function parseCSVToData(content) {
    const lines = content.split(/\r?\n/);
    const data = {
        saDataD: [],
        saDataS: [],
        gsData: [],
        addedWalls: { x1: [], x2: [], y1: [], y2: [] },
        freeInputData: { x1: [], x2: [], y1: [], y2: [] }
    };
    
    let tempSaD_T = [], tempSaD_Sa = [];
    let tempSaS_T = [], tempSaS_Sa = [];
    let tempGs_T = [], tempGs_Gs = [];
    let freeItemTemp = {};
    
    for(let line of lines) {
        if(!line.trim() || line.startsWith('#')) continue;
        
        const parts = parseCSVLine(line);
        if(parts.length < 2) continue;
        
        const key = parts[0];
        const value = parts[1];
        
        // åŸºæœ¬è¨­å®š
        if(key === 'buildingName') data.buildingName = value;
        else if(key === 'stories') data.stories = value;
        else if(key === 'Z') data.Z = value;
        else if(key === 'saMode') data.saMode = value;
        else if(key === 'tcMode') data.tcMode = value;
        else if(key === 'pqMode') data.pqMode = value;
        else if(key === 'calcShearForce') data.calcShearForce = (value === 'true');
        else if(key === 'C0_D') data.C0_D = value;
        else if(key === 'C0_S') data.C0_S = value;
        else if(key === 'Ds') data.Ds = value;
        else if(key === 'Fes') data.Fes = value;
        else if(key === 'T_factor') data.T_factor = value;
        
        // è¡¨ç´™ãƒ‡ãƒ¼ã‚¿ (è¿½åŠ )
        else if(key === 'cover_checked') data.cover_checked = (value === 'true');
        else if(key === 'cover_date') data.cover_date = value;
        else if(key === 'cover_company') data.cover_company = value;
        else if(key === 'cover_office_reg') data.cover_office_reg = value;
        else if(key === 'cover_arch_reg') data.cover_arch_reg = value;
        else if(key === 'cover_manager_name') data.cover_manager_name = value;
        
        else if(key === 'W1') data.W1 = value;
        else if(key === 'W2') data.W2 = value;
        else if(key === 'H1') data.H1 = value;
        else if(key === 'H2') data.H2 = value;
        else if(key === 'limit_d') data.limit_d = value;
        else if(key === 'limit_s') data.limit_s = value;
        else if(key === 'skipY') data.skipY = (value === 'true');
        
        // Saãƒ‡ãƒ¼ã‚¿
        else if(key === 'SaDataD_T') tempSaD_T = parts.slice(1).map(v => parseFloat(v)).filter(v => !isNaN(v));
        else if(key === 'SaDataD_Sa') tempSaD_Sa = parts.slice(1).map(v => parseFloat(v)).filter(v => !isNaN(v));
        else if(key === 'SaDataS_T') tempSaS_T = parts.slice(1).map(v => parseFloat(v)).filter(v => !isNaN(v));
        else if(key === 'SaDataS_Sa') tempSaS_Sa = parts.slice(1).map(v => parseFloat(v)).filter(v => !isNaN(v));
        
        // Gsãƒ‡ãƒ¼ã‚¿
        else if(key === 'GsData_T') tempGs_T = parts.slice(1).map(v => parseFloat(v)).filter(v => !isNaN(v));
        else if(key === 'GsData_Gs') tempGs_Gs = parts.slice(1).map(v => parseFloat(v)).filter(v => !isNaN(v));
        
        // è€åŠ›å£
        else if(key.startsWith('Wall_')) {
            const match = key.match(/^Wall_(x1|x2|y1|y2)_(\d+)$/);
            if(match) {
                const id = match[1];
                const name = value;
                const qty = parseFloat(parts[2]) || 1;
                data.addedWalls[id].push({ name: name, qty: qty });
            }
        }
        
        // è‡ªç”±å…¥åŠ›
        else if(key.startsWith('FreeItem_')) {
            const match = key.match(/^FreeItem_(x1|x2|y1|y2)_(\d+)_(.+)$/);
            if(match) {
                const id = match[1];
                const idx = match[2];
                const prop = match[3];
                const itemKey = id + '_' + idx;
                
                if(!freeItemTemp[itemKey]) {
                    freeItemTemp[itemKey] = { id: id, idx: parseInt(idx), name: '', qty: 1, data: [], r: [], q: [], heq: [] };
                }
                
                if(prop === 'name') freeItemTemp[itemKey].name = value;
                else if(prop === 'qty') freeItemTemp[itemKey].qty = parseFloat(value) || 1;
                else if(prop === 'r') freeItemTemp[itemKey].r = parts.slice(1).map(v => parseFloat(v)).filter(v => !isNaN(v));
                else if(prop === 'q') freeItemTemp[itemKey].q = parts.slice(1).map(v => parseFloat(v)).filter(v => !isNaN(v));
                else if(prop === 'heq') freeItemTemp[itemKey].heq = parts.slice(1).map(v => v === '' ? null : parseFloat(v));
            }
        }
    }
    
    // Saãƒ‡ãƒ¼ã‚¿ã‚’çµ„ã¿ç«‹ã¦
    for(let i = 0; i < tempSaD_T.length && i < tempSaD_Sa.length; i++) {
        data.saDataD.push({ t: tempSaD_T[i], sa: tempSaD_Sa[i] });
    }
    for(let i = 0; i < tempSaS_T.length && i < tempSaS_Sa.length; i++) {
        data.saDataS.push({ t: tempSaS_T[i], sa: tempSaS_Sa[i] });
    }
    
    // Gsãƒ‡ãƒ¼ã‚¿ã‚’çµ„ã¿ç«‹ã¦
    for(let i = 0; i < tempGs_T.length && i < tempGs_Gs.length; i++) {
        data.gsData.push({ t: tempGs_T[i], g: tempGs_Gs[i] });
    }
    
    // è‡ªç”±å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’çµ„ã¿ç«‹ã¦
    for(let itemKey in freeItemTemp) {
        const item = freeItemTemp[itemKey];
        const itemData = [];
        for(let i = 0; i < item.r.length && i < item.q.length; i++) {
            const point = { r: item.r[i], q: item.q[i] };
            if(item.heq && item.heq[i] !== null && !isNaN(item.heq[i])) {
                point.heq = item.heq[i];
            }
            itemData.push(point);
        }
        data.freeInputData[item.id].push({ name: item.name, qty: item.qty, data: itemData });
    }
    
    return data;
}

// CSVè¡Œã‚’ãƒ‘ãƒ¼ã‚¹ï¼ˆãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã‚’è€ƒæ…®ï¼‰
function parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;
    
    for(let i = 0; i < line.length; i++) {
        const char = line[i];
        const nextChar = line[i + 1];
        
        if(inQuotes) {
            if(char === '"' && nextChar === '"') {
                current += '"';
                i++;
            } else if(char === '"') {
                inQuotes = false;
            } else {
                current += char;
            }
        } else {
            if(char === '"') {
                inQuotes = true;
            } else if(char === ',') {
                result.push(current);
                current = '';
            } else {
                current += char;
            }
        }
    }
    result.push(current);
    
    return result;
}

// è¡¨ç´™å…¥åŠ›ã‚¨ãƒªã‚¢ã®è¡¨ç¤ºåˆ‡æ›¿
function toggleCoverInput() {
    const isChecked = document.getElementById('chk-rep-cover').checked;
    document.getElementById('cover-input-area').style.display = isChecked ? 'block' : 'none';
}

// ç‰©ä»¶åã®åŒæœŸ
function syncProjectName(source) {
    const mainInput = document.getElementById('inp_BuildingName');
    const coverInput = document.getElementById('inp_cover_project_name');
    
    if (source === 'main') {
        coverInput.value = mainInput.value;
    } else {
        mainInput.value = coverInput.value;
    }
}
</script>

<div id="wave-modal" class="modal-overlay">
    <div class="modal-content" style="max-width:700px; height:85%;">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <h3 style="margin:0;">åœ°éœ‡æ³¢ã‹ã‚‰å¿œç­”ã‚¹ãƒšã‚¯ãƒˆãƒ«è¨ˆç®— <span id="wave-modal-type" style="color:#005a9c;"></span></h3>
            <button onclick="closeWaveModal()" style="cursor:pointer; padding:5px 15px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
        
        <div style="display:flex; gap:20px; margin-bottom:10px; background:#f5f5f5; padding:10px; border-radius:4px; font-size:0.9em;">
            <div style="flex:1;">
                <strong>1. è§£ææ¡ä»¶è¨­å®š</strong>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:5px;">
                    <div><label>æ¸›è¡°å®šæ•° h</label> <input type="number" value="0.05" disabled style="width:60px; background:#eee;"> (å›ºå®š)</div>
                    <div><label>è¨ˆç®—å‘¨æœŸç¯„å›²</label> 0.02s ï½ 3.0s</div>
                    <div><label>å‘¨æœŸåˆ»ã¿ dT</label> 0.02s</div>
                </div>
            </div>
            <div style="flex:1;">
                 <strong>2. ãƒ‡ãƒ¼ã‚¿å…¥åŠ›å½¢å¼</strong>
                 <div style="margin-top:5px; color:#666; font-size:0.9em;">
                    ãƒ»1åˆ—ç›®: æ™‚é–“ t (s)<br>
                    ãƒ»2åˆ—ç›®: åŠ é€Ÿåº¦ acc (gal)<br>
                    â€»Excelã‹ã‚‰ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆã—ã¦ãã ã•ã„ã€‚<br>
                    â€»å˜ä½ã¯ <strong>gal (cm/sÂ²)</strong> ã§ã™ã€‚
                 </div>
            </div>
        </div>

        <div style="font-weight:bold; margin-bottom:5px; font-size:0.9em;">â–¼ åŠ é€Ÿåº¦æ™‚åˆ»æ­´ãƒ‡ãƒ¼ã‚¿è²¼ã‚Šä»˜ã‘ã‚¨ãƒªã‚¢</div>
        <div id="wave-spreadsheet-container" style="flex:1; border:1px solid #ccc;"></div>
        
        <div style="text-align:right; margin-top:10px; display:flex; justify-content:flex-end; gap:10px; align-items:center;">
            <span id="wave-calc-status" style="color:#005a9c; font-weight:bold; display:none;">è¨ˆç®—ä¸­...</span>
            <button class="btn-calc" style="font-size:1em; width:auto; margin:0;" onclick="executeWaveCalc()">ã‚¹ãƒšã‚¯ãƒˆãƒ«è¨ˆç®—ï¼†åæ˜ </button>
        </div>
    </div>
</div>

</body>
</html>